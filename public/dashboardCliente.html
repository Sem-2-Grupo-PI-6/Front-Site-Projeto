<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Evolvere Invest - Dashboard Investidor</title>
    <link rel="stylesheet" href="./css/styleCliente.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <main>
      <aside>
        <header>
          <h1>Evolvere Invest</h1>
          <p>Intelig√™ncia Estrat√©gica Imobili√°ria</p>
        </header>
        <section class="session">
          <figure>SC</figure>
          <figcaption>
            <h2 id="nomeUsuario">Sierra Capital</h2>
            <span>Fundo de Investimento</span>
          </figcaption>
        </section>
        <nav aria-label="Primary">
          <h2>Menu Principal</h2>
          <ul>
            <li><a href="#">üìä Dashboard</a></li>
            <li><a href="#" onclick="abrirGerenciarFiltros(); return false;">üó∫Ô∏è Meus Filtros</a></li>
            <li><a href="./configUsuario.html">üìà Configura√ß√µes</a></li>
            <li><button type="button" onclick="logout()">üö™ Sair</button></li>
          </ul>
        </nav>
        <section class="briefing">
          <h2>üí° Insight do Dia</h2>
          <p>Regi√µes com crescimento de PIB acima de 4% e Selic est√°vel apresentam ambiente favor√°vel para novos empreendimentos.</p>
        </section>
      </aside>
      
      <section class="workspace">
        <section class="workspace-header">
          <div>
            <h2>Cen√°rio Macroecon√¥mico - S√£o Paulo</h2>
            <span>Atualizado h√° 2 horas ‚Ä¢ Base: IBGE, Bacen, IPEA ‚Ä¢ Q4 2024</span>
          </div>
          <div class="header-actions">
            <button class="btn-secondary">üìÖ √öltimo Trimestre</button>
            <button class="btn-primary">üì• Exportar An√°lise</button>
          </div>
        </section>

        <section class="kpi-grid" aria-label="Indicadores macroecon√¥micos chave">
          <article class="kpi-card kpi-primary">
            <div class="kpi-icon">üìä</div>
            <div class="kpi-content">
              <div class="kpi-header">
                <span class="kpi-label">PIB Estado de SP</span>
                <span class="kpi-badge">Anual</span>
              </div>
              <div class="kpi-value">+3.8<span class="kpi-unit">%</span></div>
              <div class="kpi-meta">
                <span class="kpi-trend positive">‚Üë 0.6pp vs 2023</span>
                <span class="kpi-description">Crescimento acima da m√©dia nacional</span>
              </div>
            </div>
          </article>

          <article class="kpi-card kpi-success">
            <div class="kpi-icon">üèóÔ∏è</div>
            <div class="kpi-content">
              <div class="kpi-header">
                <span class="kpi-label">Valor Adicionado - Constru√ß√£o</span>
                <span class="kpi-badge">Trimestral</span>
              </div>
              <div class="kpi-value">+5.2<span class="kpi-unit">%</span></div>
              <div class="kpi-meta">
                <span class="kpi-trend positive">‚Üë 1.8pp</span>
                <span class="kpi-description">Setor em expans√£o acelerada</span>
              </div>
            </div>
          </article>

          <article class="kpi-card kpi-warning">
            <div class="kpi-icon">üí∞</div>
            <div class="kpi-content">
              <div class="kpi-header">
                <span class="kpi-label">Taxa Selic</span>
                <span class="kpi-badge">Atual</span>
              </div>
              <div class="kpi-value">11.75<span class="kpi-unit">%</span></div>
              <div class="kpi-meta">
                <span class="kpi-trend neutral">‚Üí Est√°vel</span>
                <span class="kpi-description">Ambiente de cr√©dito moderado</span>
              </div>
            </div>
          </article>

          <article class="kpi-card kpi-info">
            <div class="kpi-icon">üë•</div>
            <div class="kpi-content">
              <div class="kpi-header">
                <span class="kpi-label">Faixa Et√°ria - Predominante</span>
                <span class="kpi-badge">Regi√µes-Alvo</span>
              </div>
              <div class="kpi-value">21~30<span class="kpi-unit">Anos</span></div>
              <div class="kpi-meta">
                <span class="kpi-trend positive">49.30%</span>
                <span class="kpi-description"> SP Capital</span>
              </div>
            </div>
          </article>
        </section>

        <section class="charts-area" aria-label="An√°lises detalhadas">
          <article class="chart-card">
            <header class="chart-header">
              <div>
                <h3>üìà Evolu√ß√£o do PIB Regional</h3>
                <span>Crescimento trimestral por regi√£o (Estado de SP)</span>
              </div>
              <div class="chart-legend">
                <span class="legend-item"><span class="dot primary"></span> Grande SP</span>
                <span class="legend-item"><span class="dot secondary"></span> Interior</span>
                <span class="legend-item"><span class="dot success"></span> Litoral</span>
              </div>
            </header>
            <figure>
              <canvas id="pibRegionalChart" aria-label="Gr√°fico de evolu√ß√£o do PIB por regi√£o"></canvas>
            </figure>
          </article>

          <article class="chart-card">
            <header class="chart-header">
              <div>
                <h3>üè≠ Valor Adicionado por Setor</h3>
                <span>Contribui√ß√£o setorial para o PIB (√∫ltimos 12 meses)</span>
              </div>
              <div class="chart-legend">
                <span class="legend-item"><span class="dot primary"></span> Constru√ß√£o Civil</span>
                <span class="legend-item"><span class="dot warning"></span> Imobiliario</span>
                <span class="legend-item"><span class="dot success"></span> Servi√ßos</span>
              </div>
            </header>
            <figure>
              <canvas id="valorAdicionadoChart" aria-label="Gr√°fico de valor adicionado setorial"></canvas>
            </figure>
          </article>

          <article class="chart-card">
            <header class="chart-header">
              <div>
                <h3>üéØ √çndice de Atratividade</h3>
                <span>Score de investimento por microrregi√£o (0-100)</span>
              </div>
              <div class="chart-legend">
                <span class="legend-item"><span class="dot success"></span> Atrativo</span>
                <span class="legend-item"><span class="dot warning"></span> Moderado</span>
              </div>
            </header>
            <figure>
              <canvas id="atratividadeChart" aria-label="Gr√°fico de √≠ndice de atratividade"></canvas>
            </figure>
          </article>
        </section>
      </section>
    </main>

    <!-- MODAL DE GERENCIAMENTO DE FILTROS -->
    <div class="modal-overlay" id="gerenciarFiltrosModal">
      <div class="modal-mini">
        <div class="modal-header-mini">
          <h2>üóÇÔ∏è Meus Filtros Salvos</h2>
          <button class="btn-close-modal" onclick="fecharGerenciarFiltros()">‚úï</button>
        </div>

        <div class="modal-body-mini">
          <div class="filtros-salvos-list" id="filtrosSalvosList">
            <!-- Filtros ser√£o inseridos aqui via JavaScript -->
          </div>

          <button class="btn-novo-filtro" onclick="criarNovoFiltro()">
            <span>‚ûï</span>
            <span>Criar Novo Filtro</span>
          </button>
        </div>
      </div>
    </div>

    <!-- MODAL DE EDI√á√ÉO DE FILTROS -->
    <div class="modal-overlay" id="editarFiltrosModal">
      <div class="modal-container">
        <div class="modal-header">
          <div>
            <h2 id="modalTitle">üó∫Ô∏è Configurar Filtro</h2>
            <input type="text" id="filtroNome" class="input-filtro-nome" placeholder="Nome do filtro (ex: Zona Leste Foco)" maxlength="30" />
          </div>
          <button class="btn-close-modal" onclick="fecharEditarFiltros()">‚úï</button>
        </div>

        <div class="modal-body">
          <!-- SE√á√ÉO: PERSONALIZAR KPIs -->
          <section class="modal-section">
            <h3 class="section-title">üìä Indicadores (KPIs)</h3>
            <p class="section-description">Escolha quais m√©tricas voc√™ quer acompanhar</p>

            <div class="filter-grid">
              <!-- KPI 1: PIB -->
              <div class="filter-item">
                <label class="filter-label">
                  <input type="checkbox" id="kpi-economico-enable" checked />
                  <span class="checkbox-custom"></span>
                  <strong>Indicador Econ√¥mico</strong>
                </label>
                <select class="filter-select" id="kpi-economico">
                  <option value="pib-sp">PIB Estado de SP</option>
                  <option value="pib-itaquera">PIB - Itaquera</option>
                  <option value="pib-zonasul">PIB - Zona Sul</option>
                  <option value="pib-zonaleste">PIB - Zona Leste</option>
                  <option value="pib-zonaoeste">PIB - Zona Oeste</option>
                  <option value="pib-zonanorte">PIB - Zona Norte</option>
                  <option value="pib-abc">PIB - ABC Paulista</option>
                </select>
              </div>

              <!-- KPI 2: Setor -->
              <div class="filter-item">
                <label class="filter-label">
                  <input type="checkbox" id="kpi-setor-enable" checked />
                  <span class="checkbox-custom"></span>
                  <strong>Setor de Atua√ß√£o</strong>
                </label>
                <select class="filter-select" id="kpi-setor">
                  <option value="construcao">Valor Adicionado - Constru√ß√£o</option>
                  <option value="imobiliario">Valor Adicionado - Imobili√°rio</option>
                  <option value="servicos">Valor Adicionado - Servi√ßos</option>
                </select>
              </div>

              <!-- KPI 3: Taxa -->
              <div class="filter-item">
                <label class="filter-label">
                  <input type="checkbox" id="kpi-financeiro-enable" checked />
                  <span class="checkbox-custom"></span>
                  <strong>Indicador Financeiro</strong>
                </label>
                <select class="filter-select" id="kpi-financeiro">
                  <option value="selic">Taxa Selic</option>
                  <option value="inflacao">Taxa de Infla√ß√£o (IPCA)</option>
                </select>
              </div>

              <!-- KPI 4: Demografia -->
              <div class="filter-item">
                <label class="filter-label">
                  <input type="checkbox" id="kpi-demo-enable" checked />
                  <span class="checkbox-custom"></span>
                  <strong>Dados Demogr√°ficos</strong>
                </label>
                <select class="filter-select" id="kpi-demo">
                  <option value="faixa-etaria">Faixa Et√°ria Predominante</option>
                  <option value="densidade">Densidade Demogr√°fica</option>
                  <option value="renda-media">Renda M√©dia</option>
                </select>
              </div>
            </div>
          </section>

          <!-- SE√á√ÉO: PERSONALIZAR GR√ÅFICOS -->
          <section class="modal-section">
            <h3 class="section-title">üìà Gr√°ficos e An√°lises</h3>
            <p class="section-description">Defina quais regi√µes e dados voc√™ quer comparar</p>

            <div class="graph-config">
              <!-- GR√ÅFICO 1: PIB Regional -->
              <div class="graph-item">
                <div class="graph-header">
                  <label class="filter-label">
                    <input type="checkbox" id="grafico-pib-enable" checked />
                    <span class="checkbox-custom"></span>
                    <strong>Evolu√ß√£o do PIB Regional</strong>
                  </label>
                </div>
                <div class="graph-regions">
                  <p class="graph-description">Selecione at√© 3 regi√µes para comparar:</p>
                  <div class="region-chips">
                    <label class="chip-label">
                      <input type="checkbox" name="pib-region" value="grande-sp" checked />
                      <span class="chip">Grande SP</span>
                    </label>
                    <label class="chip-label">
                      <input type="checkbox" name="pib-region" value="interior" checked />
                      <span class="chip">Interior</span>
                    </label>
                    <label class="chip-label">
                      <input type="checkbox" name="pib-region" value="litoral" checked />
                      <span class="chip">Litoral</span>
                    </label>
                    <label class="chip-label">
                      <input type="checkbox" name="pib-region" value="itaquera" />
                      <span class="chip">Itaquera</span>
                    </label>
                    <label class="chip-label">
                      <input type="checkbox" name="pib-region" value="zona-sul" />
                      <span class="chip">Zona Sul</span>
                    </label>
                    <label class="chip-label">
                      <input type="checkbox" name="pib-region" value="zona-leste" />
                      <span class="chip">Zona Leste</span>
                    </label>
                    <label class="chip-label">
                      <input type="checkbox" name="pib-region" value="zona-oeste" />
                      <span class="chip">Zona Oeste</span>
                    </label>
                    <label class="chip-label">
                      <input type="checkbox" name="pib-region" value="zona-norte" />
                      <span class="chip">Zona Norte</span>
                    </label>
                    <label class="chip-label">
                      <input type="checkbox" name="pib-region" value="abc" />
                      <span class="chip">ABC Paulista</span>
                    </label>
                    <label class="chip-label">
                      <input type="checkbox" name="pib-region" value="campinas" />
                      <span class="chip">Campinas</span>
                    </label>
                  </div>
                </div>
              </div>

              <!-- GR√ÅFICO 2: Valor Adicionado -->
              <div class="graph-item">
                <div class="graph-header">
                  <label class="filter-label">
                    <input type="checkbox" id="grafico-setor-enable" checked />
                    <span class="checkbox-custom"></span>
                    <strong>Valor Adicionado por Setor</strong>
                  </label>
                </div>
                <div class="graph-regions">
                  <p class="graph-description">Selecione os setores para an√°lise:</p>
                  <div class="region-chips">
                    <label class="chip-label">
                      <input type="checkbox" name="setor" value="construcao" checked />
                      <span class="chip">Constru√ß√£o Civil</span>
                    </label>
                    <label class="chip-label">
                      <input type="checkbox" name="setor" value="imobiliario" checked />
                      <span class="chip">Imobili√°rio</span>
                    </label>
                    <label class="chip-label">
                      <input type="checkbox" name="setor" value="servicos" checked />
                      <span class="chip">Servi√ßos</span>
                    </label>
                  </div>
                </div>
              </div>

              <!-- GR√ÅFICO 3: √çndice de Atratividade -->
              <div class="graph-item">
                <div class="graph-header">
                  <label class="filter-label">
                    <input type="checkbox" id="grafico-atratividade-enable" checked />
                    <span class="checkbox-custom"></span>
                    <strong>√çndice de Atratividade</strong>
                  </label>
                </div>
                <div class="graph-regions">
                  <p class="graph-description">Selecione at√© 6 regi√µes para comparar:</p>
                  <div class="region-chips">
                    <label class="chip-label">
                      <input type="checkbox" name="atratividade-region" value="zona-sul" checked />
                      <span class="chip">Zona Sul</span>
                    </label>
                    <label class="chip-label">
                      <input type="checkbox" name="atratividade-region" value="zona-leste" checked />
                      <span class="chip">Zona Leste</span>
                    </label>
                    <label class="chip-label">
                      <input type="checkbox" name="atratividade-region" value="abc" checked />
                      <span class="chip">ABC Paulista</span>
                    </label>
                    <label class="chip-label">
                      <input type="checkbox" name="atratividade-region" value="campinas" checked />
                      <span class="chip">Campinas</span>
                    </label>
                    <label class="chip-label">
                      <input type="checkbox" name="atratividade-region" value="santos" checked />
                      <span class="chip">Santos</span>
                    </label>
                    <label class="chip-label">
                      <input type="checkbox" name="atratividade-region" value="ribeirao" checked />
                      <span class="chip">Ribeir√£o Preto</span>
                    </label>
                    <label class="chip-label">
                      <input type="checkbox" name="atratividade-region" value="itaquera" />
                      <span class="chip">Itaquera</span>
                    </label>
                    <label class="chip-label">
                      <input type="checkbox" name="atratividade-region" value="zona-oeste" />
                      <span class="chip">Zona Oeste</span>
                    </label>
                    <label class="chip-label">
                      <input type="checkbox" name="atratividade-region" value="zona-norte" />
                      <span class="chip">Zona Norte</span>
                    </label>
                    <label class="chip-label">
                      <input type="checkbox" name="atratividade-region" value="centro" />
                      <span class="chip">Centro</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>

        <div class="modal-footer">
          <button class="btn-secondary" onclick="restaurarPadroes()">üîÑ Restaurar Padr√µes</button>
          <div class="modal-footer-actions">
            <button class="btn-cancel" onclick="fecharEditarFiltros()">Cancelar</button>
            <button class="btn-primary" onclick="salvarFiltro()">üíæ Salvar Filtro</button>
          </div>
        </div>
      </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ===== VARI√ÅVEIS GLOBAIS =====
let filtroAtualId = null;
let usuarioLogado = null;
let pibRegionalChartInstance = null;
let valorAdicionadoChartInstance = null;
let atratividadeChartInstance = null;
let zonasDisponiveis = [];

// ===== PALETA DE CORES RENOVADA =====
const paletaCores = {
  primary: ['#00D9FF', '#00B4D8', '#0096C7', '#0077B6', '#023E8A', '#03045E'],
  secondary: ['#FF6B6B', '#EE5A6F', '#C44569', '#973AA8', '#6A2C70', '#462749'],
  success: ['#06FFA5', '#00D9A3', '#00B388', '#008F6E', '#006B54', '#00473A'],
  warm: ['#FFB627', '#FF9F1C', '#FF8811', '#FF6B00', '#E65100', '#BF360C'],
  cool: ['#A78BFA', '#8B5CF6', '#7C3AED', '#6D28D9', '#5B21B6', '#4C1D95'],
  neon: ['#39FF14', '#00FF41', '#00E64D', '#00CC5A', '#00B366', '#009973']
};

// ===== MAPEAMENTO DE VALORES PARA IDS DE ZONAS =====
const zonasMapeamento = {
  'grande-sp': 1,
  'interior': 2,
  'litoral': 3,
  'itaquera': 4,
  'zona-sul': 5,
  'zona-leste': 6,
  'zona-oeste': 7,
  'zona-norte': 8,
  'abc': 9,
  'campinas': 10,
  'santos': 3,
  'ribeirao': 2,
  'centro': 1
};

// ===== MAPEAMENTO DE LABELS =====
const labelsKPIs = {
  'pib-sp': 'PIB Geral',
  'pib-itaquera': 'PIB - Itaquera',
  'pib-zonasul': 'PIB - Zona Sul',
  'pib-zonaleste': 'PIB - Zona Leste',
  'pib-zonaoeste': 'PIB - Zona Oeste',
  'pib-zonanorte': 'PIB - Zona Norte',
  'pib-abc': 'PIB - ABC Paulista',
  'construcao': 'Constru√ß√£o Civil',
  'imobiliario': 'Valor Adicionado - Imobili√°rio',
  'servicos': 'Valor Adicionado - Servi√ßos',
  'selic': 'Taxa Selic',
  'inflacao': 'Taxa de Infla√ß√£o (IPCA)',
  'faixa-etaria': 'Faixa Et√°ria Predominante',
  'densidade': 'Densidade Demogr√°fica',
  'renda-media': 'Renda M√©dia'
};

const labelsRegioes = {
  'grande-sp': 'Grande SP',
  'interior': 'Interior',
  'litoral': 'Litoral',
  'itaquera': 'Itaquera',
  'zona-sul': 'Zona Sul',
  'zona-leste': 'Zona Leste',
  'zona-oeste': 'Zona Oeste',
  'zona-norte': 'Zona Norte',
  'abc': 'ABC Paulista',
  'campinas': 'Campinas',
  'santos': 'Santos',
  'ribeirao': 'Ribeir√£o Preto',
  'centro': 'Centro'
};

const labelsSetores = {
  'construcao': 'Constru√ß√£o Civil',
  'imobiliario': 'Imobili√°rio',
  'servicos': 'Servi√ßos'
};

// ===== INICIALIZA√á√ÉO =====
document.addEventListener('DOMContentLoaded', function() {
  usuarioLogado = JSON.parse(sessionStorage.getItem('USUARIO_LOGADO') || '{}');
  
  if (!usuarioLogado || !usuarioLogado.id) {
    alert('‚ö†Ô∏è Usu√°rio n√£o autenticado! Redirecionando para login...');
    window.location.href = 'login.html';
    return;
  }
  
  if (usuarioLogado.nome) {
    document.getElementById('nomeUsuario').textContent = usuarioLogado.nome;
  }
  
  console.log('üë§ Usu√°rio logado:', usuarioLogado);
  
  inicializarGraficos();
  
  carregarZonasDisponiveis().then(() => {
    aplicarFiltroAtivo();
  });
  
  configurarLimitesRegioes();
  configurarEventosModais();
});

function logout() {
  if (confirm('‚ö†Ô∏è Tem certeza que deseja sair?')) {
    sessionStorage.removeItem('USUARIO_LOGADO');
    window.location.href = 'index.html';
  }
}

// ===== CARREGAR ZONAS DO BANCO =====
async function carregarZonasDisponiveis() {
  try {
    const response = await fetch('http://localhost:3333/dados/zonas');
    
    if (response.ok) {
      zonasDisponiveis = await response.json();
      console.log('üìç Zonas carregadas:', zonasDisponiveis);
    } else {
      console.warn('Zonas n√£o encontradas, usando valores padr√£o');
    }
  } catch (erro) {
    console.error('Erro ao carregar zonas:', erro);
  }
}

// ===== BUSCAR DADOS DO BANCO =====
async function buscarDadosDashboard(idsZonas) {
  try {
    const zonesParam = idsZonas.join(',');
    const response = await fetch(`http://localhost:3333/dados/dashboard?zonas=${zonesParam}`);
    
    if (!response.ok) {
      throw new Error('Erro ao buscar dados da dashboard');
    }
    
    const dados = await response.json();
    console.log('üìä Dados recebidos do banco:', dados);
    return dados;
    
  } catch (erro) {
    console.error('Erro ao buscar dados:', erro);
    return null;
  }
}

async function buscarAtratividade(idsZonas) {
  try {
    const zonesParam = idsZonas.join(',');
    const response = await fetch(`http://localhost:3333/dados/atratividade?zonas=${zonesParam}`);
    
    if (!response.ok) {
      throw new Error('Erro ao buscar atratividade');
    }
    
    const dados = await response.json();
    console.log('üéØ Dados de atratividade:', dados);
    return dados;
    
  } catch (erro) {
    console.error('Erro ao buscar atratividade:', erro);
    return [];
  }
}

async function buscarDemografia(idZona) {
  try {
    const response = await fetch(`http://localhost:3333/dados/demografia/${idZona}`);
    
    if (!response.ok) {
      throw new Error('Erro ao buscar demografia');
    }
    
    const dados = await response.json();
    console.log('üë• Dados demogr√°ficos:', dados);
    return dados;
    
  } catch (erro) {
    console.error('Erro ao buscar demografia:', erro);
    return null;
  }
}

// ===== INICIALIZAR GR√ÅFICOS =====
function inicializarGraficos() {
  const defaultOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: false },
      tooltip: {
        backgroundColor: "rgba(0, 30, 60, 0.95)",
        borderColor: "rgba(0, 217, 255, 0.5)",
        borderWidth: 2,
        titleColor: "#FFFFFF",
        bodyColor: "#00D9FF",
        padding: 14,
        cornerRadius: 10,
        displayColors: true,
        titleFont: {
          size: 13,
          weight: 'bold'
        },
        bodyFont: {
          size: 12,
          weight: '600'
        }
      },
    },
    scales: {
      x: {
        grid: { 
          color: "rgba(0, 217, 255, 0.08)", 
          drawBorder: false 
        },
        ticks: { 
          color: "#00B4D8", 
          font: { size: 11, weight: '600' } 
        },
      },
      y: {
        grid: { 
          color: "rgba(0, 217, 255, 0.08)", 
          drawBorder: false 
        },
        ticks: { 
          color: "#00B4D8", 
          font: { size: 11, weight: '600' } 
        },
      },
    },
  };

  // Gr√°fico PIB Regional
  pibRegionalChartInstance = new Chart(document.getElementById("pibRegionalChart"), {
    type: "line",
    data: {
      labels: [],
      datasets: []
    },
    options: {
      ...defaultOptions,
      scales: {
        ...defaultOptions.scales,
        y: {
          ...defaultOptions.scales.y,
          ticks: {
            ...defaultOptions.scales.y.ticks,
            callback: (value) => `${value}%`,
          },
        },
      },
    },
  });

  // Gr√°fico Valor Adicionado
  valorAdicionadoChartInstance = new Chart(document.getElementById("valorAdicionadoChart"), {
    type: "bar",
    data: {
      labels: [],
      datasets: []
    },
    options: {
      ...defaultOptions,
      scales: {
        ...defaultOptions.scales,
        x: { ...defaultOptions.scales.x, stacked: false },
        y: { 
          ...defaultOptions.scales.y,
          ticks: {
            ...defaultOptions.scales.y.ticks,
            callback: (value) => `${value}%`,
          },
        },
      },
    },
  });

  // Gr√°fico Atratividade
  atratividadeChartInstance = new Chart(document.getElementById("atratividadeChart"), {
    type: "bar",
    data: {
      labels: [],
      datasets: [{
        label: "Score de Atratividade",
        data: [],
        backgroundColor: [],
        borderRadius: 10,
        borderSkipped: false,
      }]
    },
    options: {
      ...defaultOptions,
      indexAxis: 'y',
      scales: {
        x: {
          ...defaultOptions.scales.x,
          max: 100,
          ticks: {
            ...defaultOptions.scales.x.ticks,
            callback: (value) => `${value}`,
          },
        },
        y: {
          ...defaultOptions.scales.y,
          grid: { display: false },
        },
      },
    },
  });
}

// ===== ATUALIZAR DASHBOARD COM FILTRO =====
async function atualizarDashboardComFiltro(config) {
  console.log('üîÑ Atualizando dashboard com:', config);
  
  const idsZonas = config.graficos.pib.regioes.map(regiao => zonasMapeamento[regiao]).filter(id => id);
  
  const dadosBanco = await buscarDadosDashboard(idsZonas.length > 0 ? idsZonas : [1, 2, 3]);
  
  if (dadosBanco) {
    await atualizarKPIs(config, dadosBanco);
    
if (config.graficos.pib.enabled && config.graficos.pib.regioes.length > 0) {
  // Verificar se tem 'grande-sp' selecionado para mostrar PIB Regional SP
  if (config.graficos.pib.regioes.includes('grande-sp') && dadosBanco.pibRegionalSP) {
    await atualizarGraficoPIBRegionalSP(dadosBanco.pibRegionalSP);
  } else {
    await atualizarGraficoPIBComBanco(dadosBanco.pibGrafico);
  }
  document.querySelector('.chart-card:nth-child(1)').style.display = 'flex';
} else {
  document.querySelector('.chart-card:nth-child(1)').style.display = 'none';
}
    
    if (config.graficos.setor.enabled && config.graficos.setor.setores.length > 0) {
      await atualizarGraficoSetoresComBanco(config.graficos.setor.setores, dadosBanco);
      document.querySelector('.chart-card:nth-child(2)').style.display = 'flex';
    } else {
      document.querySelector('.chart-card:nth-child(2)').style.display = 'none';
    }
    
    if (config.graficos.atratividade.enabled && config.graficos.atratividade.regioes.length > 0) {
      await atualizarGraficoAtraividadeComBanco(config.graficos.atratividade.regioes);
      document.querySelector('.chart-card:nth-child(3)').style.display = 'flex';
    } else {
      document.querySelector('.chart-card:nth-child(3)').style.display = 'none';
    }
  }
  
  console.log('‚úÖ Dashboard atualizada com sucesso!');
}

// ===== ATUALIZAR KPIs (COM C√ÅLCULO AUTOM√ÅTICO DE TEND√äNCIA) =====
async function atualizarKPIs(config, dadosBanco) {
  const kpiCards = document.querySelectorAll('.kpi-card');
  
  // KPI 1: PIB - pode ser Geral ou Regional SP
  if (config.kpis.economico.enabled) {
    kpiCards[0].style.display = 'flex';
    kpiCards[0].querySelector('.kpi-label').textContent = labelsKPIs[config.kpis.economico.value];
    
    if (config.kpis.economico.value === 'pib-sp' && dadosBanco.pibRegionalSPAtual && dadosBanco.pibRegionalSP) {
      const valorAtual = parseFloat(dadosBanco.pibRegionalSPAtual.pibSP);
      const anoAtual = parseInt(dadosBanco.pibRegionalSPAtual.ano);
      const sinal = valorAtual >= 0 ? '+' : '';
      
      kpiCards[0].querySelector('.kpi-value').innerHTML = `${sinal}${valorAtual.toFixed(1)}<span class="kpi-unit">%</span>`;
      kpiCards[0].querySelector('.kpi-description').textContent = `Ano ${anoAtual}`;
      
      // Calcular varia√ß√£o em rela√ß√£o ao ano anterior
      const anoAnterior = dadosBanco.pibRegionalSP.find(item => parseInt(item.ano) === anoAtual - 1);
      if (anoAnterior) {
        const valorAnterior = parseFloat(anoAnterior.pibSP);
        const variacao = valorAtual - valorAnterior;
        const variacaoAbs = Math.abs(variacao);
        
        const trend = kpiCards[0].querySelector('.kpi-trend');
        if (variacao > 0) {
          trend.className = 'kpi-trend positive';
          trend.textContent = `‚Üë ${variacaoAbs.toFixed(1)}pp vs ${anoAtual - 1}`;
        } else if (variacao < 0) {
          trend.className = 'kpi-trend negative';
          trend.textContent = `‚Üì ${variacaoAbs.toFixed(1)}pp vs ${anoAtual - 1}`;
        } else {
          trend.className = 'kpi-trend neutral';
          trend.textContent = `‚Üí Igual a ${anoAtual - 1}`;
        }
      }
    } 
    else if (dadosBanco.pibAtual && dadosBanco.pibGrafico) {
      const valorAtual = parseFloat(dadosBanco.pibAtual.pibGeral);
      const sinal = valorAtual >= 0 ? '+' : '';
      
      kpiCards[0].querySelector('.kpi-value').innerHTML = `${sinal}${valorAtual.toFixed(1)}<span class="kpi-unit">%</span>`;
      kpiCards[0].querySelector('.kpi-description').textContent = `${dadosBanco.pibAtual.trimestre} trimestre ${dadosBanco.pibAtual.ano}`;
      
      // Calcular varia√ß√£o em rela√ß√£o ao trimestre anterior
      const dados = [...dadosBanco.pibGrafico].reverse();
      if (dados.length >= 2) {
        const valorAnterior = parseFloat(dados[1].pibGeral);
        const variacao = valorAtual - valorAnterior;
        const variacaoAbs = Math.abs(variacao);
        
        const trend = kpiCards[0].querySelector('.kpi-trend');
        if (variacao > 0) {
          trend.className = 'kpi-trend positive';
          trend.textContent = `‚Üë ${variacaoAbs.toFixed(1)}pp vs trimestre anterior`;
        } else if (variacao < 0) {
          trend.className = 'kpi-trend negative';
          trend.textContent = `‚Üì ${variacaoAbs.toFixed(1)}pp vs trimestre anterior`;
        } else {
          trend.className = 'kpi-trend neutral';
          trend.textContent = `‚Üí Est√°vel`;
        }
      }
    }
  } else {
    kpiCards[0].style.display = 'none';
  }
  
  // KPI 2: Setor (Constru√ß√£o Civil ou Servi√ßos)
  if (config.kpis.setor.enabled) {
    kpiCards[1].style.display = 'flex';
    kpiCards[1].querySelector('.kpi-label').textContent = labelsKPIs[config.kpis.setor.value];
    
    if (config.kpis.setor.value === 'construcao' && dadosBanco.construcaoAtual && dadosBanco.construcaoGrafico) {
      const valorAtual = parseFloat(dadosBanco.construcaoAtual.construcaoCivil);
      const sinal = valorAtual >= 0 ? '+' : '';
      
      kpiCards[1].querySelector('.kpi-value').innerHTML = `${sinal}${valorAtual.toFixed(1)}<span class="kpi-unit">%</span>`;
      kpiCards[1].querySelector('.kpi-description').textContent = `${dadosBanco.construcaoAtual.trimestre} trimestre ${dadosBanco.construcaoAtual.ano}`;
      
      // Calcular varia√ß√£o em rela√ß√£o ao trimestre anterior
      const dados = [...dadosBanco.construcaoGrafico].reverse();
      if (dados.length >= 2) {
        const valorAnterior = parseFloat(dados[1].construcaoCivil);
        const variacao = valorAtual - valorAnterior;
        const variacaoAbs = Math.abs(variacao);
        
        const trend = kpiCards[1].querySelector('.kpi-trend');
        if (variacao > 0.5) {
          trend.className = 'kpi-trend positive';
          trend.textContent = `‚Üë ${variacaoAbs.toFixed(1)}pp em expans√£o`;
        } else if (variacao < -0.5) {
          trend.className = 'kpi-trend negative';
          trend.textContent = `‚Üì ${variacaoAbs.toFixed(1)}pp em retra√ß√£o`;
        } else {
          trend.className = 'kpi-trend neutral';
          trend.textContent = `‚Üí Est√°vel`;
        }
      }
      
    } else if (config.kpis.setor.value === 'servicos' && dadosBanco.servicosAtual && dadosBanco.servicosGrafico) {
      const valorAtual = parseFloat(dadosBanco.servicosAtual.servicos);
      const sinal = valorAtual >= 0 ? '+' : '';
      
      kpiCards[1].querySelector('.kpi-value').innerHTML = `${sinal}${valorAtual.toFixed(1)}<span class="kpi-unit">%</span>`;
      kpiCards[1].querySelector('.kpi-description').textContent = `${dadosBanco.servicosAtual.trimestre} trimestre ${dadosBanco.servicosAtual.ano}`;
      
      // Calcular varia√ß√£o em rela√ß√£o ao trimestre anterior
      const dados = [...dadosBanco.servicosGrafico].reverse();
      if (dados.length >= 2) {
        const valorAnterior = parseFloat(dados[1].servicos);
        const variacao = valorAtual - valorAnterior;
        const variacaoAbs = Math.abs(variacao);
        
        const trend = kpiCards[1].querySelector('.kpi-trend');
        if (variacao > 0.3) {
          trend.className = 'kpi-trend positive';
          trend.textContent = `‚Üë ${variacaoAbs.toFixed(1)}pp crescimento`;
        } else if (variacao < -0.3) {
          trend.className = 'kpi-trend negative';
          trend.textContent = `‚Üì ${variacaoAbs.toFixed(1)}pp queda`;
        } else {
          trend.className = 'kpi-trend neutral';
          trend.textContent = `‚Üí Estabilidade`;
        }
      }
    }
  } else {
    kpiCards[1].style.display = 'none';
  }
  
  // KPI 3: Selic ou Infla√ß√£o
  if (config.kpis.financeiro.enabled) {
    kpiCards[2].style.display = 'flex';
    kpiCards[2].querySelector('.kpi-label').textContent = labelsKPIs[config.kpis.financeiro.value];
    
    if (config.kpis.financeiro.value === 'selic' && dadosBanco.selic) {
      const taxaAtual = parseFloat(dadosBanco.selic.taxaSelic);
      kpiCards[2].querySelector('.kpi-value').innerHTML = `${taxaAtual.toFixed(2)}<span class="kpi-unit">%</span>`;
      
      const data = new Date(dadosBanco.selic.dataApuracao);
      kpiCards[2].querySelector('.kpi-description').textContent = `Atualizado em ${data.toLocaleDateString('pt-BR')}`;
      
      // An√°lise da taxa Selic
      const trend = kpiCards[2].querySelector('.kpi-trend');
      if (taxaAtual >= 13) {
        trend.className = 'kpi-trend negative';
        trend.textContent = '‚Üë Taxa elevada';
      } else if (taxaAtual <= 10) {
        trend.className = 'kpi-trend positive';
        trend.textContent = '‚Üì Taxa favor√°vel';
      } else {
        trend.className = 'kpi-trend neutral';
        trend.textContent = '‚Üí Taxa moderada';
      }
      
    } else if (config.kpis.financeiro.value === 'inflacao' && dadosBanco.inflacao) {
      const taxaAtual = parseFloat(dadosBanco.inflacao.taxaInflacao);
      kpiCards[2].querySelector('.kpi-value').innerHTML = `${taxaAtual.toFixed(2)}<span class="kpi-unit">%</span>`;
      
      const data = new Date(dadosBanco.inflacao.dataApuracao);
      kpiCards[2].querySelector('.kpi-description').textContent = `${data.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}`;
      
      // Meta de infla√ß√£o: 3% com toler√¢ncia de 1,5pp (1,5% a 4,5%)
      const trend = kpiCards[2].querySelector('.kpi-trend');
      if (taxaAtual > 4.5) {
        trend.className = 'kpi-trend negative';
        trend.textContent = `‚Üë ${(taxaAtual - 4.5).toFixed(2)}pp acima da meta`;
      } else if (taxaAtual < 1.5) {
        trend.className = 'kpi-trend negative';
        trend.textContent = `‚Üì ${(1.5 - taxaAtual).toFixed(2)}pp abaixo da meta`;
      } else {
        trend.className = 'kpi-trend positive';
        trend.textContent = '‚úì Dentro da meta';
      }
    }
  } else {
    kpiCards[2].style.display = 'none';
  }
  
  // KPI 4: Demografia
  if (config.kpis.demo.enabled) {
    kpiCards[3].style.display = 'flex';
    kpiCards[3].querySelector('.kpi-label').textContent = labelsKPIs[config.kpis.demo.value];
    
    const primeiraZona = config.graficos.pib.regioes[0];
    const idZona = zonasMapeamento[primeiraZona];
    
    if (idZona) {
      const demografia = await buscarDemografia(idZona);
      
      if (demografia) {
        const trend = kpiCards[3].querySelector('.kpi-trend');
        
        if (config.kpis.demo.value === 'faixa-etaria') {
          const idadeMedia = Math.round(demografia.idadeMedia);
          kpiCards[3].querySelector('.kpi-value').innerHTML = `${idadeMedia}<span class="kpi-unit">Anos</span>`;
          kpiCards[3].querySelector('.kpi-description').textContent = `Idade m√©dia - ${demografia.municipio}`;
          
          // An√°lise da idade
          if (idadeMedia < 30) {
            trend.className = 'kpi-trend positive';
            trend.textContent = '‚úì Popula√ß√£o jovem';
          } else if (idadeMedia > 35) {
            trend.className = 'kpi-trend neutral';
            trend.textContent = '‚Üí Popula√ß√£o madura';
          } else {
            trend.className = 'kpi-trend positive';
            trend.textContent = '‚úì Faixa produtiva';
          }
          
        } else if (config.kpis.demo.value === 'densidade') {
          const densidade = parseFloat(demografia.densidadeDemografico).toFixed(1);
          kpiCards[3].querySelector('.kpi-value').innerHTML = `${densidade}<span class="kpi-unit">k/km¬≤</span>`;
          kpiCards[3].querySelector('.kpi-description').textContent = `${demografia.municipio}`;
          
          // An√°lise da densidade
          if (densidade > 5000) {
            trend.className = 'kpi-trend positive';
            trend.textContent = '‚Üë Alta densidade';
          } else if (densidade > 1000) {
            trend.className = 'kpi-trend positive';
            trend.textContent = '‚úì Densidade elevada';
          } else {
            trend.className = 'kpi-trend neutral';
            trend.textContent = '‚Üí Densidade moderada';
          }
          
        } else if (config.kpis.demo.value === 'renda-media') {
          kpiCards[3].querySelector('.kpi-value').innerHTML = `R$ 4,2<span class="kpi-unit">mil</span>`;
          kpiCards[3].querySelector('.kpi-description').textContent = `Renda mensal m√©dia`;
          
          trend.className = 'kpi-trend positive';
          trend.textContent = '‚úì Renda adequada';
        }
      }
    }
  } else {
    kpiCards[3].style.display = 'none';
  }
}

async function atualizarGraficoPIBComBanco(dadosPib) {
  console.log('üîÑ Atualizando gr√°fico PIB com dados reais:', dadosPib);
  
  // Reverter array para ordem cronol√≥gica (mais antigo para mais recente)
  const dadosOrdenados = [...dadosPib].reverse();
  
  // Criar labels (Q1 2023, Q2 2023, etc.)
  const labels = dadosOrdenados.map(item => `${item.trimestre} ${item.ano}`);
  
  // Criar dataset √∫nico com PIB Geral
  const dataset = {
    label: 'PIB Geral',
    data: dadosOrdenados.map(item => parseFloat(item.pibGeral)),
    borderColor: paletaCores.primary[0],
    backgroundColor: hexToRgba(paletaCores.primary[0], 0.15),
    tension: 0.4,
    fill: true,
    borderWidth: 3,
    pointRadius: 5,
    pointHoverRadius: 7,
    pointBackgroundColor: paletaCores.primary[0],
    pointBorderColor: '#FFFFFF',
    pointBorderWidth: 2,
    pointHoverBorderWidth: 3,
  };
  
  // Atualizar gr√°fico
  pibRegionalChartInstance.data.labels = labels;
  pibRegionalChartInstance.data.datasets = [dataset];
  pibRegionalChartInstance.update();
  
  // Atualizar legenda
  const legendContainer = document.querySelector('.chart-card:nth-child(1) .chart-legend');
  legendContainer.innerHTML = `
    <span class="legend-item">
      <span class="dot" style="background: ${paletaCores.primary[0]}; box-shadow: 0 0 8px ${hexToRgba(paletaCores.primary[0], 0.6)}"></span>
      PIB Geral
    </span>
  `;
  
  console.log('‚úÖ Gr√°fico PIB atualizado com sucesso');
}

// ===== ATUALIZAR GR√ÅFICO SETORES COM DADOS REAIS =====
async function atualizarGraficoSetoresComBanco(setores, dadosBanco) {
  console.log('üîÑ Atualizando gr√°fico de setores:', setores);
  
  const coresSetores = {
    'construcao': paletaCores.success[0],
    'imobiliario': paletaCores.warm[1],
    'servicos': paletaCores.cool[2]
  };
  
  // Pegar √∫ltimos 12 trimestres
  let labels = [];
  const datasets = [];
  
  setores.forEach(setor => {
    let dados = [];
    let dadosOrdenados = [];
    
    if (setor === 'construcao' && dadosBanco.construcaoGrafico) {
      // Dados reais de Constru√ß√£o Civil
      dadosOrdenados = [...dadosBanco.construcaoGrafico].reverse();
      labels = dadosOrdenados.map(item => `${item.trimestre} ${item.ano}`);
      dados = dadosOrdenados.map(item => parseFloat(item.construcaoCivil));
      
    } else if (setor === 'servicos' && dadosBanco.servicosGrafico) {
      // Dados reais de Servi√ßos
      dadosOrdenados = [...dadosBanco.servicosGrafico].reverse();
      if (labels.length === 0) {
        labels = dadosOrdenados.map(item => `${item.trimestre} ${item.ano}`);
      }
      dados = dadosOrdenados.map(item => parseFloat(item.servicos));
      
    } else if (setor === 'imobiliario') {
      // Dados mockados para Imobili√°rio (aguardando dados reais)
      dados = [2.8, 3.0, 3.2, 3.4, 3.3, 3.5, 3.6, 3.4, 3.7, 3.8, 3.9, 4.0];
      if (labels.length === 0) {
        // Criar labels gen√©ricos se ainda n√£o tiver
        labels = ['Q1 2023', 'Q2 2023', 'Q3 2023', 'Q4 2023', 'Q1 2024', 'Q2 2024', 
                  'Q3 2024', 'Q4 2024', 'Q1 2025', 'Q2 2025', 'Q3 2025', 'Q4 2025'];
      }
    }
    
    datasets.push({
      label: labelsSetores[setor],
      data: dados,
      backgroundColor: coresSetores[setor],
      borderRadius: 8,
      borderSkipped: false,
      hoverBackgroundColor: hexToRgba(coresSetores[setor], 0.8),
    });
  });
  
  valorAdicionadoChartInstance.data.labels = labels;
  valorAdicionadoChartInstance.data.datasets = datasets;
  valorAdicionadoChartInstance.update();
  
  // Atualizar legenda
  const legendContainer = document.querySelector('.chart-card:nth-child(2) .chart-legend');
  legendContainer.innerHTML = setores.map(setor => `
    <span class="legend-item">
      <span class="dot" style="background: ${coresSetores[setor]}; box-shadow: 0 0 8px ${hexToRgba(coresSetores[setor], 0.6)}"></span>
      ${labelsSetores[setor]}
    </span>
  `).join('');
  
  console.log('‚úÖ Gr√°fico de setores atualizado com sucesso');
}
// ===== ATUALIZAR GR√ÅFICO ATRATIVIDADE COM DADOS DO BANCO =====
async function atualizarGraficoAtraividadeComBanco(regioes) {
  const idsZonas = regioes.map(regiao => zonasMapeamento[regiao]).filter(id => id);
  const dadosAtratividade = await buscarAtratividade(idsZonas);
  
  let labels = [];
  let data = [];
  let cores = [];
  
  if (dadosAtratividade && dadosAtratividade.length > 0) {
    labels = dadosAtratividade.map(item => item.nome);
    data = dadosAtratividade.map(item => Math.min(100, Math.round(parseFloat(item.score))));
    
    cores = data.map(score => {
      if (score >= 80) return paletaCores.success[0];
      if (score >= 60) return paletaCores.primary[0];
      if (score >= 40) return paletaCores.warm[1];
      return paletaCores.secondary[1];
    });
  } else {
    labels = regioes.map(regiao => labelsRegioes[regiao]);
    data = [82, 75, 88, 79, 71, 76].slice(0, regioes.length);
    cores = regioes.map((_, index) => paletaCores.primary[index % paletaCores.primary.length]);
  }
  
  atratividadeChartInstance.data.labels = labels;
  atratividadeChartInstance.data.datasets[0].data = data;
  atratividadeChartInstance.data.datasets[0].backgroundColor = cores;
  atratividadeChartInstance.update();
}

async function atualizarGraficoPIBRegionalSP(dadosPibSP) {
  console.log('üîÑ Atualizando gr√°fico PIB Regional de S√£o Paulo:', dadosPibSP);
  
  // Criar labels (anos)
  const labels = dadosPibSP.map(item => item.ano);
  
  // Criar dataset com PIB Regional SP
  const dataset = {
    label: 'PIB Estado de S√£o Paulo',
    data: dadosPibSP.map(item => parseFloat(item.pibSP)),
    borderColor: paletaCores.primary[0],
    backgroundColor: hexToRgba(paletaCores.primary[0], 0.15),
    tension: 0.4,
    fill: true,
    borderWidth: 3,
    pointRadius: 5,
    pointHoverRadius: 7,
    pointBackgroundColor: paletaCores.primary[0],
    pointBorderColor: '#FFFFFF',
    pointBorderWidth: 2,
    pointHoverBorderWidth: 3,
  };
  
  // Atualizar gr√°fico
  pibRegionalChartInstance.data.labels = labels;
  pibRegionalChartInstance.data.datasets = [dataset];
  pibRegionalChartInstance.update();
  
  // Atualizar legenda
  const legendContainer = document.querySelector('.chart-card:nth-child(1) .chart-legend');
  legendContainer.innerHTML = `
    <span class="legend-item">
      <span class="dot" style="background: ${paletaCores.primary[0]}; box-shadow: 0 0 8px ${hexToRgba(paletaCores.primary[0], 0.6)}"></span>
      PIB Estado de S√£o Paulo (Anual)
    </span>
  `;
  
  // Atualizar t√≠tulo do gr√°fico
  document.querySelector('.chart-card:nth-child(1) h3').textContent = 'üìà Evolu√ß√£o do PIB Regional - S√£o Paulo';
  document.querySelector('.chart-card:nth-child(1) span').textContent = 'Crescimento anual do Estado de S√£o Paulo';
  
  console.log('‚úÖ Gr√°fico PIB Regional SP atualizado com sucesso');
}

// ===== FUN√á√ÉO AUXILIAR PARA CONVERTER HEX EM RGBA =====
function hexToRgba(hex, alpha = 1) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

// ===== CARREGAR FILTROS DO BANCO =====
async function carregarFiltros() {
  try {
    const response = await fetch(`http://localhost:3333/filtros/listar/${usuarioLogado.id}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });

    if (response.status === 204) {
      return await criarFiltroPadrao();
    }

    if (!response.ok) {
      throw new Error('Erro ao carregar filtros');
    }

    const filtros = await response.json();
    console.log('üìä Filtros carregados:', filtros);
    return filtros;

  } catch (erro) {
    console.error('Erro ao carregar filtros:', erro);
    return carregarFiltrosLocalStorage();
  }
}

async function criarFiltroPadrao() {
  try {
    const configPadrao = getConfigPadrao();
    
    const response = await fetch('http://localhost:3333/filtros/criar', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        idUserServer: usuarioLogado.id,
        nomeServer: 'üìå Filtro Padr√£o',
        configServer: configPadrao
      })
    });

    if (!response.ok) {
      throw new Error('Erro ao criar filtro padr√£o');
    }

    const resultado = await response.json();
    console.log('‚úÖ Filtro padr√£o criado:', resultado);
    
    if (resultado.insertId) {
      await ativarFiltro(resultado.insertId);
    }
    
    return await carregarFiltros();

  } catch (erro) {
    console.error('Erro ao criar filtro padr√£o:', erro);
    return [{
      id: 'default',
      nome: 'üìå Filtro Padr√£o',
      ativo: true,
      config: getConfigPadrao()
    }];
  }
}

async function buscarFiltroAtivo() {
  try {
    const response = await fetch(`http://localhost:3333/filtros/ativo/${usuarioLogado.id}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });

    if (response.status === 204) {
      return null;
    }

    if (!response.ok) {
      throw new Error('Erro ao buscar filtro ativo');
    }

    const filtroAtivo = await response.json();
    console.log('‚úÖ Filtro ativo:', filtroAtivo);
    return filtroAtivo;

  } catch (erro) {
    console.error('Erro ao buscar filtro ativo:', erro);
    return null;
  }
}

async function aplicarFiltroAtivo() {
  const filtroAtivo = await buscarFiltroAtivo();
  
  if (!filtroAtivo) {
    console.log('‚ö†Ô∏è Nenhum filtro ativo, aplicando padr√£o');
    await atualizarDashboardComFiltro(getConfigPadrao());
    return;
  }
  
  console.log('üó∫Ô∏è Aplicando filtro:', filtroAtivo.nome);
  
  let config = filtroAtivo.config;
  if (typeof config === 'string') {
    config = JSON.parse(config);
  }
  
  await atualizarDashboardComFiltro(config);
}

async function abrirGerenciarFiltros() {
  await renderizarFiltrosSalvos();
  document.getElementById('gerenciarFiltrosModal').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function fecharGerenciarFiltros() {
  document.getElementById('gerenciarFiltrosModal').classList.remove('active');
  document.body.style.overflow = '';
}

async function renderizarFiltrosSalvos() {
  const filtros = await carregarFiltros();
  const container = document.getElementById('filtrosSalvosList');
  
  container.innerHTML = filtros.map(filtro => {
    let config = filtro.config;
    if (typeof config === 'string') {
      config = JSON.parse(config);
    }
    
    return `
    <div class="filtro-item ${filtro.ativo ? 'ativo' : ''}">
      <div class="filtro-info">
        <div class="filtro-header">
          <span class="filtro-nome">${filtro.nome}</span>
          ${filtro.ativo ? '<span class="badge-ativo">‚úì Ativo</span>' : ''}
        </div>
        <span class="filtro-detalhes">${getResumoFiltro(config)}</span>
      </div>
      <div class="filtro-actions">
        ${!filtro.ativo ? `<button class="btn-action btn-ativar" onclick="ativarFiltro(${filtro.id})" title="Ativar">‚úì</button>` : ''}
        <button class="btn-action btn-editar" onclick="editarFiltro(${filtro.id})" title="Editar">‚úèÔ∏è</button>
        ${filtro.nome !== 'üìå Filtro Padr√£o' ? `<button class="btn-action btn-deletar" onclick="deletarFiltro(${filtro.id})" title="Excluir">üóëÔ∏è</button>` : ''}
      </div>
    </div>
  `}).join('');
}

function getResumoFiltro(config) {
  const kpisAtivos = Object.values(config.kpis).filter(k => k.enabled).length;
  const graficosAtivos = Object.values(config.graficos).filter(g => g.enabled).length;
  return `${kpisAtivos} KPIs ‚Ä¢ ${graficosAtivos} Gr√°ficos`;
}

function criarNovoFiltro() {
  filtroAtualId = null;
  document.getElementById('filtroNome').value = '';
  document.getElementById('modalTitle').textContent = '‚ûï Criar Novo Filtro';
  carregarConfigNoModal(getConfigPadrao());
  fecharGerenciarFiltros();
  document.getElementById('editarFiltrosModal').classList.add('active');
}

async function editarFiltro(id) {
  const filtros = await carregarFiltros();
  const filtro = filtros.find(f => f.id === id);
  
  if (!filtro) return;
  
  filtroAtualId = id;
  document.getElementById('filtroNome').value = filtro.nome.replace(/[üìå‚úèÔ∏è‚ûï]/g, '').trim();
  document.getElementById('modalTitle').textContent = '‚úèÔ∏è Editar Filtro';
  
  let config = filtro.config;
  if (typeof config === 'string') {
    config = JSON.parse(config);
  }
  
  carregarConfigNoModal(config);
  fecharGerenciarFiltros();
  document.getElementById('editarFiltrosModal').classList.add('active');
}

async function ativarFiltro(id) {
  try {
    const response = await fetch(`http://localhost:3333/filtros/ativar/${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        idUserServer: usuarioLogado.id
      })
    });

    if (!response.ok) {
      throw new Error('Erro ao ativar filtro');
    }

    console.log('‚úÖ Filtro ativado com sucesso!');
    
    await aplicarFiltroAtivo();
    await renderizarFiltrosSalvos();
    
    const filtros = await carregarFiltros();
    const filtro = filtros.find(f => f.id === id);
    
    mostrarToast(`‚úì Filtro "${filtro.nome}" ativado!`);

  } catch (erro) {
    console.error('Erro ao ativar filtro:', erro);
    alert('‚ùå Erro ao ativar filtro. Tente novamente.');
  }
}

async function deletarFiltro(id) {
  const filtros = await carregarFiltros();
  const filtro = filtros.find(f => f.id === id);
  
  if (!filtro) return;
  
  if (!confirm(`‚ö†Ô∏è Tem certeza que deseja excluir o filtro "${filtro.nome}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
    return;
  }

  try {
    const response = await fetch(`http://localhost:3333/filtros/deletar/${id}/${usuarioLogado.id}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      throw new Error('Erro ao deletar filtro');
    }

    console.log('‚úÖ Filtro deletado com sucesso!');
    
    await renderizarFiltrosSalvos();
    await aplicarFiltroAtivo();
    
    mostrarToast('‚úÖ Filtro exclu√≠do com sucesso!');

  } catch (erro) {
    console.error('Erro ao deletar filtro:', erro);
    alert('‚ùå Erro ao deletar filtro. Tente novamente.');
  }
}

async function salvarFiltro() {
  const nome = document.getElementById('filtroNome').value.trim();
  
  if (!nome) {
    alert('‚ö†Ô∏è Por favor, digite um nome para o filtro!');
    document.getElementById('filtroNome').focus();
    return;
  }
  
  const config = getConfigDoModal();

  try {
    if (filtroAtualId) {
      const response = await fetch(`http://localhost:3333/filtros/atualizar/${filtroAtualId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          idUserServer: usuarioLogado.id,
          nomeServer: nome,
          configServer: config
        })
      });

      if (!response.ok) {
        throw new Error('Erro ao atualizar filtro');
      }

      console.log('‚úÖ Filtro atualizado!');
      mostrarToast('‚úÖ Filtro atualizado!');

    } else {
      const response = await fetch('http://localhost:3333/filtros/criar', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          idUserServer: usuarioLogado.id,
          nomeServer: nome,
          configServer: config
        })
      });

      if (!response.ok) {
        throw new Error('Erro ao criar filtro');
      }

      console.log('‚úÖ Filtro criado!');
      mostrarToast('‚úÖ Novo filtro criado!');
    }

    fecharEditarFiltros();
    await abrirGerenciarFiltros();

  } catch (erro) {
    console.error('Erro ao salvar filtro:', erro);
    alert('‚ùå Erro ao salvar filtro. Tente novamente.');
  }
}

function getConfigPadrao() {
  return {
    kpis: {
      economico: { enabled: true, value: 'pib-sp' },
      setor: { enabled: true, value: 'construcao' },
      financeiro: { enabled: true, value: 'selic' },
      demo: { enabled: true, value: 'faixa-etaria' }
    },
    graficos: {
      pib: { enabled: true, regioes: ['grande-sp', 'interior', 'litoral'] },
      setor: { enabled: true, setores: ['construcao', 'imobiliario', 'servicos'] },
      atratividade: { enabled: true, regioes: ['zona-sul', 'zona-leste', 'abc', 'campinas', 'santos', 'ribeirao'] }
    }
  };
}

function fecharEditarFiltros() {
  document.getElementById('editarFiltrosModal').classList.remove('active');
  document.body.style.overflow = '';
  filtroAtualId = null;
}

function carregarConfigNoModal(config) {
  document.getElementById('kpi-economico-enable').checked = config.kpis.economico.enabled;
  document.getElementById('kpi-economico').value = config.kpis.economico.value;
  
  document.getElementById('kpi-setor-enable').checked = config.kpis.setor.enabled;
  document.getElementById('kpi-setor').value = config.kpis.setor.value;
  
  document.getElementById('kpi-financeiro-enable').checked = config.kpis.financeiro.enabled;
  document.getElementById('kpi-financeiro').value = config.kpis.financeiro.value;
  
  document.getElementById('kpi-demo-enable').checked = config.kpis.demo.enabled;
  document.getElementById('kpi-demo').value = config.kpis.demo.value;
  
  document.getElementById('grafico-pib-enable').checked = config.graficos.pib.enabled;
  document.querySelectorAll('input[name="pib-region"]').forEach(cb => {
    cb.checked = config.graficos.pib.regioes.includes(cb.value);
  });
  
  document.getElementById('grafico-setor-enable').checked = config.graficos.setor.enabled;
  document.querySelectorAll('input[name="setor"]').forEach(cb => {
    cb.checked = config.graficos.setor.setores.includes(cb.value);
  });
  
  document.getElementById('grafico-atratividade-enable').checked = config.graficos.atratividade.enabled;
  document.querySelectorAll('input[name="atratividade-region"]').forEach(cb => {
    cb.checked = config.graficos.atratividade.regioes.includes(cb.value);
  });
}

function getConfigDoModal() {
  return {
    kpis: {
      economico: {
        enabled: document.getElementById('kpi-economico-enable').checked,
        value: document.getElementById('kpi-economico').value
      },
      setor: {
        enabled: document.getElementById('kpi-setor-enable').checked,
        value: document.getElementById('kpi-setor').value
      },
      financeiro: {
        enabled: document.getElementById('kpi-financeiro-enable').checked,
        value: document.getElementById('kpi-financeiro').value
      },
      demo: {
        enabled: document.getElementById('kpi-demo-enable').checked,
        value: document.getElementById('kpi-demo').value
      }
    },
    graficos: {
      pib: {
        enabled: document.getElementById('grafico-pib-enable').checked,
        regioes: Array.from(document.querySelectorAll('input[name="pib-region"]:checked')).map(cb => cb.value)
      },
      setor: {
        enabled: document.getElementById('grafico-setor-enable').checked,
        setores: Array.from(document.querySelectorAll('input[name="setor"]:checked')).map(cb => cb.value)
      },
      atratividade: {
        enabled: document.getElementById('grafico-atratividade-enable').checked,
        regioes: Array.from(document.querySelectorAll('input[name="atratividade-region"]:checked')).map(cb => cb.value)
      }
    }
  };
}

function restaurarPadroes() {
  if (confirm('‚ö†Ô∏è Tem certeza que deseja restaurar as configura√ß√µes padr√£o?')) {
    carregarConfigNoModal(getConfigPadrao());
    alert('‚úÖ Configura√ß√µes restauradas!');
  }
}

function mostrarToast(mensagem) {
  const toast = document.createElement('div');
  toast.className = 'toast-notification';
  toast.textContent = mensagem;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

function carregarFiltrosLocalStorage() {
  const filtros = localStorage.getItem('filtrosDashboard');
  if (!filtros) {
    return [{
      id: 'default',
      nome: 'üìå Filtro Padr√£o',
      ativo: true,
      config: getConfigPadrao()
    }];
  }
  return JSON.parse(filtros);
}

function configurarLimitesRegioes() {
  document.querySelectorAll('input[name="pib-region"]').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const checked = document.querySelectorAll('input[name="pib-region"]:checked');
      if (checked.length > 3) {
        this.checked = false;
        alert('‚ö†Ô∏è M√°ximo 3 regi√µes para PIB Regional.');
      }
    });
  });

  document.querySelectorAll('input[name="atratividade-region"]').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const checked = document.querySelectorAll('input[name="atratividade-region"]:checked');
      if (checked.length > 6) {
        this.checked = false;
        alert('‚ö†Ô∏è M√°ximo 6 regi√µes para Atratividade.');
      }
    });
  });
}

function configurarEventosModais() {
  document.getElementById('gerenciarFiltrosModal')?.addEventListener('click', function(e) {
    if (e.target === this) fecharGerenciarFiltros();
  });

  document.getElementById('editarFiltrosModal')?.addEventListener('click', function(e) {
    if (e.target === this) fecharEditarFiltros();
  });

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      if (document.getElementById('editarFiltrosModal')?.classList.contains('active')) {
        fecharEditarFiltros();
      } else if (document.getElementById('gerenciarFiltrosModal')?.classList.contains('active')) {
        fecharGerenciarFiltros();
      }
    }
  });
}
</script>
  </body>
</html>