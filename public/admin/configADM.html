<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Evolvere Invest - Configura√ß√µes Admin</title>
    <link rel="stylesheet" href="../css/configAdmin.css" />
    <link rel="icon" href="../assets/icon/favicon.png" />
    <script src="../js/monitoramento.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Orbitron:wght@400;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <div class="logo">
          <a href="index.html">
            <img src="../imgs/Logo-projeto.png" alt="Evolvere Logo" />
          </a>
          <div class="brand-txt">
            <h1>Evolvere Invest</h1>
            <small>Painel Administrativo</small>
          </div>
        </div>

        <nav>
          <ul class="nav-list">
            <li><a href="dashboardAdmin.html">üìä Dashboard</a></li>
            <li>
            </li>
            <li class="divider">|</li>
            <li><a onclick="logout()" class="btn-link">Sair</a></li>
          </ul>
        </nav>
      </div>
    </header>

    <main class="container main-content">
      <section class="overview-cards">
        <article class="overview-card card-users">
          <div class="overview-icon">üë•</div>
          <div class="overview-content">
            <h3>Usu√°rios Ativos</h3>
            <div class="overview-value">127</div>
            <span class="overview-trend positive">‚Üë 16.5% este m√™s</span>
          </div>
        </article>

        <article class="overview-card card-companies">
          <div class="overview-icon">üè¢</div>
          <div class="overview-content">
            <h3>Empresas Cadastradas</h3>
            <div class="overview-value">92</div>
            <span class="overview-trend positive">‚Üë 8 novas</span>
          </div>
        </article>

        <article class="overview-card card-queries">
          <div class="overview-icon">üìä</div>
          <div class="overview-content">
            <h3>Consultas Hoje</h3>
            <div class="overview-value">342</div>
            <span class="overview-trend neutral">‚Üí M√©dia: 281/dia</span>
          </div>
        </article>
      </section>

      <section class="config-tabs">
        <div class="tabs-header">
          <button class="tab-btn active" data-tab="users">
            <span class="tab-icon">üë•</span>
            <span>Gerenciar Usu√°rios</span>
          </button>
          <button class="tab-btn" data-tab="create">
            <span class="tab-icon">‚ûï</span>
            <span>Criar Administrador</span>
          </button>
          <button class="tab-btn" data-tab="profile">
            <span class="tab-icon">üë§</span>
            <span>Meu Perfil</span>
          </button>
        </div>

        <div class="tab-content active" id="tab-users">
          <div class="card">
            <div class="card-header">
              <div>
                <h2>üë• Gerenciar Usu√°rios</h2>
                <p>Visualize, edite ou remova usu√°rios da plataforma</p>
              </div>
              <div class="card-actions">
                <input
                  type="search"
                  placeholder="üîç Buscar usu√°rio..."
                  class="search-input"
                />
              </div>
            </div>

            <div class="users-table-wrapper">
              <table class="users-table">
                <thead>
                  <tr>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>Tipo</th>
                    <th>Empresa</th>
                    <th>Status</th>
                    <th>Cadastro</th>
                    <th>A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="usuarios-tbody"></tbody>
              </table>
            </div>

            <div class="pagination">
              <button class="btn-pagination">‚Üê Anterior</button>
              <span class="pagination-info">P√°gina 1 de 10 ‚Ä¢ 127 usu√°rios</span>
              <button class="btn-pagination">Pr√≥ximo ‚Üí</button>
            </div>
          </div>
        </div>

         <div id="modal-editar-usuario" class="modal-overlay" style="display: none">
          <div class="modal-container">
            <div class="modal-header">
              <h2>‚úèÔ∏è Editar Empresa</h2>
              <button class="modal-close" onclick="fecharModalEdicao()">‚úñ</button>
            </div>
            <div class="modal-body">
              <form id="form-editar-usuario">
                <input type="hidden" id="edit-id-usuario" />

                <div class="form-group">
                  <label for="edit-nome">Nome Fantasia *</label>
                  <input type="text" id="edit-nome" required />
                </div>

                <div class="form-group">
                  <label for="edit-email">Email Corporativo *</label>
                  <input type="email" id="edit-email" required />
                </div>

                <div class="form-group">
                  <label for="edit-telefone">CNPJ</label>
                  <input
                    type="text"
                    id="edit-telefone"
                    placeholder="00000000000000"
                    maxlength="14"
                    disabled
                  />
                  <small class="form-hint">CNPJ n√£o pode ser alterado</small>
                </div>

                <div class="form-divider">
                  <span>Alterar Senha</span>
                </div>

                <div class="form-group">
                  <label for="edit-senha">Nova Senha</label>
                  <input
                    type="password"
                    id="edit-senha"
                    placeholder="Deixe em branco para n√£o alterar"
                    minlength="8"
                  />
                  <small class="form-hint">M√≠nimo 8 caracteres.  Deixe vazio para manter a senha atual. </small>
                </div>

                <div class="form-group">
                  <label for="edit-confirmar-senha">Confirmar Nova Senha</label>
                  <input
                    type="password"
                    id="edit-confirmar-senha"
                    placeholder="Repita a nova senha"
                    minlength="8"
                  />
                </div>

                <div class="form-actions">
                  <button type="button" class="btn-secondary" onclick="fecharModalEdicao()">
                    Cancelar
                  </button>
                  <button type="submit" class="btn-primary">
                    Salvar Altera√ß√µes
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="tab-content" id="tab-create">
          <div class="card">
            <div class="card-header">
              <div>
                <h2>‚ûï Criar Novo Administrador</h2>
                <p>Adicione administradores √† plataforma</p>
              </div>
            </div>

            <form
              id="formNovoUsuario"
              onsubmit="return cadastrarUsuarioAdmin(event)"
            >
              <div class="form-row">
                <div class="form-group">
                  <label for="create-name">Nome Completo *</label>
                  <input
                    type="text"
                    id="create-name"
                    placeholder="Ex: Jo√£o Silva"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="create-email">Email *</label>
                  <input
                    type="email"
                    id="create-email"
                    placeholder="usuario@exemplo.com"
                    required
                  />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="create-password">Senha *</label>
                  <input
                    type="password"
                    id="create-password"
                    placeholder="M√≠nimo 8 caracteres"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="create-confirm">Confirmar Senha *</label>
                  <input
                    type="password"
                    id="create-confirm"
                    placeholder="Repita a senha"
                    required
                  />
                </div>
              </div>

              <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Aten√ß√£o:</strong> Usu√°rios administradores devem usar
                email com dom√≠nio <strong>@admin.net</strong>.
              </div>

              <div class="form-actions">
                <button type="button" class="btn-secondary">Cancelar</button>
                <button type="submit" class="btn-primary">
                  ‚úì Criar Usu√°rio
                </button>
              </div>
            </form>
          </div>
        </div>

        <div class="tab-content" id="tab-profile">
          <div class="card">
            <div class="card-header">
              <div>
                <h2>üë§ Meu Perfil</h2>
                <p>Gerencie suas informa√ß√µes pessoais</p>
              </div>
            </div>

            <form class="config-form" id="form-editar-usuario-proprio">
              <div class="profile-header">
                <div class="profile-avatar-large" id="profile-avatar"></div>
                <div class="profile-info">
                  <h3 id="profile-header-nome"></h3>
                  <p id="profile-header-email"></p>
                  <span class="badge badge-admin">Administrador Master</span>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="profile-name">Nome Completo</label>
                  <input type="text" id="profile-name" />
                </div>
                <div class="form-group">
                  <label for="profile-email">Email</label>
                  <input type="email" id="profile-email" disabled />
                  <small class="form-hint">Email n√£o pode ser alterado</small>
                </div>
              </div>

              <div class="form-divider">
                <span>Alterar Senha</span>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="profile-current-password">Senha Atual</label>
                  <input
                    type="password"
                    id="profile-current-password"
                    placeholder="Digite sua senha atual"
                  />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="profile-new-password">Nova Senha</label>
                  <input
                    type="password"
                    id="profile-new-password"
                    placeholder="M√≠nimo 8 caracteres"
                  />
                </div>
                <div class="form-group">
                  <label for="profile-confirm-password"
                    >Confirmar Nova Senha</label
                  >
                  <input
                    type="password"
                    id="profile-confirm-password"
                    placeholder="Repita a nova senha"
                  />
                </div>
              </div>

              <div class="form-actions">
                <button type="button" class="btn-secondary">Cancelar</button>
                <button type="submit" class="btn-primary">
                  üì• Salvar Altera√ß√µes
                </button>
              </div>
            </form>
          </div>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="container footer-inner">
        <p>&copy; 2025 Evolvere Invest ‚Äî Painel Administrativo</p>
        <p>Contato: admin@evolvereinvest.net</p>
      </div>
    </footer>
  </body>
</html>

<script>
  document.addEventListener("DOMContentLoaded", function () {
  const tabButtons = document.querySelectorAll(".tab-btn");
  const tabContents = document.querySelectorAll(".tab-content");

  let paginaAtual = 1;
  let totalPaginas = 1;

  tabButtons.forEach((button) => {
    button.addEventListener("click", () => {
      const targetTab = button.getAttribute("data-tab");
      tabButtons.forEach((btn) => btn.classList.remove("active"));
      tabContents.forEach((content) => content.classList.remove("active"));
      button.classList.add("active");
      document.getElementById(`tab-${targetTab}`).classList.add("active");
    });
  });

  carregarEmpresas(1);
  
  function carregarEmpresas(pagina) {
    fetch(`/admin/empresas/listar/paginado? pagina=${pagina}&limite=20`)
      .then((res) => res.json())
      .then((data) => {
        const { empresas, paginacao } = data;
        const tbody = document.getElementById("usuarios-tbody");
        tbody.innerHTML = "";

        paginaAtual = paginacao.paginaAtual;
        totalPaginas = paginacao.totalPaginas;

        if (empresas.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" style="text-align:center;">Nenhuma empresa encontrada</td></tr>';
          return;
        }

        empresas.forEach((empresa) => {
          const statusClass =
            empresa.situacaoLicensa === "Ativa" ? "active" : "inactive";
          const licencaVencida = new Date(empresa.dtLicensa) < new Date();

          tbody.innerHTML += `
            <tr>
              <td>
                <div class="user-info">
                  <div class="user-avatar">${getIniciais(
                    empresa.nomeFantasia
                  )}</div>
                  <span>${empresa.nomeFantasia}</span>
                </div>
              </td>
              <td>${empresa.emailCoorporativa}</td>
              <td>
                <span class="badge badge-user">Empresa</span>
              </td>
              <td>${empresa.cnpj}</td>
              <td><span class="status-dot ${statusClass}"></span> ${empresa.situacaoLicensa}</td>
              <td>${formatarData(empresa.dtLicensa)} ${licencaVencida ? '<span style="color:red;">&#10060;</span>' : ''}</td>
              <td>
                <div class="table-actions">
                  <button class="btn-icon btn-edit" title="Editar" onclick="abrirModalEdicao(${
                    empresa.idEmpresa
                  })">
                    &#9998;
                  </button>
                  <button class="btn-icon btn-delete" title="Excluir" onclick="excluirEmpresa(${
                    empresa.idEmpresa
                  }, '${empresa.nomeFantasia}')">
                    &#128465;
                  </button>
                </div>
              </td>
            </tr>
          `;
        });
        atualizarPaginacao(paginacao);
      })
      .catch((err) => {
        console.error("Erro ao carregar empresas:", err);
        alert("Erro ao carregar empresas: " + err.message);
      });
  }

  window.excluirEmpresa = function(idEmpresa, nomeEmpresa){
    if (
      ! confirm(
        `Tem certeza que quer excluir a empresa "${nomeEmpresa}"?\n\nEsta a√ß√£o n√£o poder√° ser desfeita`
      )
    ){
      return;
    }

    fetch(`/admin/empresas/${idEmpresa}`, {
      method: "DELETE",
    })
    .then((res) => res.json())
    .then((resultado) => {
      alert("Empresa exclu√≠da!");
      carregarEmpresas(paginaAtual);
    })
    .catch((err) => {
      console.error("Erro ao excluir empresa", err);
      alert("Erro ao excluir")
    });
  };

  function atualizarPaginacao(paginacao) {
    const paginationInfo = document.querySelector(".pagination-info");
    const btnAnterior = document.querySelector(".btn-pagination:first-child");
    const btnProximo = document.querySelector(".btn-pagination:last-child");
    carregarEmpresasSelect();

    paginationInfo.textContent = `P√°gina ${paginacao.paginaAtual} de ${paginacao.totalPaginas} ‚Ä¢ ${paginacao.totalEmpresas} empresas`;

    btnAnterior.disabled = ! paginacao.temAnterior;
    btnProximo.disabled = !paginacao.temProxima;

    btnAnterior.style.opacity = paginacao.temAnterior ? "1" : "0.5";
    btnProximo.style.opacity = paginacao.temProxima ? "1" : "0.5";
    btnAnterior.style.cursor = paginacao.temAnterior
      ? "pointer"
      : "not-allowed";
    btnProximo.style.cursor = paginacao.temProxima
      ?  "pointer"
      : "not-allowed";

    btnAnterior.onclick = () => {
      if (paginacao.temAnterior) {
        carregarEmpresas(paginacao.paginaAtual - 1);
      }
    };

    btnProximo.onclick = () => {
      if (paginacao.temProxima) {
        carregarEmpresas(paginacao.paginaAtual + 1);
      }
    };
  }

  window.abrirModalEdicao = function (idEmpresa) {
    fetch(`/admin/empresas/${idEmpresa}`)
      .then((res) => res.json())
      .then((empresa) => {
        document.getElementById("edit-id-usuario").value = empresa.idEmpresa;
        document.getElementById("edit-nome").value = empresa.nomeFantasia;
        document.getElementById("edit-email").value = empresa.emailCoorporativa;
        document.getElementById("edit-telefone").value = empresa.cnpj || "";
        document.getElementById("edit-senha").value = "";
        document.getElementById("edit-confirmar-senha").value = "";
        
        const selectEmpresa = document.getElementById("edit-empresa");
        if (selectEmpresa) {
          selectEmpresa.style.display = "none";
        }

        document.getElementById("modal-editar-usuario").style.display = "flex";
      })
      .catch((err) => {
        console.error("Erro ao buscar empresa:", err);
        alert("Erro ao carregar dados da empresa");
      });
  };

  window.fecharModalEdicao = function () {
    document.getElementById("modal-editar-usuario").style.display = "none";
    document.getElementById("form-editar-usuario").reset();
  };

  document.getElementById("form-editar-usuario").addEventListener("submit", function(e) {
    e.preventDefault();
    
    const idEmpresa = document.getElementById("edit-id-usuario").value;
    const nomeFantasia = document.getElementById("edit-nome").value;
    const emailCoorporativa = document.getElementById("edit-email").value;
    const cnpj = document.getElementById("edit-telefone").value;
    const novaSenha = document.getElementById("edit-senha").value;
    const confirmarSenha = document.getElementById("edit-confirmar-senha").value;

    if (novaSenha || confirmarSenha) {
      if (novaSenha.length < 8) {
        alert("A nova senha deve ter no m√≠nimo 8 caracteres!");
        return;
      }
      
      if (novaSenha !== confirmarSenha) {
        alert("As senhas n√£o coincidem!");
        return;
      }
    }

    const dados = {
      nomeServer: nomeFantasia,
      emailServer: emailCoorporativa,
      cnpjServer: cnpj
    };

    if (novaSenha) {
      dados.senhaServer = novaSenha;
    }

    fetch(`/admin/empresas/${idEmpresa}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(dados)
    })
    .then((res) => res.json())
    .then((resultado) => {
      alert("Empresa atualizada com sucesso!");
      fecharModalEdicao();
      carregarEmpresas(paginaAtual);
    })
    .catch((err) => {
      console.error("Erro ao atualizar empresa:", err);
      alert("Erro ao atualizar empresa");
    });
  });

  async function cadastrarUsuarioAdmin(event) {
    event.preventDefault();

    const nome = document.getElementById("create-name").value;
    const email = document.getElementById("create-email"). value;
    const senha = document.getElementById("create-password").value;
    const confirmarSenha = document.getElementById("create-confirm"). value;

    if (senha !== confirmarSenha) {
      alert("As senhas n√£o coincidem!");
      return false;
    }

    if (senha.length < 8) {
      alert("A senha deve ter no m√≠nimo 8 caracteres!");
      return false;
    }

    try {
      const response = await fetch("/admin/cadastrarUsuarioAdmin", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          nomeServer: nome,
          emailServer: email,
          senhaServer: senha,
        }),
      });

      if (response.ok) {
        const data = await response.json();
        alert("Usu√°rio cadastrado com sucesso!");
        document.getElementById("formNovoUsuario").reset();
      } else {
        const errorText = await response.text();
        alert(errorText || "Erro ao cadastrar usu√°rio");
      }
    } catch (error) {
      console.error("Erro:", error);
      alert("Erro de conex√£o com o servidor");
    }

    return false;
  }

  window.cadastrarUsuarioAdmin = cadastrarUsuarioAdmin;

  document
    .getElementById("form-editar-usuario-proprio")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const adminLogado = JSON.parse(sessionStorage.getItem("ADMIN_LOGADO"));

      if (! adminLogado || !adminLogado.idAdmin) {
        alert("Sess√£o expirada. Fa√ßa login novamente.");
        window.location.href = "/login";
        return;
      }

      const nome = document.getElementById("profile-name").value;
      const senhaAtual = document.getElementById(
        "profile-current-password"
      ).value;
      const novaSenha = document.getElementById("profile-new-password").value;
      const confirmarSenha = document.getElementById(
        "profile-confirm-password"
      ).value;

      if (! nome) {
        alert("Digite seu nome!");
        return;
      }

      if (! senhaAtual) {
        alert("Digite sua senha atual!");
        return;
      }

      if (novaSenha.length < 8) {
        alert("A nova senha deve ter no m√≠nimo 8 caracteres!");
        return;
      }

      if (novaSenha !== confirmarSenha) {
        alert("As senhas n√£o coincidem!");
        return;
      }

      fetch(`/admin/usuario/${adminLogado.idAdmin}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          nomeServer: nome,
          novaSenhaServer: novaSenha,
        }),
      })
        .then((response) => {
          if (!response.ok) {
            return response.json().then((data) => {
              throw new Error(data.erro || "Erro ao atualizar perfil");
            });
          }
          return response.json();
        })
        .then((data) => {
          alert("Perfil atualizado com sucesso!");
          document.getElementById("profile-current-password").value = "";
          document.getElementById("profile-new-password").value = "";
          document.getElementById("profile-confirm-password").value = "";
        })
        .catch((erro) => {
          console.error("Erro ao atualizar perfil:", erro);
          alert(erro.message);
        });
    });

  window.excluirUsuario = function (idUsuario, nomeUsuario) {
    if (
      !confirm(
        `Tem certeza que deseja excluir o usu√°rio "${nomeUsuario}"?\n\nEsta a√ß√£o n√£o pode ser desfeita! `
      )
    ) {
      return;
    }

    fetch(`/admin/usuarios/${idUsuario}`, {
      method: "DELETE",
    })
      .then((res) => res.json())
      .then((resultado) => {
        alert("Usu√°rio exclu√≠do com sucesso!");
        carregarEmpresas(paginaAtual);
      })
      .catch((err) => {
        console.error("Erro ao excluir usu√°rio:", err);
        alert("Erro ao excluir usu√°rio");
      });
  };

  function carregarEmpresasSelect() {
    fetch("/admin/empresas/listar")
      .then((res) => res.json())
      .then((empresas) => {
        const select = document.getElementById("edit-empresa");
        if (! select) return;
        select.innerHTML = '<option value="">Sem empresa vinculada</option>';

        empresas.forEach((empresa) => {
          select.innerHTML += `<option value="${empresa.idEmpresa}">${empresa.nomeFantasia}</option>`;
        });
      })
      .catch((err) => {
        console.error("Erro ao carregar empresas:", err);
      });
  }

  function getIniciais(nome) {
    if (!nome) return "";
    return nome
      .split(" ")
      .map((n) => n[0])
      .join("")
      .slice(0, 2)
      .toUpperCase();
  }

  function formatarData(dataStr) {
    if (!dataStr) return "-";
    const date = new Date(dataStr);
    return date.toLocaleDateString("pt-BR");
  }

  const searchInput = document.querySelector(".search-input");
  const filterSelect = document.querySelector(".filter-select");

  function filterTable() {
    const searchTerm = searchInput ?  searchInput.value.toLowerCase() : "";
    const filterType = filterSelect ? filterSelect.value : "all";
    const tableRows = document.querySelectorAll(".users-table tbody tr");

    tableRows.forEach((row) => {
      const name =
        row.querySelector(".user-info span")?.textContent.toLowerCase() || "";
      const email =
        row.querySelectorAll("td")[1]?.textContent.toLowerCase() || "";
      const type =
        row.querySelector(".badge")?.textContent.toLowerCase() || "";

      const matchesSearch =
        name.includes(searchTerm) || email.includes(searchTerm);
      const matchesFilter =
        filterType === "all" ||
        (filterType === "admin" && type.includes("admin")) ||
        (filterType === "user" && type.includes("usu√°rio"));

      row.style.display = matchesSearch && matchesFilter ? "" : "none";
    });
  }

  if (searchInput) {
    searchInput.addEventListener("input", filterTable);
  }

  if (filterSelect) {
    filterSelect.addEventListener("change", filterTable);
  }

  window.addEventListener("click", function (e) {
    const modal = document.getElementById("modal-editar-usuario");
    if (e.target === modal) {
      fecharModalEdicao();
    }
  });
});

function carregarDadosUsuario() {
  const dadosAdmin = sessionStorage.getItem("ADMIN_LOGADO");

  if (! dadosAdmin) {
    console.error("Usu√°rio n√£o logado!");
    alert("Sess√£o expirada. Fa√ßa login novamente.");
    window.location.href = "./login.html";
    return;
  }

  try {
    const admin = JSON.parse(dadosAdmin);
    
    console.log("Dados do admin carregados:", admin);

    if (! admin.nome || !admin.email) {
      console.error("Dados incompletos:", admin);
      alert("Erro ao carregar dados do perfil. Fa√ßa login novamente.");
      window.location.href = "./login.html";
      return;
    }

    document.getElementById("profile-name").value = admin.nome;
    document.getElementById("profile-email").value = admin.email;
    document.getElementById("profile-header-nome").textContent = admin.nome;
    document.getElementById("profile-header-email").textContent = admin.email;

    if (admin.nome) {
      const iniciais = admin.nome
        .split(" ")
        .map((n) => n[0])
        .slice(0, 2)
        .join("")
        .toUpperCase();
      document.getElementById("profile-avatar").textContent = iniciais;
    }
  } catch (erro) {
    console.error("Erro ao parsear dados do admin:", erro);
    alert("Erro ao carregar perfil. Fa√ßa login novamente.");
    window.location.href = "./login.html";
  }
}

document.addEventListener("DOMContentLoaded", carregarDadosUsuario);
window.carregarDadosUsuario = carregarDadosUsuario;

function logout() {
  if (confirm("Tem certeza que deseja sair?")) {
    sessionStorage.clear();
    window.location.href = "./login.html";
  }
}
</script>
