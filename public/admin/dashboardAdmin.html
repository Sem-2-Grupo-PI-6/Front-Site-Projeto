<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Evolvere Invest - Painel Administrativo</title>
  <link rel="stylesheet" href="../css/styleDashboardAdmin.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="../js/monitoramento.js"></script>
</head>

<body>
  <main>
    <aside>
      <header>
        <h1>Evolvere Admin</h1>
        <p>Painel de Controle</p>
      </header>

      <section class="user-profile">
        <figure>RM</figure>
        <figcaption>
          <h2>Rodrigo Martins</h2>
          <span>Administrador Master</span>
        </figcaption>
      </section>

      <nav aria-label="Primary">
        <h2>Gest√£o</h2>
        <ul>
          <li><a href="#" class="active">üìä Dashboard</a></li>
        </ul>
        <h2>Sistema</h2>
        <ul>
          <li><a href="./configADM.html">‚öôÔ∏è Configura√ß√µes</a></li>
          <li><a href="#">üîî Notifica√ß√µes</a></li>
        </ul>
      </nav>

      <section class="quick-actions-sidebar">
        <h2>‚ö° A√ß√µes R√°pidas</h2>
        <div class="quick-actions-list">
          <button class="quick-action-item" id="btnNovoUsuario">
            <span class="action-icon">üë§</span>
            <span class="action-text">Novo Usu√°rio</span>
          </button>
          <button class="quick-action-item" id="btnNovaEmpresa">
            <span class="action-icon">üè¢</span>
            <span class="action-text">Nova Empresa</span>
          </button>
          <button class="quick-action-item" onclick="alert('Funcionalidade em desenvolvimento')">
            <span class="action-icon">üìä</span>
            <span class="action-text">Config. KPI</span>
          </button>
        </div>
      </section>

      <section class="system-status">
        <h2>‚ö° Status do Sistema</h2>
        <div class="status-item">
          <span class="status-dot online"></span>
          <span>API IBGE</span>
          <span class="status-badge success">OK</span>
        </div>
        <div class="status-item">
          <span class="status-dot online"></span>
          <span>API Bacen</span>
          <span class="status-badge success">OK</span>
        </div>
        <div class="status-item">
          <span class="status-dot warning"></span>
          <span>API IPEA</span>
          <span class="status-badge warning">Lento</span>
        </div>
        <div class="status-item">
          <span class="status-dot online"></span>
          <span>Database</span>
          <span class="status-badge success">99%</span>
        </div>
      </section>

      <button class="btn-logout" onclick="logout()">üö™ Sair</button>
    </aside>

    <section class="workspace">
      <section class="workspace-header">
        <div>
          <h2>Vis√£o Geral da Plataforma</h2>
          <span>√öltima atualiza√ß√£o: <span id="ultima-atualizacao">Carregando...</span> ‚Ä¢ Per√≠odo: √öltimos 30 dias</span>
        </div>
        <div class="header-actions">
          <button class="btn-secondary">üìÖ Per√≠odo</button>
          <button class="btn-primary">üì• Relat√≥rio Executivo</button>
        </div>
      </section>

      <section class="metrics-grid" aria-label="M√©tricas principais da plataforma">
        <article class="metric-card metric-primary">
          <div class="metric-header">
            <div class="metric-icon">üë•</div>
            <div class="metric-info">
              <span class="metric-label">Usu√°rios Ativos</span>
              <span class="metric-badge">Total</span>
            </div>
          </div>
          <div class="metric-value">
            <span class="value" id="metrica-usuarios">--</span>
            <span class="trend positive">
              <span class="trend-arrow">‚Üë</span>
              <span class="trend-text">+18</span>
            </span>
          </div>
          <div class="metric-footer">
            <span class="metric-detail" id="total-empresas">-- empresas</span>
            <a href="#" class="metric-link">Ver ‚Üí</a>
          </div>
        </article>

        <article class="metric-card metric-success">
          <div class="metric-header">
            <div class="metric-icon">üìä</div>
            <div class="metric-info">
              <span class="metric-label">Requisi√ß√µes</span>
              <span class="metric-badge">Total</span>
            </div>
          </div>
          <div class="metric-value">
            <span class="value" id="metrica-requisicoes">0</span>
            <span class="trend positive" id="trend-requisicoes">
              <span class="trend-arrow">‚Üí</span>
              <span class="trend-text">--</span>
            </span>
          </div>
          <div class="metric-footer">
            <span class="metric-detail" id="tempo-medio">-- ms/req</span>
            <a href="#" class="metric-link">Detalhes ‚Üí</a>
          </div>
        </article>

        <article class="metric-card metric-info">
          <div class="metric-header">
            <div class="metric-icon">üóÑÔ∏è</div>
            <div class="metric-info">
              <span class="metric-label">Sync Dados</span>
              <span class="metric-badge">Hoje</span>
            </div>
          </div>
          <div class="metric-value">
            <span class="value" id="metrica-sync">--</span>
            <span class="trend positive" id="trend-sync">
              <span class="trend-arrow">‚Üë</span>
              <span class="trend-text">--</span>
            </span>
          </div>
          <div class="metric-footer">
            <span class="metric-detail" id="ultima-sync">Sync: --</span>
            <a href="#" class="metric-link">Logs ‚Üí</a>
          </div>
        </article>

        <article class="metric-card metric-warning">
          <div class="metric-header">
            <div class="metric-icon">‚ö†Ô∏è</div>
            <div class="metric-info">
              <span class="metric-label">Taxa de Erro</span>
              <span class="metric-badge">24h</span>
            </div>
          </div>
          <div class="metric-value">
            <span class="value" id="metrica-erro">0</span>
            <span class="trend neutral" id="trend-erro">
              <span class="trend-arrow">‚Üí</span>
              <span class="trend-text">OK</span>
            </span>
          </div>
          <div class="metric-footer">
            <span class="metric-detail" id="total-erros">0 erros</span>
            <a href="#" class="metric-link">Ver ‚Üí</a>
          </div>
        </article>
      </section>

      <section class="dashboard-content">
        <div class="content-left">
          <article class="chart-card full-height">
            <header class="chart-header">
              <div>
                <h3>üìà Crescimento de Usu√°rios</h3>
                <span>Novos cadastros vs Total acumulado</span>
              </div>
              <div class="chart-legend">
                <span class="legend-item"><span class="dot primary"></span> 2025</span>
                <span class="legend-item"><span class="dot secondary"></span> 2024</span>
              </div>
            </header>
            <figure>
              <canvas id="usuariosChart" aria-label="Gr√°fico de crescimento de usu√°rios"></canvas>
            </figure>
          </article>

          <article class="chart-card">
            <header class="chart-header">
              <div>
                <h3>üè¢ Top 5 Empresas por Uso</h3>
                <span>Consultas realizadas (√∫ltimos 30 dias)</span>
              </div>
            </header>
            <figure>
              <canvas id="empresasChart" aria-label="Gr√°fico de uso por empresa"></canvas>
            </figure>
          </article>
        </div>

        <div class="content-right">
          <article class="activity-card">
            <header class="activity-header">
              <h3>üîî Atividade Recente</h3>
              <button class="btn-text">Ver todas</button>
            </header>
            <div class="activity-list">
              <div class="activity-item">
                <div class="activity-icon success">‚úì</div>
                <div class="activity-content">
                  <p class="activity-title">Novo usu√°rio cadastrado</p>
                  <p class="activity-meta">Julia Santos ‚Ä¢ Construtora ABC</p>
                  <p class="activity-time">H√° 5 minutos</p>
                </div>
              </div>
              <div class="activity-item">
                <div class="activity-icon info">‚Ñπ</div>
                <div class="activity-content">
                  <p class="activity-title">Sincroniza√ß√£o conclu√≠da</p>
                  <p class="activity-meta">API IBGE ‚Ä¢ 2.3GB processados</p>
                  <p class="activity-time">H√° 14 minutos</p>
                </div>
              </div>
              <div class="activity-item">
                <div class="activity-icon warning">!</div>
                <div class="activity-content">
                  <p class="activity-title">API IPEA com lat√™ncia alta</p>
                  <p class="activity-meta">Tempo: 2.8s (limite: 2s)</p>
                  <p class="activity-time">H√° 32 minutos</p>
                </div>
              </div>
              <div class="activity-item">
                <div class="activity-icon success">‚úì</div>
                <div class="activity-content">
                  <p class="activity-title">Relat√≥rio gerado</p>
                  <p class="activity-meta">Carlos Mendes ‚Ä¢ SP Interior</p>
                  <p class="activity-time">H√° 1 hora</p>
                </div>
              </div>
              <div class="activity-item">
                <div class="activity-icon primary">üë§</div>
                <div class="activity-content">
                  <p class="activity-title">Empresa verificada</p>
                  <p class="activity-meta">Investimentos Delta LTDA</p>
                  <p class="activity-time">H√° 2 horas</p>
                </div>
              </div>
            </div>
          </article>
        </div>
      </section>
    </section>
  </main>

  <!-- MODAL NOVO USU√ÅRIO -->
  <div class="modal-overlay" id="modalNovoUsuario">
    <div class="modal-container modal-usuario">
      <div class="modal-header">
        <div>
          <h2>üë§ Cadastrar Novo Usu√°rio</h2>
          <p>Adicione um usu√°rio e vincule a uma empresa</p>
        </div>
        <button class="btn-close-modal" onclick="fecharModalUsuario()">‚úï</button>
      </div>

      <div class="modal-body">
        <form id="formNovoUsuario" onsubmit="return cadastrarUsuario(event)">
          <section class="modal-section">
            <h3 class="section-title">üìã Dados Pessoais</h3>
            
            <div class="form-row">
              <div class="form-group">
                <label for="usuario-nome">Nome Completo *</label>
                <input 
                  type="text" 
                  id="usuario-nome" 
                  placeholder="Ex: Jo√£o Silva"
                  maxlength="100"
                  required 
                />
              </div>
              
              <div class="form-group">
                <label for="usuario-email">E-mail *</label>
                <input 
                  type="email" 
                  id="usuario-email" 
                  placeholder="usuario@empresa.com"
                  maxlength="100"
                  required 
                />
                <small class="form-hint">Ser√° usado para login</small>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="usuario-senha">Senha *</label>
                <input 
                  type="password" 
                  id="usuario-senha" 
                  placeholder="M√≠nimo 8 caracteres"
                  minlength="8"
                  required 
                />
              </div>
              
              <div class="form-group">
                <label for="usuario-confirmar-senha">Confirmar Senha *</label>
                <input 
                  type="password" 
                  id="usuario-confirmar-senha" 
                  placeholder="Repita a senha"
                  minlength="8"
                  required 
                />
              </div>
            </div>
          </section>

          <section class="modal-section">
            <h3 class="section-title">üè¢ V√≠nculo Empresarial</h3>
            
            <div class="form-row">
              <div class="form-group">
                <label for="usuario-empresa">Empresa *</label>
                <select id="usuario-empresa" required onchange="atualizarResumoUsuario()">
                  <option value="">Selecione uma empresa...</option>
                </select>
                <small class="form-hint">Empresas ativas no sistema</small>
              </div>

              <div class="form-group">
                <label for="usuario-tipo">Tipo de Acesso *</label>
                <select id="usuario-tipo" required onchange="atualizarResumoUsuario()">
                  <option value="">Selecione...</option>
                  <option value="Administrador">Administrador</option>
                  <option value="Usu√°rio">Usu√°rio Padr√£o</option>
                  <option value="Visualizador">Visualizador</option>
                </select>
              </div>
            </div>
          </section>

          <div class="alert alert-info">
            <strong>‚ÑπÔ∏è Resumo:</strong>
            <p id="resumo-usuario">Selecione uma empresa e tipo de acesso</p>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-secondary" onclick="fecharModalUsuario()">Cancelar</button>
            <button type="submit" class="btn-primary">üíæ Cadastrar Usu√°rio</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- MODAL NOVA EMPRESA -->
  <div class="modal-overlay" id="modalNovaEmpresa">
    <div class="modal-container modal-empresa">
      <div class="modal-header">
        <div>
          <h2>üè¢ Cadastrar Nova Empresa</h2>
          <p>Adicione uma empresa e defina seu plano de acesso</p>
        </div>
        <button class="btn-close-modal" onclick="fecharModalEmpresa()">‚úï</button>
      </div>

      <div class="modal-body">
        <form id="formNovaEmpresa" onsubmit="return cadastrarEmpresa(event)">
          <section class="modal-section">
            <h3 class="section-title">üìã Dados da Empresa</h3>
            
            <div class="form-row">
              <div class="form-group">
                <label for="empresa-cnpj">CNPJ *</label>
                <input 
                  type="text" 
                  id="empresa-cnpj" 
                  placeholder="00.000.000/0000-00"
                  maxlength="18"
                  oninput="formatarCNPJ(this)"
                  required 
                />
                <small class="form-hint">Apenas n√∫meros ser√£o salvos</small>
              </div>
              
              <div class="form-group">
                <label for="empresa-nome">Nome Fantasia *</label>
                <input 
                  type="text" 
                  id="empresa-nome" 
                  placeholder="Ex: Construtora ABC"
                  maxlength="45"
                  required 
                />
              </div>
            </div>

            <div class="form-group">
              <label for="empresa-email">E-mail Corporativo *</label>
              <input 
                type="email" 
                id="empresa-email" 
                placeholder="contato@empresa.com.br"
                maxlength="45"
                required 
              />
              <small class="form-hint">Ser√° usado para comunica√ß√µes oficiais</small>
            </div>
          </section>

          <div class="alert alert-info">
            <strong>‚ÑπÔ∏è Resumo:</strong>
            <p id="resumo-plano">Preencha os dados da empresa</p>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-secondary" onclick="fecharModalEmpresa()">Cancelar</button>
            <button type="submit" class="btn-primary">üíæ Cadastrar Empresa</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    let chartUsuarios = null;
    let chartEmpresas = null;

    // ========== INICIALIZA√á√ÉO ==========
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Iniciando Dashboard Admin...');

      try {
        // Timestamp
        atualizarTimestamp();
        setInterval(atualizarTimestamp, 60000);

        // M√©tricas
        atualizarMetricasAdmin();
        setInterval(atualizarMetricasAdmin, 5000);

        // Gr√°ficos
        inicializarGraficos();
        
        // Event listeners para bot√µes
        const btnNovoUsuario = document.getElementById('btnNovoUsuario');
        if (btnNovoUsuario) {
          btnNovoUsuario.addEventListener('click', abrirModalNovoUsuario);
          console.log('‚úÖ Bot√£o Novo Usu√°rio configurado');
        }

        const btnNovaEmpresa = document.getElementById('btnNovaEmpresa');
        if (btnNovaEmpresa) {
          btnNovaEmpresa.addEventListener('click', abrirModalNovaEmpresa);
          console.log('‚úÖ Bot√£o Nova Empresa configurado');
        }

        // Fechar modais clicando fora
        document.getElementById('modalNovoUsuario')?.addEventListener('click', function(e) {
          if (e.target === this) fecharModalUsuario();
        });

        document.getElementById('modalNovaEmpresa')?.addEventListener('click', function(e) {
          if (e.target === this) fecharModalEmpresa();
        });
        
        // Fechar modais com ESC
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            if (document.getElementById('modalNovoUsuario')?.classList.contains('active')) {
              fecharModalUsuario();
            }
            if (document.getElementById('modalNovaEmpresa')?.classList.contains('active')) {
              fecharModalEmpresa();
            }
          }
        });

        console.log('‚úÖ Dashboard inicializado com sucesso!');
      } catch (erro) {
        console.error('‚ùå Erro na inicializa√ß√£o:', erro);
      }
    });

    // ========== FUN√á√ïES GERAIS ==========
    
    function atualizarTimestamp() {
      try {
        const agora = new Date();
        const horas = String(agora.getHours()).padStart(2, '0');
        const minutos = String(agora.getMinutes()).padStart(2, '0');
        const elemento = document.getElementById('ultima-atualizacao');
        if (elemento) {
          elemento.textContent = `Hoje, ${horas}:${minutos}`;
        }
      } catch (erro) {
        console.error('‚ùå Erro ao atualizar timestamp:', erro);
      }
    }

    function logout() {
      if (confirm('‚ö†Ô∏è Tem certeza que deseja sair?')) {
        sessionStorage.clear();
        window.location.href = 'index.html';
      }
    }

    async function atualizarMetricasAdmin() {
      try {
        const response = await fetch('http://localhost:3333/monitoramento/metricas');
        
        if (!response.ok) {
          console.warn('‚ö†Ô∏è Erro ao buscar m√©tricas do BD');
          return;
        }
        
        const dadosBD = await response.json();

        // Atualizar m√©tricas
        const metricaReq = document.getElementById('metrica-requisicoes');
        if (metricaReq) {
          metricaReq.textContent = dadosBD.totalRequisicoes.toLocaleString('pt-BR');
        }

        const tempoMedio = document.getElementById('tempo-medio');
        if (tempoMedio) {
          tempoMedio.textContent = `${dadosBD.tempoMedioResposta}ms/req`;
        }

        const metricaSync = document.getElementById('metrica-sync');
        if (metricaSync) {
          metricaSync.innerHTML = `${parseFloat(dadosBD.taxaSucesso).toFixed(1)}<span class="unit">%</span>`;
        }
        
        const trendSync = document.getElementById('trend-sync');
        if (trendSync) {
          if (dadosBD.taxaSucesso >= 98) {
            trendSync.className = 'trend positive';
            trendSync.innerHTML = '<span class="trend-arrow">‚Üë</span><span class="trend-text">OK</span>';
          } else if (dadosBD.taxaSucesso >= 95) {
            trendSync.className = 'trend neutral';
            trendSync.innerHTML = '<span class="trend-arrow">‚Üí</span><span class="trend-text">Alerta</span>';
          } else {
            trendSync.className = 'trend negative';
            trendSync.innerHTML = '<span class="trend-arrow">‚Üì</span><span class="trend-text">Cr√≠tico</span>';
          }
        }

        if (dadosBD.dtUltimaSync) {
          const ultimaSync = document.getElementById('ultima-sync');
          if (ultimaSync) {
            const data = new Date(dadosBD.dtUltimaSync);
            const horas = String(data.getHours()).padStart(2, '0');
            const minutos = String(data.getMinutes()).padStart(2, '0');
            ultimaSync.textContent = `Sync: ${horas}:${minutos}`;
          }
        }

        const metricaErro = document.getElementById('metrica-erro');
        if (metricaErro) {
          metricaErro.innerHTML = `${parseFloat(dadosBD.taxaErro).toFixed(1)}<span class="unit">%</span>`;
        }
        
        const totalErros = document.getElementById('total-erros');
        if (totalErros) {
          totalErros.textContent = `${dadosBD.requisicoesErro} erro${dadosBD.requisicoesErro !== 1 ? 's' : ''}`;
        }
        
        const trendErro = document.getElementById('trend-erro');
        if (trendErro) {
          if (dadosBD.taxaErro === 0 || dadosBD.taxaErro === '0.00') {
            trendErro.className = 'trend positive';
            trendErro.innerHTML = '<span class="trend-arrow">‚úì</span><span class="trend-text">OK</span>';
          } else if (dadosBD.taxaErro < 5) {
            trendErro.className = 'trend neutral';
            trendErro.innerHTML = '<span class="trend-arrow">‚Üí</span><span class="trend-text">Baixo</span>';
          } else {
            trendErro.className = 'trend negative';
            trendErro.innerHTML = '<span class="trend-arrow">‚Üë</span><span class="trend-text">Alto</span>';
          }
        }
        
      } catch (erro) {
        console.error('‚ùå Erro ao atualizar m√©tricas:', erro);
      }
    }

    function inicializarGraficos() {
      try {
        const defaultOptions = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: "rgba(12, 15, 29, 0.95)",
              borderColor: "rgba(93, 209, 255, 0.5)",
              borderWidth: 1,
              titleColor: "#f7f9ff",
              bodyColor: "#f7f9ff",
              padding: 10,
              cornerRadius: 8,
              displayColors: true,
            },
          },
          scales: {
            x: {
              grid: { color: "rgba(93, 209, 255, 0.08)", drawBorder: false },
              ticks: {
                color: "rgba(247, 249, 255, 0.6)",
                font: { size: 9, weight: '500' },
                maxRotation: 0,
                minRotation: 0,
              },
            },
            y: {
              grid: { color: "rgba(93, 209, 255, 0.08)", drawBorder: false },
              ticks: {
                color: "rgba(247, 249, 255, 0.6)",
                font: { size: 9, weight: '500' }
              },
            },
          },
        };

        const canvasUsuarios = document.getElementById("usuariosChart");
        if (canvasUsuarios) {
          chartUsuarios = new Chart(canvasUsuarios, {
            type: "line",
            data: {
              labels: ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"],
              datasets: [
                {
                  label: "Novos Usu√°rios",
                  data: [5, 8, 12, 9, 15, 18, 14, 22, 19, 25, 28, 31],
                  borderColor: "#5dd1ff",
                  backgroundColor: "rgba(93, 209, 255, 0.15)",
                  tension: 0.4,
                  fill: true,
                  borderWidth: 3,
                  pointRadius: 4,
                  pointHoverRadius: 6,
                  pointBackgroundColor: "#5dd1ff",
                },
                {
                  label: "Total Acumulado",
                  data: [45, 53, 65, 74, 89, 107, 121, 143, 162, 187, 215, 246],
                  borderColor: "#8b5dff",
                  backgroundColor: "rgba(139, 93, 255, 0.1)",
                  tension: 0.4,
                  fill: true,
                  borderWidth: 2.5,
                  pointRadius: 3,
                  pointHoverRadius: 5,
                  pointBackgroundColor: "#8b5dff",
                  yAxisID: 'y1',
                },
              ],
            },
            options: {
              ...defaultOptions,
              layout: { padding: { top: 10, right: 10, bottom: 5, left: 5 } },
              scales: {
                x: defaultOptions.scales.x,
                y: {
                  ...defaultOptions.scales.y,
                  type: 'linear',
                  display: true,
                  position: 'left',
                  title: {
                    display: true,
                    text: 'Novos',
                    color: 'rgba(247, 249, 255, 0.6)',
                    font: { size: 9, weight: '600' },
                  },
                },
                y1: {
                  ...defaultOptions.scales.y,
                  type: 'linear',
                  display: true,
                  position: 'right',
                  title: {
                    display: true,
                    text: 'Total',
                    color: 'rgba(247, 249, 255, 0.6)',
                    font: { size: 9, weight: '600' },
                  },
                  grid: { drawOnChartArea: false },
                },
              },
            },
          });
        }

        const canvasEmpresas = document.getElementById("empresasChart");
        if (canvasEmpresas) {
          chartEmpresas = new Chart(canvasEmpresas, {
            type: "bar",
            data: {
              labels: ["Construtora XYZ", "Investimentos ABC", "Fundo Delta", "Imobili√°ria Sigma", "Capital Omega"],
              datasets: [
                {
                  label: "Consultas",
                  data: [1420, 1180, 980, 860, 740],
                  backgroundColor: ["#5dd1ff", "#8b5dff", "#60a5fa", "#7dd3fc", "#c084fc"],
                  borderRadius: 8,
                  borderSkipped: false,
                },
              ],
            },
            options: {
              ...defaultOptions,
              indexAxis: 'y',
              layout: { padding: { top: 5, right: 10, bottom: 5, left: 5 } },
              scales: {
                x: defaultOptions.scales.x,
                y: {
                  ...defaultOptions.scales.y,
                  grid: { display: false },
                  ticks: {
                    color: "rgba(247, 249, 255, 0.7)",
                    font: { size: 9, weight: '500' },
                  },
                },
              },
            },
          });
        }

        console.log('‚úÖ Gr√°ficos inicializados');
      } catch (erro) {
        console.error('‚ùå Erro ao inicializar gr√°ficos:', erro);
      }
    }

    // ========== MODAL NOVO USU√ÅRIO ==========
    
    async function abrirModalNovoUsuario() {
      try {
        const modal = document.getElementById('modalNovoUsuario');
        if (modal) {
          modal.classList.add('active');
          document.body.style.overflow = 'hidden';
          await carregarEmpresas();
        }
      } catch (erro) {
        console.error('‚ùå Erro ao abrir modal usu√°rio:', erro);
      }
    }

    function fecharModalUsuario() {
      const modal = document.getElementById('modalNovoUsuario');
      if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
        const form = document.getElementById('formNovoUsuario');
        if (form) form.reset();
        const resumo = document.getElementById('resumo-usuario');
        if (resumo) resumo.textContent = 'Selecione uma empresa e tipo de acesso';
      }
    }

    async function carregarEmpresas() {
      try {
        const response = await fetch('http://localhost:3333/empresas/listar');
        
        if (!response.ok) {
          console.warn('‚ö†Ô∏è Erro ao buscar empresas');
          return;
        }
        
        const empresas = await response.json();
        const selectEmpresa = document.getElementById('usuario-empresa');
        
        if (selectEmpresa) {
          selectEmpresa.innerHTML = '<option value="">Selecione uma empresa...</option>';
          
          empresas
            .filter(emp => emp.status === 'Ativo')
            .forEach(empresa => {
              const option = document.createElement('option');
              option.value = empresa.idEmpresa;
              option.textContent = `${empresa.nomeFantasia} (${empresa.cnpj})`;
              option.dataset.plano = empresa.plano;
              selectEmpresa.appendChild(option);
            });
            
          console.log('‚úÖ Empresas carregadas:', empresas.length);
        }
      } catch (erro) {
        console.error('‚ùå Erro ao carregar empresas:', erro);
        alert('‚ö†Ô∏è Erro ao carregar lista de empresas. Tente novamente.');
      }
    }

    function atualizarResumoUsuario() {
      try {
        const empresaSelect = document.getElementById('usuario-empresa');
        const tipoAcesso = document.getElementById('usuario-tipo')?.value;
        const resumo = document.getElementById('resumo-usuario');
        
        if (!resumo) return;
        
        if (!empresaSelect?.value || !tipoAcesso) {
          resumo.textContent = 'Selecione uma empresa e tipo de acesso';
          return;
        }
        
        const empresaNome = empresaSelect.options[empresaSelect.selectedIndex].text;
        const plano = empresaSelect.options[empresaSelect.selectedIndex].dataset.plano;
        
        const permissoes = {
          'Administrador': 'Acesso total + gerenciar usu√°rios',
          'Usu√°rio': 'Acesso completo √†s consultas',
          'Visualizador': 'Apenas visualiza√ß√£o de relat√≥rios'
        };
        
        resumo.innerHTML = `‚úÖ Usu√°rio tipo <strong>${tipoAcesso}</strong> para <strong>${empresaNome}</strong> (Plano ${plano})<br>` +
                          `Permiss√µes: ${permissoes[tipoAcesso] || 'Padr√£o'}`;
      } catch (erro) {
        console.error('‚ùå Erro ao atualizar resumo:', erro);
      }
    }

    function cadastrarUsuario(event) {
      event.preventDefault();
      
      try {
        const nome = document.getElementById('usuario-nome')?.value.trim();
        const email = document.getElementById('usuario-email')?.value.trim();
        const senha = document.getElementById('usuario-senha')?.value;
        const confirmarSenha = document.getElementById('usuario-confirmar-senha')?.value;
        const empresaId = document.getElementById('usuario-empresa')?.value;
        const tipoAcesso = document.getElementById('usuario-tipo')?.value;

        if (!nome || !email || !senha || !empresaId || !tipoAcesso) {
          alert('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios!');
          return false;
        }

        if (senha.length < 8) {
          alert('‚ö†Ô∏è A senha deve ter no m√≠nimo 8 caracteres!');
          return false;
        }

        if (senha !== confirmarSenha) {
          alert('‚ö†Ô∏è As senhas n√£o coincidem!');
          return false;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          alert('‚ö†Ô∏è Email inv√°lido!');
          return false;
        }

        console.log('üì§ Enviando dados do usu√°rio:', { nome, email, empresaId, tipoAcesso });

        fetch('http://localhost:3333/usuarios/cadastrar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            nomeServer: nome,
            emailServer: email,
            senhaServer: senha,
            empresaIdServer: empresaId,
            tipoAcessoServer: tipoAcesso
          })
        })
        .then(response => {
          if (!response.ok) {
            return response.text().then(text => {
              throw new Error(text || 'Erro ao cadastrar usu√°rio');
            });
          }
          return response.json();
        })
        .then(data => {
          console.log('‚úÖ Usu√°rio cadastrado:', data);
          const empresaNome = document.getElementById('usuario-empresa').options[document.getElementById('usuario-empresa').selectedIndex].text;
          alert(`‚úÖ Usu√°rio "${nome}" cadastrado com sucesso!\n\nID: ${data.insertId}\nEmpresa: ${empresaNome}\nTipo: ${tipoAcesso}\nEmail: ${email}`);
          fecharModalUsuario();
          setTimeout(atualizarMetricasAdmin, 1000);
        })
        .catch(erro => {
          console.error('‚ùå Erro ao cadastrar usu√°rio:', erro);
          if (erro.message.includes('Email j√° cadastrado') || erro.message.includes('ER_DUP_ENTRY')) {
            alert('‚ùå Este email j√° est√° cadastrado no sistema!');
          } else if (erro.message.includes('ECONNREFUSED')) {
            alert('‚ùå Erro de conex√£o com o servidor. Verifique se o backend est√° rodando.');
          } else {
            alert('‚ùå Erro ao cadastrar usu√°rio: ' + erro.message);
          }
        });

        return false;
      } catch (erro) {
        console.error('‚ùå Erro no cadastro:', erro);
        return false;
      }
    }

    // ========== MODAL NOVA EMPRESA ==========

    function abrirModalNovaEmpresa() {
      const modal = document.getElementById('modalNovaEmpresa');
      if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
    }

    function fecharModalEmpresa() {
      const modal = document.getElementById('modalNovaEmpresa');
      if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
        const form = document.getElementById('formNovaEmpresa');
        if (form) form.reset();
        const resumo = document.getElementById('resumo-plano');
        if (resumo) resumo.textContent = 'Preencha os dados da empresa';
      }
    }

    function formatarCNPJ(input) {
      let valor = input.value.replace(/\D/g, '');
      
      if (valor.length <= 14) {
        valor = valor.replace(/^(\d{2})(\d)/, '$1.$2');
        valor = valor.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
        valor = valor.replace(/\.(\d{3})(\d)/, '.$1/$2');
        valor = valor.replace(/(\d{4})(\d)/, '$1-$2');
      }
      
      input.value = valor;
    }

    function cadastrarEmpresa(event) {
      event.preventDefault();
      
      try {
        const cnpj = document.getElementById('empresa-cnpj')?.value.replace(/\D/g, '');
        const nome = document.getElementById('empresa-nome')?.value.trim();
        const email = document.getElementById('empresa-email')?.value.trim();

        if (!cnpj || !nome || !email) {
          alert('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios!');
          return false;
        }

        if (cnpj.length !== 14) {
          alert('‚ö†Ô∏è CNPJ deve ter 14 d√≠gitos!');
          return false;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          alert('‚ö†Ô∏è Email inv√°lido!');
          return false;
        }

        console.log('üì§ Enviando dados da empresa:', { cnpj, nome, email });

        fetch('http://localhost:3333/empresas/cadastrar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cnpjServer: cnpj,
            nomeServer: nome,
            emailServer: email
          })
        })
        .then(response => {
          if (!response.ok) {
            return response.text().then(text => {
              throw new Error(text || 'Erro ao cadastrar empresa');
            });
          }
          return response.json();
        })
        .then(data => {
          console.log('‚úÖ Empresa cadastrada:', data);
          alert(`‚úÖ Empresa "${nome}" cadastrada com sucesso!\n\nID: ${data.insertId}`);
          fecharModalEmpresa();
          setTimeout(atualizarMetricasAdmin, 1000);
        })
        .catch(erro => {
          console.error('‚ùå Erro ao cadastrar empresa:', erro);
          if (erro.message.includes('CNPJ j√° cadastrado') || erro.message.includes('ER_DUP_ENTRY')) {
            alert('‚ùå Este CNPJ j√° est√° cadastrado no sistema!');
          } else if (erro.message.includes('ECONNREFUSED')) {
            alert('‚ùå Erro de conex√£o com o servidor. Verifique se o backend est√° rodando.');
          } else {
            alert('‚ùå Erro ao cadastrar empresa: ' + erro.message);
          }
        });

        return false;
      } catch (erro) {
        console.error('‚ùå Erro no cadastro:', erro);
        return false;
      }
    }
  </script>
</body>
</html>