<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Evolvere Invest - Painel Administrativo</title>
  <link rel="stylesheet" href="./css/styleDashboardAdmin.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="./js/monitoramento.js"></script>
</head>

<body>
  <main>
    <aside>
      <header>
        <h1>Evolvere Admin</h1>
        <p>Painel de Controle</p>
      </header>

      <section class="user-profile">
        <figure>RM</figure>
        <figcaption>
          <h2>Rodrigo Martins</h2>
          <span>Administrador Master</span>
        </figcaption>
      </section>

      <nav aria-label="Primary">
        <h2>Gest√£o</h2>
        <ul>
          <li><a href="#" class="active">üìä Dashboard</a></li>
          <li><a href="#">üìà Configurar KPIs</a></li>
        </ul>
        <h2>Sistema</h2>
        <ul>
          <li><a href="./configADM.html">‚öôÔ∏è Configura√ß√µes</a></li>
          <li><a href="#">üîî Notifica√ß√µes</a></li>
        </ul>
      </nav>

      <section class="quick-actions-sidebar">
        <h2>‚ö° A√ß√µes R√°pidas</h2>
        <div class="quick-actions-list">
          <button class="quick-action-item" onclick="alert('Funcionalidade em desenvolvimento')">
            <span class="action-icon">üë§</span>
            <span class="action-text">Novo Usu√°rio</span>
          </button>
          <button class="quick-action-item" id="btnNovaEmpresa">
            <span class="action-icon">üè¢</span>
            <span class="action-text">Nova Empresa</span>
          </button>
          <button class="quick-action-item" onclick="alert('Funcionalidade em desenvolvimento')">
            <span class="action-icon">üìä</span>
            <span class="action-text">Config. KPI</span>
          </button>
        </div>
      </section>

      <section class="system-status">
        <h2>‚ö° Status do Sistema</h2>
        <div class="status-item">
          <span class="status-dot online"></span>
          <span>API IBGE</span>
          <span class="status-badge success">OK</span>
        </div>
        <div class="status-item">
          <span class="status-dot online"></span>
          <span>API Bacen</span>
          <span class="status-badge success">OK</span>
        </div>
        <div class="status-item">
          <span class="status-dot warning"></span>
          <span>API IPEA</span>
          <span class="status-badge warning">Lento</span>
        </div>
        <div class="status-item">
          <span class="status-dot online"></span>
          <span>Database</span>
          <span class="status-badge success">99%</span>
        </div>
      </section>

      <button class="btn-logout" onclick="logout()">üö™ Sair</button>
    </aside>

    <section class="workspace">
      <section class="workspace-header">
        <div>
          <h2>Vis√£o Geral da Plataforma</h2>
          <span>√öltima atualiza√ß√£o: <span id="ultima-atualizacao">Carregando...</span> ‚Ä¢ Per√≠odo: √öltimos 30 dias</span>
        </div>
        <div class="header-actions">
          <button class="btn-secondary">üìÖ Per√≠odo</button>
          <button class="btn-primary">üì• Relat√≥rio Executivo</button>
        </div>
      </section>

      <section class="metrics-grid" aria-label="M√©tricas principais da plataforma">
        <article class="metric-card metric-primary">
          <div class="metric-header">
            <div class="metric-icon">üë•</div>
            <div class="metric-info">
              <span class="metric-label">Usu√°rios Ativos</span>
              <span class="metric-badge">Total</span>
            </div>
          </div>
          <div class="metric-value">
            <span class="value" id="metrica-usuarios">--</span>
            <span class="trend positive">
              <span class="trend-arrow">‚Üë</span>
              <span class="trend-text">+18</span>
            </span>
          </div>
          <div class="metric-footer">
            <span class="metric-detail" id="total-empresas">-- empresas</span>
            <a href="#" class="metric-link">Ver ‚Üí</a>
          </div>
        </article>

        <article class="metric-card metric-success">
          <div class="metric-header">
            <div class="metric-icon">üìä</div>
            <div class="metric-info">
              <span class="metric-label">Requisi√ß√µes</span>
              <span class="metric-badge">Total</span>
            </div>
          </div>
          <div class="metric-value">
            <span class="value" id="metrica-requisicoes">0</span>
            <span class="trend positive" id="trend-requisicoes">
              <span class="trend-arrow">‚Üí</span>
              <span class="trend-text">--</span>
            </span>
          </div>
          <div class="metric-footer">
            <span class="metric-detail" id="tempo-medio">-- ms/req</span>
            <a href="#" class="metric-link">Detalhes ‚Üí</a>
          </div>
        </article>

        <article class="metric-card metric-info">
          <div class="metric-header">
            <div class="metric-icon">üóÑÔ∏è</div>
            <div class="metric-info">
              <span class="metric-label">Sync Dados</span>
              <span class="metric-badge">Hoje</span>
            </div>
          </div>
          <div class="metric-value">
            <span class="value" id="metrica-sync">--</span>
            <span class="trend positive" id="trend-sync">
              <span class="trend-arrow">‚Üë</span>
              <span class="trend-text">--</span>
            </span>
          </div>
          <div class="metric-footer">
            <span class="metric-detail" id="ultima-sync">Sync: --</span>
            <a href="#" class="metric-link">Logs ‚Üí</a>
          </div>
        </article>

        <article class="metric-card metric-warning">
          <div class="metric-header">
            <div class="metric-icon">‚ö†Ô∏è</div>
            <div class="metric-info">
              <span class="metric-label">Taxa de Erro</span>
              <span class="metric-badge">24h</span>
            </div>
          </div>
          <div class="metric-value">
            <span class="value" id="metrica-erro">0</span>
            <span class="trend neutral" id="trend-erro">
              <span class="trend-arrow">‚Üí</span>
              <span class="trend-text">OK</span>
            </span>
          </div>
          <div class="metric-footer">
            <span class="metric-detail" id="total-erros">0 erros</span>
            <a href="#" class="metric-link">Ver ‚Üí</a>
          </div>
        </article>
      </section>

      <section class="dashboard-content">
        <div class="content-left">

          <article class="chart-card full-height">
            <header class="chart-header">
              <div>
                <h3>üìà Crescimento de Usu√°rios</h3>
                <span>Novos cadastros vs Total acumulado</span>
              </div>
              <div class="chart-legend">
                <span class="legend-item"><span class="dot primary"></span> 2025</span>
                <span class="legend-item"><span class="dot secondary"></span> 2024</span>
              </div>
            </header>
            <figure>
              <canvas id="usuariosChart" aria-label="Gr√°fico de crescimento de usu√°rios"></canvas>
            </figure>
          </article>

          <article class="chart-card">
            <header class="chart-header">
              <div>
                <h3>üè¢ Top 5 Empresas por Uso</h3>
                <span>Consultas realizadas (√∫ltimos 30 dias)</span>
              </div>
            </header>
            <figure>
              <canvas id="empresasChart" aria-label="Gr√°fico de uso por empresa"></canvas>
            </figure>
          </article>
        </div>

        <div class="content-right">
          <article class="activity-card">
            <header class="activity-header">
              <h3>üîî Atividade Recente</h3>
              <button class="btn-text">Ver todas</button>
            </header>
            <div class="activity-list">
              <div class="activity-item">
                <div class="activity-icon success">‚úì</div>
                <div class="activity-content">
                  <p class="activity-title">Novo usu√°rio cadastrado</p>
                  <p class="activity-meta">Julia Santos ‚Ä¢ Construtora ABC</p>
                  <p class="activity-time">H√° 5 minutos</p>
                </div>
              </div>
              <div class="activity-item">
                <div class="activity-icon info">‚Ñπ</div>
                <div class="activity-content">
                  <p class="activity-title">Sincroniza√ß√£o conclu√≠da</p>
                  <p class="activity-meta">API IBGE ‚Ä¢ 2.3GB processados</p>
                  <p class="activity-time">H√° 14 minutos</p>
                </div>
              </div>
              <div class="activity-item">
                <div class="activity-icon warning">!</div>
                <div class="activity-content">
                  <p class="activity-title">API IPEA com lat√™ncia alta</p>
                  <p class="activity-meta">Tempo: 2.8s (limite: 2s)</p>
                  <p class="activity-time">H√° 32 minutos</p>
                </div>
              </div>
              <div class="activity-item">
                <div class="activity-icon success">‚úì</div>
                <div class="activity-content">
                  <p class="activity-title">Relat√≥rio gerado</p>
                  <p class="activity-meta">Carlos Mendes ‚Ä¢ SP Interior</p>
                  <p class="activity-time">H√° 1 hora</p>
                </div>
              </div>
              <div class="activity-item">
                <div class="activity-icon primary">üë§</div>
                <div class="activity-content">
                  <p class="activity-title">Empresa verificada</p>
                  <p class="activity-meta">Investimentos Delta LTDA</p>
                  <p class="activity-time">H√° 2 horas</p>
                </div>
              </div>
            </div>
          </article>
        </div>
      </section>
    </section>
  </main>


  <div class="modal-overlay" id="modalNovaEmpresa">
    <div class="modal-container modal-empresa">
      <div class="modal-header">
        <div>
          <h2>üè¢ Cadastrar Nova Empresa</h2>
          <p>Adicione uma empresa e defina seu plano de acesso</p>
        </div>
        <button class="btn-close-modal" onclick="fecharModalEmpresa()">‚úï</button>
      </div>

      <div class="modal-body">
        <form id="formNovaEmpresa" onsubmit="return cadastrarEmpresa()">

          <section class="modal-section">
            <h3 class="section-title">üìã Dados da Empresa</h3>
            
            <div class="form-row">
              <div class="form-group">
                <label for="empresa-cnpj">CNPJ *</label>
                <input 
                  type="text" 
                  id="empresa-cnpj" 
                  placeholder="00.000.000/0000-00"
                  maxlength="18"
                  oninput="formatarCNPJ(this)"
                  required 
                />
                <small class="form-hint">Apenas n√∫meros ser√£o salvos</small>
              </div>
              
              <div class="form-group">
                <label for="empresa-nome">Nome Fantasia *</label>
                <input 
                  type="text" 
                  id="empresa-nome" 
                  placeholder="Ex: Construtora ABC"
                  maxlength="45"
                  required 
                />
              </div>
            </div>

            <div class="form-group">
              <label for="empresa-email">E-mail Corporativo *</label>
              <input 
                type="email" 
                id="empresa-email" 
                placeholder="contato@empresa.com.br"
                maxlength="45"
                required 
              />
              <small class="form-hint">Ser√° usado para comunica√ß√µes oficiais</small>
            </div>
          </section>


          <div class="alert alert-info">
            <strong>‚ÑπÔ∏è Resumo:</strong>
            <p id="resumo-plano">Selecione um plano para ver o resumo</p>
          </div>

   
          <div class="form-actions">
            <button type="button" class="btn-secondary" onclick="fecharModalEmpresa()">Cancelar</button>
            <button type="submit" class="btn-primary">üíæ Cadastrar Empresa</button>
          </div>
        </form>
      </div>
    </div>
  </div>


  <script>
    let chartUsuarios = null;
    let chartEmpresas = null;


    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Iniciando Dashboard Admin...');

      atualizarTimestamp();
      setInterval(atualizarTimestamp, 60000);

      atualizarMetricasAdmin();
      setInterval(atualizarMetricasAdmin, 5000); 

      inicializarGraficos();
      

      const btnNovaEmpresa = document.getElementById('btnNovaEmpresa');
      if (btnNovaEmpresa) {
        btnNovaEmpresa.addEventListener('click', abrirModalNovaEmpresa);
      }

      document.getElementById('modalNovaEmpresa')?.addEventListener('click', function(e) {
        if (e.target === this) fecharModalEmpresa();
      });
      

      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('modalNovaEmpresa').classList.contains('active')) {
          fecharModalEmpresa();
        }
      });
    });


    function atualizarTimestamp() {
      const agora = new Date();
      const horas = String(agora.getHours()).padStart(2, '0');
      const minutos = String(agora.getMinutes()).padStart(2, '0');
      document.getElementById('ultima-atualizacao').textContent = `Hoje, ${horas}:${minutos}`;
    }

    function logout() {
      if (confirm('‚ö†Ô∏è Tem certeza que deseja sair?')) {
        sessionStorage.clear();
        window.location.href = 'index.html';
      }
    }


    async function atualizarMetricasAdmin() {
      try {
        const response = await fetch('http://localhost:3333/monitoramento/metricas');
        
        if (!response.ok) {
          console.warn('‚ö†Ô∏è Erro ao buscar m√©tricas do BD');
          return;
        }
        
        const dadosBD = await response.json();
        console.log('üìä M√©tricas atualizadas:', dadosBD);

        document.getElementById('metrica-requisicoes').textContent = 
          dadosBD.totalRequisicoes.toLocaleString('pt-BR');

        document.getElementById('tempo-medio').textContent = 
          `${dadosBD.tempoMedioResposta}ms/req`;

        document.getElementById('metrica-sync').innerHTML = 
          `${parseFloat(dadosBD.taxaSucesso).toFixed(1)}<span class="unit">%</span>`;
        
        const trendSync = document.getElementById('trend-sync');
        if (dadosBD.taxaSucesso >= 98) {
          trendSync.className = 'trend positive';
          trendSync.innerHTML = '<span class="trend-arrow">‚Üë</span><span class="trend-text">OK</span>';
        } else if (dadosBD.taxaSucesso >= 95) {
          trendSync.className = 'trend neutral';
          trendSync.innerHTML = '<span class="trend-arrow">‚Üí</span><span class="trend-text">Alerta</span>';
        } else {
          trendSync.className = 'trend negative';
          trendSync.innerHTML = '<span class="trend-arrow">‚Üì</span><span class="trend-text">Cr√≠tico</span>';
        }

        if (dadosBD.dtUltimaSync) {
          const data = new Date(dadosBD.dtUltimaSync);
          const horas = String(data.getHours()).padStart(2, '0');
          const minutos = String(data.getMinutes()).padStart(2, '0');
          document.getElementById('ultima-sync').textContent = `Sync: ${horas}:${minutos}`;
        }

        document.getElementById('metrica-erro').innerHTML = 
          `${parseFloat(dadosBD.taxaErro).toFixed(1)}<span class="unit">%</span>`;
        
        document.getElementById('total-erros').textContent = 
          `${dadosBD.requisicoesErro} erro${dadosBD.requisicoesErro !== 1 ? 's' : ''}`;
        
        const trendErro = document.getElementById('trend-erro');
        if (dadosBD.taxaErro === 0 || dadosBD.taxaErro === '0.00') {
          trendErro.className = 'trend positive';
          trendErro.innerHTML = '<span class="trend-arrow">‚úì</span><span class="trend-text">OK</span>';
        } else if (dadosBD.taxaErro < 5) {
          trendErro.className = 'trend neutral';
          trendErro.innerHTML = '<span class="trend-arrow">‚Üí</span><span class="trend-text">Baixo</span>';
        } else {
          trendErro.className = 'trend negative';
          trendErro.innerHTML = '<span class="trend-arrow">‚Üë</span><span class="trend-text">Alto</span>';
        }
        
      } catch (erro) {
        console.error('‚ùå Erro ao atualizar m√©tricas:', erro);
      }
    }

    function inicializarGraficos() {
      const defaultOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: "rgba(12, 15, 29, 0.95)",
            borderColor: "rgba(93, 209, 255, 0.5)",
            borderWidth: 1,
            titleColor: "#f7f9ff",
            bodyColor: "#f7f9ff",
            padding: 10,
            cornerRadius: 8,
            displayColors: true,
          },
        },
        scales: {
          x: {
            grid: {
              color: "rgba(93, 209, 255, 0.08)",
              drawBorder: false,
            },
            ticks: {
              color: "rgba(247, 249, 255, 0.6)",
              font: { size: 9, weight: '500' },
              maxRotation: 0,
              minRotation: 0,
            },
          },
          y: {
            grid: {
              color: "rgba(93, 209, 255, 0.08)",
              drawBorder: false,
            },
            ticks: {
              color: "rgba(247, 249, 255, 0.6)",
              font: { size: 9, weight: '500' }
            },
          },
        },
      };

      chartUsuarios = new Chart(document.getElementById("usuariosChart"), {
        type: "line",
        data: {
          labels: ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"],
          datasets: [
            {
              label: "Novos Usu√°rios",
              data: [5, 8, 12, 9, 15, 18, 14, 22, 19, 25, 28, 31],
              borderColor: "#5dd1ff",
              backgroundColor: "rgba(93, 209, 255, 0.15)",
              tension: 0.4,
              fill: true,
              borderWidth: 3,
              pointRadius: 4,
              pointHoverRadius: 6,
              pointBackgroundColor: "#5dd1ff",
            },
            {
              label: "Total Acumulado",
              data: [45, 53, 65, 74, 89, 107, 121, 143, 162, 187, 215, 246],
              borderColor: "#8b5dff",
              backgroundColor: "rgba(139, 93, 255, 0.1)",
              tension: 0.4,
              fill: true,
              borderWidth: 2.5,
              pointRadius: 3,
              pointHoverRadius: 5,
              pointBackgroundColor: "#8b5dff",
              yAxisID: 'y1',
            },
          ],
        },
        options: {
          ...defaultOptions,
          layout: {
            padding: {
              top: 10,
              right: 10,
              bottom: 5,
              left: 5
            }
          },
          scales: {
            x: defaultOptions.scales.x,
            y: {
              ...defaultOptions.scales.y,
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'Novos',
                color: 'rgba(247, 249, 255, 0.6)',
                font: { size: 9, weight: '600' },
              },
            },
            y1: {
              ...defaultOptions.scales.y,
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'Total',
                color: 'rgba(247, 249, 255, 0.6)',
                font: { size: 9, weight: '600' },
              },
              grid: {
                drawOnChartArea: false,
              },
            },
          },
        },
      });


      chartEmpresas = new Chart(document.getElementById("empresasChart"), {
        type: "bar",
        data: {
          labels: ["Construtora XYZ", "Investimentos ABC", "Fundo Delta", "Imobili√°ria Sigma", "Capital Omega"],
          datasets: [
            {
              label: "Consultas",
              data: [1420, 1180, 980, 860, 740],
              backgroundColor: [
                "#5dd1ff",
                "#8b5dff",
                "#60a5fa",
                "#7dd3fc",
                "#c084fc",
              ],
              borderRadius: 8,
              borderSkipped: false,
            },
          ],
        },
        options: {
          ...defaultOptions,
          indexAxis: 'y',
          layout: {
            padding: {
              top: 5,
              right: 10,
              bottom: 5,
              left: 5
            }
          },
          scales: {
            x: defaultOptions.scales.x,
            y: {
              ...defaultOptions.scales.y,
              grid: {
                display: false,
              },
              ticks: {
                color: "rgba(247, 249, 255, 0.7)",
                font: { size: 9, weight: '500' },
              },
            },
          },
        },
      });
    }

    function abrirModalNovaEmpresa() {
      document.getElementById('modalNovaEmpresa').classList.add('active');
      document.body.style.overflow = 'hidden';

      const hoje = new Date();
      const umAno = new Date(hoje.setFullYear(hoje.getFullYear() + 1));
      document.getElementById('empresa-licenca').value = umAno.toISOString().split('T')[0];
    }

    function fecharModalEmpresa() {
      document.getElementById('modalNovaEmpresa').classList.remove('active');
      document.body.style.overflow = '';
      document.getElementById('formNovaEmpresa').reset();
      document.getElementById('resumo-plano').textContent = 'Selecione um plano para ver o resumo';
    }

    function formatarCNPJ(input) {
      let valor = input.value.replace(/\D/g, '');
      
      if (valor.length <= 14) {
        valor = valor.replace(/^(\d{2})(\d)/, '$1.$2');
        valor = valor.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
        valor = valor.replace(/\.(\d{3})(\d)/, '.$1/$2');
        valor = valor.replace(/(\d{4})(\d)/, '$1-$2');
      }
      
      input.value = valor;
    }

    function atualizarLimiteUsuarios() {
      const plano = document.getElementById('empresa-plano').value;
      const inputLimite = document.getElementById('empresa-limite');
      const resumo = document.getElementById('resumo-plano');
      
      const planos = {
        'B√°sico': { 
          limite: 5, 
          descricao: '‚úÖ Plano B√°sico: at√© 5 usu√°rios simult√¢neos' 
        },
        'Profissional': { 
          limite: 20, 
          descricao: '‚úÖ Plano Profissional: at√© 20 usu√°rios + suporte priorit√°rio' 
        },
        'Enterprise': { 
          limite: 999, 
          descricao: '‚úÖ Plano Enterprise: usu√°rios ilimitados + suporte dedicado' 
        }
      };
      
      if (plano && planos[plano]) {
        inputLimite.value = planos[plano].limite;
        resumo.textContent = planos[plano].descricao;
      } else {
        resumo.textContent = 'Selecione um plano para ver o resumo';
      }
    }

    function cadastrarEmpresa() {
      const cnpj = document.getElementById('empresa-cnpj').value.replace(/\D/g, '');
      const nome = document.getElementById('empresa-nome').value.trim();
      const email = document.getElementById('empresa-email').value.trim();
      const plano = document.getElementById('empresa-plano').value;
      const limite = parseInt(document.getElementById('empresa-limite').value);
      const licenca = document.getElementById('empresa-licenca').value;
      const status = document.getElementById('empresa-status').value;

      if (cnpj.length !== 14) {
        alert('‚ö†Ô∏è CNPJ deve ter 14 d√≠gitos!');
        return false;
      }

      if (!nome || !email || !plano || !licenca) {
        alert('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios!');
        return false;
      }

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        alert('‚ö†Ô∏è Email inv√°lido!');
        return false;
      }

      console.log('üì§ Enviando dados da empresa:', {
        cnpj, nome, email, plano, limite, licenca, status
      });

      fetch('/empresas/cadastrar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          cnpjServer: cnpj,
          nomeServer: nome,
          emailServer: email,
          planoServer: plano,
          limiteServer: limite,
          licencaServer: licenca,
          statusServer: status
        })
      })
      .then(response => {
        console.log('üì• Resposta recebida:', response.status);
        if (!response.ok) {
          return response.text().then(text => {
            throw new Error(text || 'Erro ao cadastrar empresa');
          });
        }
        return response.json();
      })
      .then(data => {
        console.log('‚úÖ Empresa cadastrada:', data);
        alert(`‚úÖ Empresa "${nome}" cadastrada com sucesso!\n\n` +
              `ID: ${data.insertId}\n` +
              `Plano: ${plano}\n` +
              `Limite de usu√°rios: ${limite}\n` +
              `Validade: ${new Date(licenca).toLocaleDateString('pt-BR')}`);
        fecharModalEmpresa();
        
        setTimeout(atualizarMetricasAdmin, 1000);
      })
      .catch(erro => {
        console.error('‚ùå Erro ao cadastrar empresa:', erro);
        
        if (erro.message.includes('CNPJ j√° cadastrado') || erro.message.includes('ER_DUP_ENTRY')) {
          alert('‚ùå Este CNPJ j√° est√° cadastrado no sistema!');
        } else if (erro.message.includes('ECONNREFUSED')) {
          alert('‚ùå Erro de conex√£o com o servidor. Verifique se o backend est√° rodando.');
        } else {
          alert('‚ùå Erro ao cadastrar empresa: ' + erro.message);
        }
      });

      return false;
    }
  </script>
</body>
</html>