<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Evolvere Invest - Dashboard Investidor</title>
    <link rel="stylesheet" href="../css/styleCliente.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./js/monitoramento.js"></script>
    <style>
      .badge-padrao {
        background: rgba(100, 100, 100, 0.2);
        color: #666;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        margin-left: 8px;
      }

      .toast-notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #059669;
        color: white;
        padding: 14px 28px;
        border-radius: 10px;
        z-index: 10000;
        font-weight: 500;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <aside>
        <header>
          <h1>Evolvere Invest</h1>
          <p>Intelig√™ncia Estrat√©gica Imobili√°ria</p>
        </header>
        <section class="session">
          <figure id="avatarEmpresa">SC</figure>
          <figcaption>
            <h2 id="nomeUsuario">Carregando...</h2>
            <span id="nomeEmpresa">Carregando...</span>
          </figcaption>
        </section>
        <nav aria-label="Primary">
          <h2>Menu Principal</h2>
          <ul>
            <li>
              <a href="#" onclick="abrirGerenciarFiltros(); return false;"
                >üó∫Ô∏è Meus Filtros</a
              >
            </li>
            <li><a href="./configUsuario.html">üìà Configura√ß√µes</a></li>
            <li><button type="button" onclick="logout()">üö™ Sair</button></li>
          </ul>
        </nav>
        <section class="briefing">
          <h2>üí° Insight do Dia</h2>
          <p>
            Regi√µes com crescimento de PIB acima de 4% e Selic est√°vel
            apresentam ambiente favor√°vel para novos empreendimentos.
          </p>
        </section>
      </aside>

      <section class="workspace">
        <section class="workspace-header">
          <div>
            <h2>Cen√°rio Macroecon√¥mico - S√£o Paulo</h2>
            <span
              >Atualizado h√° 2 horas ‚Ä¢ Base: IBGE, Bacen, IPEA ‚Ä¢ Q4 2024</span
            >
          </div>
          <div class="header-actions">
            <button class="btn-secondary">üìÖ √öltimo Trimestre</button>
            <button class="btn-primary">üì• Exportar An√°lise</button>
          </div>
        </section>

        <section
          class="kpi-grid"
          aria-label="Indicadores macroecon√¥micos chave"
        >
          <article class="kpi-card kpi-primary">
            <div class="kpi-icon">üìä</div>
            <div class="kpi-content">
              <div class="kpi-header">
                <span class="kpi-label">PIB Estado de SP</span>
                <span class="kpi-badge">Anual</span>
              </div>
              <div class="kpi-value">+3.8<span class="kpi-unit">%</span></div>
              <div class="kpi-meta">
                <span class="kpi-trend positive">‚Üë 0.6pp vs 2023</span>
                <span class="kpi-description"
                  >Crescimento acima da m√©dia nacional</span
                >
              </div>
            </div>
          </article>

          <article class="kpi-card kpi-success">
            <div class="kpi-icon">üèóÔ∏è</div>
            <div class="kpi-content">
              <div class="kpi-header">
                <span class="kpi-label">Valor Adicionado - Constru√ß√£o</span>
                <span class="kpi-badge">Trimestral</span>
              </div>
              <div class="kpi-value">+5.2<span class="kpi-unit">%</span></div>
              <div class="kpi-meta">
                <span class="kpi-trend positive">‚Üë 1.8pp</span>
                <span class="kpi-description">Setor em expans√£o acelerada</span>
              </div>
            </div>
          </article>

          <article class="kpi-card kpi-warning">
            <div class="kpi-icon">üí∞</div>
            <div class="kpi-content">
              <div class="kpi-header">
                <span class="kpi-label">Taxa Selic</span>
                <span class="kpi-badge">Atual</span>
              </div>
              <div class="kpi-value">11.75<span class="kpi-unit">%</span></div>
              <div class="kpi-meta">
                <span class="kpi-trend neutral">‚Üí Est√°vel</span>
                <span class="kpi-description"
                  >Ambiente de cr√©dito moderado</span
                >
              </div>
            </div>
          </article>

          <article class="kpi-card kpi-info">
            <div class="kpi-icon">üë•</div>
            <div class="kpi-content">
              <div class="kpi-header">
                <span class="kpi-label">Faixa Et√°ria - Predominante</span>
                <span class="kpi-badge">Regi√µes-Alvo</span>
              </div>
              <div class="kpi-value">
                21~30<span class="kpi-unit">Anos</span>
              </div>
              <div class="kpi-meta">
                <span class="kpi-trend positive">49.30%</span>
                <span class="kpi-description">SP Capital</span>
              </div>
            </div>
          </article>
        </section>

        <section class="charts-area" aria-label="An√°lises detalhadas">
          <article class="chart-card">
            <header class="chart-header">
              <div>
                <h3>üìà Evolu√ß√£o do PIB Regional</h3>
                <span>Crescimento trimestral por regi√£o (Estado de SP)</span>
              </div>
              <div class="chart-legend">
                <span class="legend-item"
                  ><span class="dot primary"></span> Grande SP</span
                >
                <span class="legend-item"
                  ><span class="dot secondary"></span> Interior</span
                >
                <span class="legend-item"
                  ><span class="dot success"></span> Litoral</span
                >
              </div>
            </header>
            <figure>
              <canvas
                id="pibRegionalChart"
                aria-label="Gr√°fico de evolu√ß√£o do PIB por regi√£o"
              ></canvas>
            </figure>
          </article>

          <article class="chart-card">
            <header class="chart-header">
              <div>
                <h3>üè≠ Valor Adicionado por Setor</h3>
                <span>Contribui√ß√£o setorial para o PIB (√∫ltimos 12 meses)</span>
              </div>
              <div class="chart-legend">
                <span class="legend-item"
                  ><span class="dot primary"></span> Constru√ß√£o Civil</span
                >
                <span class="legend-item"
                  ><span class="dot success"></span> Servi√ßos</span
                >
              </div>
            </header>
            <figure>
              <canvas
                id="valorAdicionadoChart"
                aria-label="Gr√°fico de valor adicionado setorial"
              ></canvas>
            </figure>
          </article>

          <article class="chart-card">
            <header class="chart-header">
              <div>
                <h3>üéØ √çndice de Atratividade</h3>
                <span>Score de investimento por microrregi√£o (0-100)</span>
              </div>
              <div class="chart-legend">
                <span class="legend-item"
                  ><span class="dot success"></span> Atrativo</span
                >
                <span class="legend-item"
                  ><span class="dot warning"></span> Moderado</span
                >
              </div>
            </header>
            <figure>
              <canvas
                id="atratividadeChart"
                aria-label="Gr√°fico de √≠ndice de atratividade"
              ></canvas>
            </figure>
          </article>
        </section>
      </section>
    </main>

    <div class="modal-overlay" id="gerenciarFiltrosModal">
      <div class="modal-mini">
        <div class="modal-header-mini">
          <h2>üóÇÔ∏è Meus Filtros Salvos</h2>
          <button class="btn-close-modal" onclick="fecharGerenciarFiltros()">
            ‚úï
          </button>
        </div>
        <div class="modal-body-mini">
          <div class="filtros-salvos-list" id="filtrosSalvosList"></div>
          <button class="btn-novo-filtro" onclick="criarNovoFiltro()">
            <span>‚ûï</span>
            <span>Criar Novo Filtro</span>
          </button>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="editarFiltrosModal">
      <div class="modal-container">
        <div class="modal-header">
          <div>
            <h2 id="modalTitle">üó∫Ô∏è Configurar Filtro</h2>
            <input
              type="text"
              id="filtroNome"
              class="input-filtro-nome"
              placeholder="Nome do filtro (ex: Zona Leste Foco)"
              maxlength="30"
            />
          </div>
          <button class="btn-close-modal" onclick="fecharEditarFiltros()">
            ‚úï
          </button>
        </div>

        <div class="modal-body">
          <section class="modal-section">
            <h3 class="section-title">üìä Indicadores (KPIs)</h3>
            <p class="section-description">
              Escolha quais m√©tricas voc√™ quer acompanhar
            </p>

            <div class="filter-grid">
              <div class="filter-item">
                <label class="filter-label">
                  <input type="checkbox" id="kpi-economico-enable" checked />
                  <span class="checkbox-custom"></span>
                  <strong>Indicador Econ√¥mico</strong>
                </label>
                <select class="filter-select" id="kpi-economico">
                  <option value="pib-sp">PIB Estado de SP</option>
                  <option value="pib-itaquera">PIB - Itaquera</option>
                  <option value="pib-zonasul">PIB - Zona Sul</option>
                  <option value="pib-zonaleste">PIB - Zona Leste</option>
                  <option value="pib-zonaoeste">PIB - Zona Oeste</option>
                  <option value="pib-zonanorte">PIB - Zona Norte</option>
                  <option value="pib-abc">PIB - ABC Paulista</option>
                </select>
              </div>

              <div class="filter-item">
                <label class="filter-label">
                  <input type="checkbox" id="kpi-setor-enable" checked />
                  <span class="checkbox-custom"></span>
                  <strong>Setor de Atua√ß√£o</strong>
                </label>
                <select class="filter-select" id="kpi-setor">
                  <option value="construcao">
                    Valor Adicionado - Constru√ß√£o
                  </option>
                  <option value="servicos">Valor Adicionado - Servi√ßos</option>
                </select>
              </div>

              <div class="filter-item">
                <label class="filter-label">
                  <input type="checkbox" id="kpi-financeiro-enable" checked />
                  <span class="checkbox-custom"></span>
                  <strong>Indicador Financeiro</strong>
                </label>
                <select class="filter-select" id="kpi-financeiro">
                  <option value="selic">Taxa Selic</option>
                  <option value="inflacao">Taxa de Infla√ß√£o (IPCA)</option>
                </select>
              </div>

              <div class="filter-item">
                <label class="filter-label">
                  <input type="checkbox" id="kpi-demo-enable" checked />
                  <span class="checkbox-custom"></span>
                  <strong>Dados Demogr√°ficos</strong>
                </label>
                <select class="filter-select" id="kpi-demo">
                  <option value="faixa-etaria">
                    Faixa Et√°ria Predominante
                  </option>
                  <option value="densidade">Densidade Demogr√°fica</option>
                  <option value="renda-media">Renda M√©dia</option>
                </select>
              </div>
            </div>
          </section>

          <section class="modal-section">
            <h3 class="section-title">üìà Gr√°ficos e An√°lises</h3>
            <p class="section-description">
              Defina quais regi√µes e dados voc√™ quer comparar
            </p>

            <div class="graph-config">
              <div class="graph-item">
                <div class="graph-header">
                  <label class="filter-label">
                    <input type="checkbox" id="grafico-pib-enable" checked />
                    <span class="checkbox-custom"></span>
                    <strong>Evolu√ß√£o do PIB Regional</strong>
                  </label>
                </div>
                <div class="graph-regions">
                  <p class="graph-description">
                    Selecione at√© 3 regi√µes para comparar:
                  </p>
                  <div class="region-chips">
                    <label class="chip-label"
                      ><input
                        type="checkbox"
                        name="pib-region"
                        value="grande-sp"
                        checked
                      /><span class="chip">Grande SP</span></label
                    >
                    <label class="chip-label"
                      ><input
                        type="checkbox"
                        name="pib-region"
                        value="interior"
                        checked
                      /><span class="chip">Interior</span></label
                    >
                    <label class="chip-label"
                      ><input
                        type="checkbox"
                        name="pib-region"
                        value="litoral"
                        checked
                      /><span class="chip">Litoral</span></label
                    >
                    <label class="chip-label"
                      ><input
                        type="checkbox"
                        name="pib-region"
                        value="itaquera"
                      /><span class="chip">Itaquera</span></label
                    >
                    <label class="chip-label"
                      ><input
                        type="checkbox"
                        name="pib-region"
                        value="zona-sul"
                      /><span class="chip">Zona Sul</span></label
                    >
                    <label class="chip-label"
                      ><input
                        type="checkbox"
                        name="pib-region"
                        value="zona-leste"
                      /><span class="chip">Zona Leste</span></label
                    >
                    <label class="chip-label"
                      ><input
                        type="checkbox"
                        name="pib-region"
                        value="zona-oeste"
                      /><span class="chip">Zona Oeste</span></label
                    >
                    <label class="chip-label"
                      ><input
                        type="checkbox"
                        name="pib-region"
                        value="zona-norte"
                      /><span class="chip">Zona Norte</span></label
                    >
                    <label class="chip-label"
                      ><input
                        type="checkbox"
                        name="pib-region"
                        value="abc"
                      /><span class="chip">ABC Paulista</span></label
                    >
                    <label class="chip-label"
                      ><input
                        type="checkbox"
                        name="pib-region"
                        value="campinas"
                      /><span class="chip">Campinas</span></label
                    >
                  </div>
                </div>
              </div>

              <div class="graph-item">
                <div class="graph-header">
                  <label class="filter-label">
                    <input type="checkbox" id="grafico-setor-enable" checked />
                    <span class="checkbox-custom"></span>
                    <strong>Valor Adicionado por Setor</strong>
                  </label>
                </div>
                <div class="graph-regions">
                  <p class="graph-description">
                    Selecione os setores para an√°lise:
                  </p>
                  <div class="region-chips">
                    <label class="chip-label"
                      ><input
                        type="checkbox"
                        name="setor"
                        value="construcao"
                        checked
                      /><span class="chip">Constru√ß√£o Civil</span></label
                    >
                    <label class="chip-label"
                      ><input
                        type="checkbox"
                        name="setor"
                        value="servicos"
                        checked
                      /><span class="chip">Servi√ßos</span></label
                    >
                  </div>
                </div>
              </div>

              <div class="graph-item">
                <div class="graph-header">
                  <label class="filter-label">
                    <input
                      type="checkbox"
                      id="grafico-atratividade-enable"
                      checked
                    />
                    <span class="checkbox-custom"></span>
                    <strong>√çndice de Atratividade</strong>
                  </label>
                </div>
                <div class="graph-regions">
                  <p class="graph-description">
                    Selecione at√© 6 regi√µes para comparar:
                  </p>
                  <div class="region-chips">
                    <label class="chip-label"
                      ><input
                        type="checkbox"
                        name="atratividade-region"
                        value="zona-sul"
                        checked
                      /><span class="chip">Zona Sul</span></label
                    >
                    <label class="chip-label"
                      ><input
                        type="checkbox"
                        name="atratividade-region"
                        value="zona-leste"
                        checked
                      /><span class="chip">Zona Leste</span></label
                    >
                    <label class="chip-label"
                      ><input
                        type="checkbox"
                        name="atratividade-region"
                        value="abc"
                        checked
                      /><span class="chip">ABC Paulista</span></label
                    >
                    <label class="chip-label"
                      ><input
                        type="checkbox"
                        name="atratividade-region"
                        value="campinas"
                        checked
                      /><span class="chip">Campinas</span></label
                    >
                    <label class="chip-label"
                      ><input
                        type="checkbox"
                        name="atratividade-region"
                        value="santos"
                        checked
                      /><span class="chip">Santos</span></label
                    >
                    <label class="chip-label"
                      ><input
                        type="checkbox"
                        name="atratividade-region"
                        value="ribeirao"
                        checked
                      /><span class="chip">Ribeir√£o Preto</span></label
                    >
                    <label class="chip-label"
                      ><input
                        type="checkbox"
                        name="atratividade-region"
                        value="itaquera"
                      /><span class="chip">Itaquera</span></label
                    >
                    <label class="chip-label"
                      ><input
                        type="checkbox"
                        name="atratividade-region"
                        value="zona-oeste"
                      /><span class="chip">Zona Oeste</span></label
                    >
                    <label class="chip-label"
                      ><input
                        type="checkbox"
                        name="atratividade-region"
                        value="zona-norte"
                      /><span class="chip">Zona Norte</span></label
                    >
                    <label class="chip-label"
                      ><input
                        type="checkbox"
                        name="atratividade-region"
                        value="centro"
                      /><span class="chip">Centro</span></label
                    >
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>

        <div class="modal-footer">
          <button class="btn-secondary" onclick="restaurarPadroes()">
            üîÑ Restaurar Padr√µes
          </button>
          <div class="modal-footer-actions">
            <button class="btn-cancel" onclick="fecharEditarFiltros()">
              Cancelar
            </button>
            <button class="btn-primary" onclick="salvarFiltro()">
              üíæ Salvar Filtro
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let filtroAtualId = null;
      let usuarioLogado = null;
      let pibRegionalChartInstance = null;
      let valorAdicionadoChartInstance = null;
      let atratividadeChartInstance = null;
      let zonasDisponiveis = [];

      const zonasMapeamento = {
        "grande-sp": 1,
        interior: 2,
        litoral: 3,
        itaquera: 4,
        "zona-sul": 5,
        "zona-leste": 6,
        "zona-oeste": 7,
        "zona-norte": 8,
        abc: 9,
        campinas: 10,
        santos: 3,
        ribeirao: 2,
        centro: 1,
      };

      const labelsKPIs = {
        "pib-sp": "PIB Estado de SP",
        "pib-itaquera": "PIB - Itaquera",
        "pib-zonasul": "PIB - Zona Sul",
        "pib-zonaleste": "PIB - Zona Leste",
        "pib-zonaoeste": "PIB - Zona Oeste",
        "pib-zonanorte": "PIB - Zona Norte",
        "pib-abc": "PIB - ABC Paulista",
        construcao: "Valor Adicionado - Constru√ß√£o",
        servicos: "Valor Adicionado - Servi√ßos",
        selic: "Taxa Selic",
        inflacao: "Taxa de Infla√ß√£o (IPCA)",
        "faixa-etaria": "Faixa Et√°ria Predominante",
        densidade: "Densidade Demogr√°fica",
        "renda-media": "Renda M√©dia",
      };

      const labelsRegioes = {
        "grande-sp": "Grande SP",
        interior: "Interior",
        litoral: "Litoral",
        itaquera: "Itaquera",
        "zona-sul": "Zona Sul",
        "zona-leste": "Zona Leste",
        "zona-oeste": "Zona Oeste",
        "zona-norte": "Zona Norte",
        abc: "ABC Paulista",
        campinas: "Campinas",
        santos: "Santos",
        ribeirao: "Ribeir√£o Preto",
        centro: "Centro",
      };

      const labelsSetores = {
        construcao: "Constru√ß√£o Civil",
        servicos: "Servi√ßos",
      };

      const CORES_GRAFICOS = {
        primarias: [
          "#059669",
          "#10b981",
          "#047857",
          "#34d399",
          "#065f46",
          "#6ee7b7",
        ],
        setores: {
          construcao: "#059669",
          servicos: "#10b981",
        },
        fundos: [
          "rgba(5, 150, 105, 0.15)",
          "rgba(16, 185, 129, 0.15)",
          "rgba(4, 120, 87, 0.15)",
          "rgba(52, 211, 153, 0.15)",
          "rgba(6, 95, 70, 0.15)",
          "rgba(110, 231, 183, 0.15)",
        ],
      };

      async function carregarDadosUsuarioLogado() {
        if (!usuarioLogado || !usuarioLogado.idUsuario) {
          console.error(" Usu√°rio n√£o est√° logado!");
          return;
        }

        try {
          const response = await fetch(
            `/usuarios/obterDados/${usuarioLogado.idUsuario}`
          );

          if (!response.ok) {
            throw new Error("Erro ao carregar dados do usu√°rio");
          }

          const dados = await response.json();
          console.log(" Dados do usu√°rio carregados:", dados);

          document.getElementById("nomeUsuario").textContent =
            dados.nome || "Usu√°rio";

          document.getElementById("nomeEmpresa").textContent =
            dados.nomeFantasia || "Empresa";

          const iniciais = gerarIniciais(dados.nomeFantasia);
          document.getElementById("avatarEmpresa").textContent = iniciais;
        } catch (erro) {
          console.error(" Erro ao carregar dados do usu√°rio:", erro);
          document.getElementById("nomeUsuario").textContent =
            "Erro ao carregar";
          document.getElementById("nomeEmpresa").textContent =
            "Erro ao carregar";
        }
      }

      function gerarIniciais(nomeEmpresa) {
        if (!nomeEmpresa) return "US";

        const palavras = nomeEmpresa.trim().split(" ");

        if (palavras.length === 1) {
          return palavras[0].substring(0, 2).toUpperCase();
        }

        return (
          palavras[0][0] + palavras[palavras.length - 1][0]
        ).toUpperCase();
      }

      document.addEventListener("DOMContentLoaded", function () {
        usuarioLogado = JSON.parse(
          sessionStorage.getItem("USUARIO_LOGADO") || "{}"
        );

        if (!usuarioLogado || !usuarioLogado.idUsuario) {
          alert("‚ö†Ô∏è Usu√°rio n√£o autenticado!  Redirecionando para login...");
          window.location.href = "login.html";
          return;
        }

        if (usuarioLogado.nome) {
          document.getElementById("nomeUsuario").textContent =
            usuarioLogado.nome;
        }

        carregarDadosUsuarioLogado();

        console.log("üë§ Usu√°rio logado:", usuarioLogado);

        inicializarGraficos();

        carregarZonasDisponiveis().then(() => {
          aplicarFiltroAtivo();
        });

        configurarLimitesRegioes();
        configurarEventosModais();
      });

      function logout() {
        if (confirm("‚ö†Ô∏è Tem certeza que deseja sair? ")) {
          sessionStorage.removeItem("USUARIO_LOGADO");
          window.location.href = "../index.html";
        }
      }

      async function carregarZonasDisponiveis() {
        try {
          const response = await fetch("/dados/zonas");
          if (response.ok) {
            zonasDisponiveis = await response.json();
            console.log("üìç Zonas carregadas:", zonasDisponiveis);
          }
        } catch (erro) {
          console.error("Erro ao carregar zonas:", erro);
        }
      }

      async function buscarDadosDashboard(idsZonas) {
        try {
          const zonesParam = idsZonas.join(",");
          const response = await fetch(`/dados/dashboard?zonas=${zonesParam}`);
          if (!response.ok)
            throw new Error("Erro ao buscar dados da dashboard");
          const dados = await response.json();
          console.log("üìä Dados recebidos:", dados);
          return dados;
        } catch (erro) {
          console.error("Erro ao buscar dados:", erro);
          return null;
        }
      }

      async function buscarAtratividade(idsZonas) {
        try {
          const zonesParam = idsZonas.join(",");
          const response = await fetch(
            `/dados/atratividade?zonas=${zonesParam}`
          );
          if (!response.ok) throw new Error("Erro ao buscar atratividade");
          return await response.json();
        } catch (erro) {
          console.error("Erro ao buscar atratividade:", erro);
          return [];
        }
      }

      async function buscarDemografia(idZona) {
        try {
          const response = await fetch(`/dados/demografia/${idZona}`);
          if (!response.ok) throw new Error("Erro ao buscar demografia");
          return await response.json();
        } catch (erro) {
          console.error("Erro ao buscar demografia:", erro);
          return null;
        }
      }

      function inicializarGraficos() {
        const defaultOptions = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: "#065f46",
              titleColor: "#ecfdf5",
              bodyColor: "#d1fae5",
              padding: 14,
              cornerRadius: 10,
              displayColors: true,
              boxPadding: 6,
              titleFont: { size: 13, weight: "600" },
              bodyFont: { size: 12 },
              borderColor: "#10b981",
              borderWidth: 1,
            },
          },
          scales: {
            x: {
              grid: {
                display: false,
              },
              ticks: {
                color: "#6b7280",
                font: { size: 11, weight: "500" },
              },
              border: {
                display: false,
              },
            },
            y: {
              grid: {
                color: "rgba(5, 150, 105, 0.1)",
                drawBorder: false,
                lineWidth: 1,
              },
              ticks: {
                color: "#6b7280",
                font: { size: 11, weight: "500" },
              },
              border: {
                display: false,
              },
            },
          },
        };

        pibRegionalChartInstance = new Chart(
          document.getElementById("pibRegionalChart"),
          {
            type: "line",
            data: {
              labels: [
                "Q1 2023",
                "Q2 2023",
                "Q3 2023",
                "Q4 2023",
                "Q1 2024",
                "Q2 2024",
                "Q3 2024",
                "Q4 2024",
              ],
              datasets: [],
            },
            options: {
              ...defaultOptions,
              interaction: { intersect: false, mode: "index" },
              scales: {
                ...defaultOptions.scales,
                y: {
                  ...defaultOptions.scales.y,
                  ticks: {
                    ...defaultOptions.scales.y.ticks,
                    callback: (v) => `${v}%`,
                  },
                },
              },
            },
          }
        );

        valorAdicionadoChartInstance = new Chart(
          document.getElementById("valorAdicionadoChart"),
          {
            type: "bar",
            data: {
              labels: ["Q1 23", "Q2 23", "Q3 23", "Q4 23", "Q1 24", "Q2 24"],
              datasets: [],
            },
            options: {
              ...defaultOptions,
              scales: {
                ...defaultOptions.scales,
                y: {
                  ...defaultOptions.scales.y,
                  beginAtZero: true,
                  ticks: {
                    ...defaultOptions.scales.y.ticks,
                    callback: (v) => v.toLocaleString(),
                  },
                },
              },
            },
          }
        );

        atratividadeChartInstance = new Chart(
          document.getElementById("atratividadeChart"),
          {
            type: "bar",
            data: {
              labels: [],
              datasets: [
                {
                  label: "Score",
                  data: [],
                  backgroundColor: [],
                  borderRadius: 8,
                  borderSkipped: false,
                },
              ],
            },
            options: {
              ...defaultOptions,
              indexAxis: "y",
              scales: {
                x: {
                  ...defaultOptions.scales.x,
                  max: 100,
                  grid: {
                    color: "rgba(5, 150, 105, 0.1)",
                    drawBorder: false,
                  },
                },
                y: {
                  ...defaultOptions.scales.y,
                  grid: { display: false },
                },
              },
            },
          }
        );
      }

      async function atualizarDashboardComFiltro(config) {
        console.log("üîÑ Atualizando dashboard com:", config);

        const idsZonas = config.graficos.pib.regioes
          .map((r) => zonasMapeamento[r])
          .filter((id) => id);

        const dadosBanco = await buscarDadosDashboard(
          idsZonas.length > 0 ? idsZonas : [1, 2, 3]
        );

        if (dadosBanco) {
          await atualizarKPIs(config, dadosBanco);

          if (
            config.graficos.pib.enabled &&
            config.graficos.pib.regioes.length > 0
          ) {
            await atualizarGraficoPIB(config.graficos.pib.regioes, dadosBanco);
            document.querySelector(".chart-card:nth-child(1)").style.display =
              "flex";
          } else {
            document.querySelector(".chart-card:nth-child(1)").style.display =
              "none";
          }

          if (
            config.graficos.setor.enabled &&
            config.graficos.setor.setores.length > 0
          ) {
            await atualizarGraficoSetores(
              config.graficos.setor.setores,
              dadosBanco
            );
            document.querySelector(".chart-card:nth-child(2)").style.display =
              "flex";
          } else {
            document.querySelector(".chart-card:nth-child(2)").style.display =
              "none";
          }

          if (
            config.graficos.atratividade.enabled &&
            config.graficos.atratividade.regioes.length > 0
          ) {
            await atualizarGraficoAtratividade(
              config.graficos.atratividade.regioes
            );
            document.querySelector(".chart-card:nth-child(3)").style.display =
              "flex";
          } else {
            document.querySelector(".chart-card:nth-child(3)").style.display =
              "none";
          }
        }

        console.log(" Dashboard atualizada!");
      }

      async function atualizarKPIs(config, dadosBanco) {
        const kpiCards = document.querySelectorAll(".kpi-card");

        if (config.kpis.economico.enabled) {
          kpiCards[0].style.display = "flex";
          kpiCards[0].querySelector(".kpi-label").textContent =
            labelsKPIs[config.kpis.economico.value];

          if (dadosBanco.pib && dadosBanco.pib.length > 0) {
            const pibMedio =
              dadosBanco.pib.reduce(
                (acc, item) => acc + parseFloat(item.valor || 0),
                0
              ) / dadosBanco.pib.length;
            kpiCards[0].querySelector(
              ".kpi-value"
            ).innerHTML = `+${pibMedio.toFixed(
              1
            )}<span class="kpi-unit">%</span>`;
          }
        } else {
          kpiCards[0].style.display = "none";
        }

        if (config.kpis.setor.enabled) {
          kpiCards[1].style.display = "flex";
          kpiCards[1].querySelector(".kpi-label").textContent =
            labelsKPIs[config.kpis.setor.value];

          if (
            config.kpis.setor.value === "construcao" &&
            dadosBanco.construcaoAtual
          ) {
            const valor = parseFloat(dadosBanco.construcaoAtual.valorPib || 0);
            kpiCards[1].querySelector(
              ".kpi-value"
            ).innerHTML = `+${valor.toFixed(1)}<span class="kpi-unit">%</span>`;
          } else if (
            config.kpis.setor.value === "servicos" &&
            dadosBanco.servicosAtual
          ) {
            const valor = parseFloat(
              dadosBanco.servicosAtual.valorServico || 0
            );
            kpiCards[1].querySelector(
              ".kpi-value"
            ).innerHTML = `+${valor.toFixed(1)}<span class="kpi-unit">%</span>`;
          }
        } else {
          kpiCards[1].style.display = "none";
        }

        if (config.kpis.financeiro.enabled) {
          kpiCards[2].style.display = "flex";
          kpiCards[2].querySelector(".kpi-label").textContent =
            labelsKPIs[config.kpis.financeiro.value];

          if (config.kpis.financeiro.value === "selic" && dadosBanco.selic) {
            const valor = parseFloat(dadosBanco.selic.valorTaxa || 0);
            kpiCards[2].querySelector(
              ".kpi-value"
            ).innerHTML = `${valor.toFixed(2)}<span class="kpi-unit">%</span>`;
            kpiCards[2].querySelector(".kpi-description").textContent =
              "Taxa b√°sica de juros";
          } else if (
            config.kpis.financeiro.value === "inflacao" &&
            dadosBanco.inflacao
          ) {
            const valor = parseFloat(dadosBanco.inflacao.valorTaxa || 0);
            kpiCards[2].querySelector(
              ".kpi-value"
            ).innerHTML = `${valor.toFixed(2)}<span class="kpi-unit">%</span>`;
            kpiCards[2].querySelector(".kpi-description").textContent =
              "√çndice IPCA";
          }
        } else {
          kpiCards[2].style.display = "none";
        }

        if (config.kpis.demo.enabled) {
          kpiCards[3].style.display = "flex";
          kpiCards[3].querySelector(".kpi-label").textContent =
            labelsKPIs[config.kpis.demo.value];

          const primeiraZona = config.graficos.pib.regioes[0];
          const idZona = zonasMapeamento[primeiraZona];

          if (idZona) {
            const demografia = await buscarDemografia(idZona);
            if (demografia) {
              if (config.kpis.demo.value === "faixa-etaria") {
                const idade = parseFloat(demografia.idadeMedia || 0);
                kpiCards[3].querySelector(
                  ".kpi-value"
                ).innerHTML = `${Math.round(
                  idade
                )}<span class="kpi-unit">Anos</span>`;
                kpiCards[3].querySelector(".kpi-description").textContent =
                  "Idade m√©dia";
              } else if (config.kpis.demo.value === "densidade") {
                const densidade = parseFloat(
                  demografia.densidadeDemografico || 0
                );
                kpiCards[3].querySelector(
                  ".kpi-value"
                ).innerHTML = `${densidade.toFixed(
                  0
                )}<span class="kpi-unit">hab/km¬≤</span>`;
                kpiCards[3].querySelector(".kpi-description").textContent =
                  "Densidade demogr√°fica";
              } else if (config.kpis.demo.value === "renda-media") {
                kpiCards[3].querySelector(
                  ".kpi-value"
                ).innerHTML = `R$ 4,2<span class="kpi-unit">mil</span>`;
                kpiCards[3].querySelector(".kpi-description").textContent =
                  "Renda m√©dia mensal";
              }
            }
          }
        } else {
          kpiCards[3].style.display = "none";
        }
      }

      async function atualizarGraficoPIB(regioes, dadosBanco) {
        const dadosPorZona = {};
        if (dadosBanco.pib) {
          dadosBanco.pib.forEach((item) => {
            if (!dadosPorZona[item.zona_nome])
              dadosPorZona[item.zona_nome] = [];
            dadosPorZona[item.zona_nome].push(parseFloat(item.valor || 0));
          });
        }

        const datasets = regioes.map((regiao, index) => {
          const nomeZona = labelsRegioes[regiao];
          let dados = dadosPorZona[nomeZona] || [
            3.2, 3.5, 3.7, 4.1, 3.9, 4.3, 4.5, 4.7,
          ];
          while (dados.length < 8) dados.push(dados[dados.length - 1] || 0);

          return {
            label: nomeZona,
            data: dados.slice(0, 8),
            borderColor: CORES_GRAFICOS.primarias[index],
            backgroundColor: CORES_GRAFICOS.fundos[index],
            tension: 0.4,
            fill: true,
            borderWidth: 3,
            pointRadius: 5,
            pointHoverRadius: 8,
            pointBackgroundColor: CORES_GRAFICOS.primarias[index],
            pointBorderColor: "#fff",
            pointBorderWidth: 2,
          };
        });

        pibRegionalChartInstance.data.datasets = datasets;

        const legendContainer = document.querySelector(
          ".chart-card:nth-child(1) .chart-legend"
        );
        legendContainer.innerHTML = regioes
          .map(
            (r, i) =>
              `<span class="legend-item"><span class="dot" style="background:${CORES_GRAFICOS.primarias[i]}"></span>${labelsRegioes[r]}</span>`
          )
          .join("");

        pibRegionalChartInstance.update();
      }

      async function atualizarGraficoSetores(setores, dadosBanco) {
        const setoresValidos = setores.filter(
          (s) => s === "construcao" || s === "servicos"
        );

        const datasets = setoresValidos.map((setor) => {
          let dados = [];
          let labels = [];

          if (
            setor === "construcao" &&
            dadosBanco.pibConstrucao &&
            dadosBanco.pibConstrucao.length > 0
          ) {
            dados = dadosBanco.pibConstrucao.map((item) =>
              parseFloat(item.valorPib || 0)
            );
            labels = dadosBanco.pibConstrucao.map(
              (item) => `${item.trimestre} ${item.ano}`
            );
          } else if (
            setor === "servicos" &&
            dadosBanco.pibServicos &&
            dadosBanco.pibServicos.length > 0
          ) {
            dados = dadosBanco.pibServicos.map((item) =>
              parseFloat(item.valorServico || 0)
            );
            labels = dadosBanco.pibServicos.map(
              (item) => `${item.trimestre} ${item.ano}`
            );
          }

          if (dados.length === 0) {
            dados = [4500, 4800, 5100, 5300, 5600, 5900];
            labels = ["Q1 23", "Q2 23", "Q3 23", "Q4 23", "Q1 24", "Q2 24"];
          }

          valorAdicionadoChartInstance.data.labels = labels.slice(0, 6);

          return {
            label: labelsSetores[setor],
            data: dados.slice(0, 6),
            backgroundColor: CORES_GRAFICOS.setores[setor],
            borderColor: CORES_GRAFICOS.setores[setor],
            borderWidth: 0,
            borderRadius: 6,
            borderSkipped: false,
          };
        });

        valorAdicionadoChartInstance.data.datasets = datasets;

        const legendContainer = document.querySelector(
          ".chart-card:nth-child(2) .chart-legend"
        );
        legendContainer.innerHTML = setoresValidos
          .map(
            (s) =>
              `<span class="legend-item"><span class="dot" style="background:${CORES_GRAFICOS.setores[s]}"></span>${labelsSetores[s]}</span>`
          )
          .join("");

        valorAdicionadoChartInstance.update();
      }

      async function atualizarGraficoAtratividade(regioes) {
        const idsZonas = regioes
          .map((r) => zonasMapeamento[r])
          .filter((id) => id);
        const dadosAtratividade = await buscarAtratividade(idsZonas);

        let labels = [];
        let data = [];

        if (dadosAtratividade && dadosAtratividade.length > 0) {
          labels = dadosAtratividade.map((item) => item.nome);
          data = dadosAtratividade.map((item) =>
            Math.min(100, Math.round(parseFloat(item.score || 0)))
          );
        } else {
          labels = regioes.map((r) => labelsRegioes[r]);
          data = [82, 75, 88, 79, 71, 76].slice(0, regioes.length);
        }

        const backgroundColor = data.map((score) => {
          if (score >= 80) return "#047857";
          if (score >= 70) return "#059669";
          if (score >= 60) return "#10b981";
          if (score >= 50) return "#34d399";
          if (score >= 40) return "#6ee7b7";
          return "#a7f3d0";
        });

        atratividadeChartInstance.data.labels = labels;
        atratividadeChartInstance.data.datasets[0].data = data;
        atratividadeChartInstance.data.datasets[0].backgroundColor =
          backgroundColor;
        atratividadeChartInstance.update();
      }

      async function carregarFiltros() {
        try {
          const response = await fetch(
            `/filtros/listar/${usuarioLogado.idUsuario}`
          );
          if (response.status === 204) return await criarFiltroPadrao();
          if (!response.ok) throw new Error("Erro ao carregar filtros");
          return await response.json();
        } catch (erro) {
          console.error("Erro ao carregar filtros:", erro);
          return [
            {
              idfiltroUsuario: "default",
              nomeFiltro: "üìå Filtro Padr√£o",
              ativo: true,
              config: getConfigPadrao(),
            },
          ];
        }
      }

      async function criarFiltroPadrao() {
        try {
          const response = await fetch("/filtros/criar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              idUserServer: usuarioLogado.idUsuario,
              nomeServer: "üìå Filtro Padr√£o",
              configServer: getConfigPadrao(),
            }),
          });
          if (response.ok) {
            const resultado = await response.json();
            if (resultado.insertId) await ativarFiltro(resultado.insertId);
          }
          return await carregarFiltros();
        } catch (erro) {
          console.error("Erro ao criar filtro padr√£o:", erro);
          return [
            {
              idfiltroUsuario: "default",
              nomeFiltro: "üìå Filtro Padr√£o",
              ativo: true,
              config: getConfigPadrao(),
            },
          ];
        }
      }

      async function buscarFiltroAtivo() {
        try {
          const response = await fetch(
            `/filtros/ativo/${usuarioLogado.idUsuario}`
          );
          if (response.status === 204) return null;
          if (!response.ok) throw new Error("Erro ao buscar filtro ativo");
          return await response.json();
        } catch (erro) {
          console.error("Erro ao buscar filtro ativo:", erro);
          return null;
        }
      }

      async function aplicarFiltroAtivo() {
        const filtroAtivo = await buscarFiltroAtivo();
        if (!filtroAtivo) {
          console.log("‚ö†Ô∏è Nenhum filtro ativo, aplicando padr√£o");
          await atualizarDashboardComFiltro(getConfigPadrao());
          return;
        }

        let config = filtroAtivo.config;
        if (typeof config === "string") config = JSON.parse(config);
        await atualizarDashboardComFiltro(config);
      }

      function getConfigPadrao() {
        return {
          kpis: {
            economico: { enabled: true, value: "pib-sp" },
            setor: { enabled: true, value: "construcao" },
            financeiro: { enabled: true, value: "selic" },
            demo: { enabled: true, value: "faixa-etaria" },
          },
          graficos: {
            pib: {
              enabled: true,
              regioes: ["grande-sp", "interior", "litoral"],
            },
            setor: { enabled: true, setores: ["construcao", "servicos"] },
            atratividade: {
              enabled: true,
              regioes: [
                "zona-sul",
                "zona-leste",
                "abc",
                "campinas",
                "santos",
                "ribeirao",
              ],
            },
          },
        };
      }

      async function abrirGerenciarFiltros() {
        await renderizarFiltrosSalvos();
        document
          .getElementById("gerenciarFiltrosModal")
          .classList.add("active");
        document.body.style.overflow = "hidden";
      }

      function fecharGerenciarFiltros() {
        document
          .getElementById("gerenciarFiltrosModal")
          .classList.remove("active");
        document.body.style.overflow = "";
      }

      function fecharEditarFiltros() {
        document
          .getElementById("editarFiltrosModal")
          .classList.remove("active");
        document.body.style.overflow = "";
        filtroAtualId = null;
      }

      async function renderizarFiltrosSalvos() {
        const filtros = await carregarFiltros();
        const container = document.getElementById("filtrosSalvosList");

        container.innerHTML = filtros
          .map((filtro) => {
            let config = filtro.config;
            if (typeof config === "string") config = JSON.parse(config);

            const ehFiltroPadrao = filtro.nomeFiltro.includes("Filtro Padr√£o");

            return `
              <div class="filtro-item ${filtro.ativo ? "ativo" : ""}">
                <div class="filtro-info">
                  <div class="filtro-header">
                    <span class="filtro-nome">${filtro.nomeFiltro}</span>
                    ${
                      filtro.ativo
                        ? '<span class="badge-ativo">‚úì Ativo</span>'
                        : ""
                    }
                    ${
                      ehFiltroPadrao
                        ? '<span class="badge-padrao">üîí Sistema</span>'
                        : ""
                    }
                  </div>
                  <span class="filtro-detalhes">${getResumoFiltro(
                    config
                  )}</span>
                </div>
                <div class="filtro-actions">
                  ${
                    !filtro.ativo
                      ? `<button class="btn-action btn-ativar" onclick="ativarFiltro(${filtro.idfiltroUsuario})" title="Ativar">‚úì</button>`
                      : ""
                  }
                  ${
                    !ehFiltroPadrao
                      ? `<button class="btn-action btn-editar" onclick="editarFiltro(${filtro.idfiltroUsuario})" title="Editar">‚úèÔ∏è</button>`
                      : ""
                  }
                  ${
                    !ehFiltroPadrao
                      ? `<button class="btn-action btn-deletar" onclick="deletarFiltro(${filtro.idfiltroUsuario})" title="Excluir">üóëÔ∏è</button>`
                      : ""
                  }
                </div>
              </div>
            `;
          })
          .join("");
      }

      function getResumoFiltro(config) {
        const kpisAtivos = Object.values(config.kpis).filter(
          (k) => k.enabled
        ).length;
        const graficosAtivos = Object.values(config.graficos).filter(
          (g) => g.enabled
        ).length;
        return `${kpisAtivos} KPIs ‚Ä¢ ${graficosAtivos} Gr√°ficos`;
      }

      function criarNovoFiltro() {
        filtroAtualId = null;
        document.getElementById("filtroNome").value = "";
        document.getElementById("modalTitle").textContent =
          "‚ûï Criar Novo Filtro";
        carregarConfigNoModal(getConfigPadrao());
        fecharGerenciarFiltros();
        document.getElementById("editarFiltrosModal").classList.add("active");
      }

      async function editarFiltro(id) {
        const filtros = await carregarFiltros();
        const filtro = filtros.find((f) => f.idfiltroUsuario === id);

        if (!filtro) return;

        if (filtro.nomeFiltro.includes("Filtro Padr√£o")) {
          alert(
            "‚ö†Ô∏è O Filtro Padr√£o n√£o pode ser editado!\n\nCrie um novo filtro personalizado."
          );
          return;
        }

        filtroAtualId = id;
        document.getElementById("filtroNome").value = filtro.nomeFiltro
          .replace(/[üìå‚úèÔ∏è‚ûï]/g, "")
          .trim();
        document.getElementById("modalTitle").textContent = "‚úèÔ∏è Editar Filtro";

        let config = filtro.config;
        if (typeof config === "string") config = JSON.parse(config);

        carregarConfigNoModal(config);
        fecharGerenciarFiltros();
        document.getElementById("editarFiltrosModal").classList.add("active");
      }

      async function ativarFiltro(id) {
        try {
          const response = await fetch(`/filtros/ativar/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ idUserServer: usuarioLogado.idUsuario }),
          });

          if (!response.ok) throw new Error("Erro ao ativar filtro");

          await aplicarFiltroAtivo();
          await renderizarFiltrosSalvos();

          const filtros = await carregarFiltros();
          const filtro = filtros.find((f) => f.idfiltroUsuario === id);
          mostrarToast(`‚úì Filtro "${filtro?.nomeFiltro}" ativado! `);
        } catch (erro) {
          console.error("Erro ao ativar filtro:", erro);
          alert(" Erro ao ativar filtro.");
        }
      }

      async function deletarFiltro(id) {
        const filtros = await carregarFiltros();
        const filtro = filtros.find((f) => f.idfiltroUsuario === id);

        if (!filtro) return;

        if (filtro.nomeFiltro.includes("Filtro Padr√£o")) {
          alert("‚ö†Ô∏è O Filtro Padr√£o n√£o pode ser exclu√≠do!");
          return;
        }

        if (
          !confirm(
            `‚ö†Ô∏è Excluir o filtro "${filtro.nomeFiltro}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`
          )
        )
          return;

        try {
          const response = await fetch(
            `/filtros/deletar/${id}/${usuarioLogado.idUsuario}`,
            {
              method: "DELETE",
            }
          );

          if (!response.ok) throw new Error("Erro ao deletar filtro");

          await renderizarFiltrosSalvos();
          await aplicarFiltroAtivo();
          mostrarToast(" Filtro exclu√≠do!");
        } catch (erro) {
          console.error("Erro ao deletar filtro:", erro);
          alert(" Erro ao deletar filtro.");
        }
      }

      async function salvarFiltro() {
        const nome = document.getElementById("filtroNome").value.trim();

        if (!nome) {
          alert("‚ö†Ô∏è Digite um nome para o filtro!");
          document.getElementById("filtroNome").focus();
          return;
        }

        const config = getConfigDoModal();

        try {
          if (filtroAtualId) {
            const response = await fetch(
              `/filtros/atualizar/${filtroAtualId}`,
              {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  idUserServer: usuarioLogado.idUsuario,
                  nomeServer: nome,
                  configServer: config,
                }),
              }
            );
            if (!response.ok) throw new Error("Erro ao atualizar filtro");
            mostrarToast(" Filtro atualizado!");
          } else {
            const response = await fetch("/filtros/criar", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                idUserServer: usuarioLogado.idUsuario,
                nomeServer: nome,
                configServer: config,
              }),
            });
            if (!response.ok) throw new Error("Erro ao criar filtro");
            mostrarToast(" Novo filtro criado!");
          }

          fecharEditarFiltros();
          await abrirGerenciarFiltros();
        } catch (erro) {
          console.error("Erro ao salvar filtro:", erro);
          alert(" Erro ao salvar filtro.");
        }
      }

      function carregarConfigNoModal(config) {
        document.getElementById("kpi-economico-enable").checked =
          config.kpis.economico.enabled;
        document.getElementById("kpi-economico").value =
          config.kpis.economico.value;
        document.getElementById("kpi-setor-enable").checked =
          config.kpis.setor.enabled;
        document.getElementById("kpi-setor").value = config.kpis.setor.value;
        document.getElementById("kpi-financeiro-enable").checked =
          config.kpis.financeiro.enabled;
        document.getElementById("kpi-financeiro").value =
          config.kpis.financeiro.value;
        document.getElementById("kpi-demo-enable").checked =
          config.kpis.demo.enabled;
        document.getElementById("kpi-demo").value = config.kpis.demo.value;

        document.getElementById("grafico-pib-enable").checked =
          config.graficos.pib.enabled;
        document.querySelectorAll('input[name="pib-region"]').forEach((cb) => {
          cb.checked = config.graficos.pib.regioes.includes(cb.value);
        });

        document.getElementById("grafico-setor-enable").checked =
          config.graficos.setor.enabled;
        document.querySelectorAll('input[name="setor"]').forEach((cb) => {
          cb.checked = config.graficos.setor.setores.includes(cb.value);
        });

        document.getElementById("grafico-atratividade-enable").checked =
          config.graficos.atratividade.enabled;
        document
          .querySelectorAll('input[name="atratividade-region"]')
          .forEach((cb) => {
            cb.checked = config.graficos.atratividade.regioes.includes(
              cb.value
            );
          });
      }

      function getConfigDoModal() {
        return {
          kpis: {
            economico: {
              enabled: document.getElementById("kpi-economico-enable").checked,
              value: document.getElementById("kpi-economico").value,
            },
            setor: {
              enabled: document.getElementById("kpi-setor-enable").checked,
              value: document.getElementById("kpi-setor").value,
            },
            financeiro: {
              enabled: document.getElementById("kpi-financeiro-enable").checked,
              value: document.getElementById("kpi-financeiro").value,
            },
            demo: {
              enabled: document.getElementById("kpi-demo-enable").checked,
              value: document.getElementById("kpi-demo").value,
            },
          },
          graficos: {
            pib: {
              enabled: document.getElementById("grafico-pib-enable").checked,
              regioes: Array.from(
                document.querySelectorAll('input[name="pib-region"]:checked')
              ).map((cb) => cb.value),
            },
            setor: {
              enabled: document.getElementById("grafico-setor-enable").checked,
              setores: Array.from(
                document.querySelectorAll('input[name="setor"]:checked')
              ).map((cb) => cb.value),
            },
            atratividade: {
              enabled: document.getElementById("grafico-atratividade-enable")
                .checked,
              regioes: Array.from(
                document.querySelectorAll(
                  'input[name="atratividade-region"]:checked'
                )
              ).map((cb) => cb.value),
            },
          },
        };
      }

      function restaurarPadroes() {
        if (confirm("üîÑ Restaurar configura√ß√µes padr√£o?")) {
          carregarConfigNoModal(getConfigPadrao());
          mostrarToast(" Configura√ß√µes restauradas!");
        }
      }

      function mostrarToast(mensagem) {
        const toast = document.createElement("div");
        toast.className = "toast-notification";
        toast.textContent = mensagem;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }

      function configurarLimitesRegioes() {
        document.querySelectorAll('input[name="pib-region"]').forEach((cb) => {
          cb.addEventListener("change", function () {
            if (
              document.querySelectorAll('input[name="pib-region"]:checked')
                .length > 3
            ) {
              this.checked = false;
              alert("‚ö†Ô∏è M√°ximo 3 regi√µes para PIB.");
            }
          });
        });

        document
          .querySelectorAll('input[name="atratividade-region"]')
          .forEach((cb) => {
            cb.addEventListener("change", function () {
              if (
                document.querySelectorAll(
                  'input[name="atratividade-region"]:checked'
                ).length > 6
              ) {
                this.checked = false;
                alert("‚ö†Ô∏è M√°ximo 6 regi√µes para Atratividade.");
              }
            });
          });
      }

      function configurarEventosModais() {
        document
          .getElementById("gerenciarFiltrosModal")
          ?.addEventListener("click", function (e) {
            if (e.target === this) fecharGerenciarFiltros();
          });

        document
          .getElementById("editarFiltrosModal")
          ?.addEventListener("click", function (e) {
            if (e.target === this) fecharEditarFiltros();
          });

        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            if (
              document
                .getElementById("editarFiltrosModal")
                ?.classList.contains("active")
            ) {
              fecharEditarFiltros();
            } else if (
              document
                .getElementById("gerenciarFiltrosModal")
                ?.classList.contains("active")
            ) {
              fecharGerenciarFiltros();
            }
          }
        });
      }
    </script>
  </body>
</html>
