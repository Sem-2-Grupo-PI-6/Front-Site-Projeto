<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Evolvere Invest - Minha Conta</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <link rel="stylesheet" href="../css/configUsuario.css" />
    <link rel="icon" href="../assets/icon/favicon.png" />
    <script src="../js/monitoramento.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <div class="logo">
          <a href="index.html">
            <img src="../imgs/Logo-projeto.png" alt="Evolvere Logo" />
          </a>
          <div class="brand-txt">
            <h1>Evolvere Invest</h1>
            <small>Decis√µes de investimento baseadas em dados</small>
          </div>
        </div>

        <nav>
          <ul class="nav-list">
            <li><a href="dashboardCliente.html">üìä Dashboard</a></li>
            <li>
              <a href="configUsuario.html" class="active">üë§ Minha Conta</a>
            </li>
            <li class="divider">|</li>
            <li><a onclick="logout()" class="btn-link">Sair</a></li>
          </ul>
        </nav>
      </div>
    </header>

    <main class="container main-content">
      <section class="profile-hero">
        <div class="profile-hero-content">
          <div class="profile-avatar-hero">SC</div>
          <div class="profile-hero-info">
            <h1>Sierra Capital</h1>
            <p class="profile-email">sierra@fundoinvest.com</p>
            <span class="badge-user">Fundo de Investimento</span>
          </div>
        </div>
        <div class="profile-stats">
        </div>
      </section>

      <!-- TABS DE CONFIGURA√á√ÉO -->
      <section class="config-tabs">
        <div class="tabs-header">
          <button class="tab-btn active" data-tab="profile">
            <span class="tab-icon">üë§</span>
            <span>Meu Perfil</span>
          </button>
          <button class="tab-btn" data-tab="security">
            <span class="tab-icon">üîí</span>
            <span>Seguran√ßa</span>
          </button>
          <button class="tab-btn" data-tab="preferences">
            <span class="tab-icon">‚öôÔ∏è</span>
            <span>Prefer√™ncias</span>
          </button>
        </div>

        <!-- TAB 1: MEU PERFIL -->
        <div class="tab-content active" id="tab-profile">
          <div class="card">
            <div class="card-header">
              <div>
                <h2>üë§ Informa√ß√µes Pessoais</h2>
                <p>Gerencie seus dados cadastrais</p>
              </div>
            </div>

            <form class="config-form">
              <div class="form-row">
                <div class="form-group">
                  <label for="profile-name">Nome Completo *</label>
                  <input
                    type="text"
                    id="profile-name"
                    value="Sierra Capital"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="profile-email">Email *</label>
                  <input
                    type="email"
                    id="profile-email"
                    value="sierra@fundoinvest.com"
                    disabled
                  />
                  <small class="form-hint"
                    >üìß Email n√£o pode ser alterado. Entre em contato com o
                    suporte.</small
                  >
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="profile-company">Empresa *</label>
                  <input
                    type="text"
                    id="profile-company"
                    value="Fundo de Investimento Sierra"
                    required
                  />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="profile-phone">Telefone</label>
                  <input
                    type="tel"
                    id="profile-phone"
                    placeholder="(11) 99999-9999"
                  />
                </div>
              </div>

              <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Importante:</strong> Mantenha seus dados atualizados
                para receber relat√≥rios e an√°lises personalizadas.
              </div>

              <div class="form-actions">
                <button type="button" class="btn-secondary">Cancelar</button>
                <button type="submit" class="btn-primary">
                  üíæ Salvar Altera√ß√µes
                </button>
              </div>
            </form>
          </div>
        </div>

        <div class="tab-content" id="tab-security">
          <div class="card">
            <div class="card-header">
              <div>
                <h2>üîí Seguran√ßa da Conta</h2>
                <p>Proteja sua conta com senha forte</p>
              </div>
            </div>

            <form class="config-form">
              <h3 class="section-title">üîë Alterar Senha</h3>

              <div class="security-info">
                <div class="security-item">
                  <span class="security-icon">‚úì</span>
                  <div class="security-content">
                    <strong>√öltima altera√ß√£o:</strong>
                    <p>15 de Outubro de 2024 √†s 14:32</p>
                  </div>
                </div>
                <div class="security-item">
                  <span class="security-icon">üõ°Ô∏è</span>
                  <div class="security-content">
                    <strong>For√ßa da senha atual:</strong>
                    <div class="password-strength">
                      <div class="strength-bar strong"></div>
                      <span class="strength-label">Forte</span>
                    </div>
                  </div>
                </div>
              </div>

<div class="form-group">
  <label for="security-current-password">Senha Atual *</label>
  <div class="password-input-wrapper">
    <input 
      type="password" 
      id="security-current-password" 
      placeholder="Digite sua senha atual" 
      autocomplete="current-password"
      required 
    />
    <button type="button" class="btn-toggle-password" onclick="togglePassword('security-current-password')">
      <img src="../imgs/olho.png" alt="Mostrar senha" class="icon-eye" />
      <img src="../imgs/mostrar.png" alt="Ocultar senha" class="icon-eye-off" style="display: none;" />
    </button>
  </div>
</div>

<!-- NOVA SENHA -->
<div class="form-group">
  <label for="security-new-password">Nova Senha *</label>
  <div class="password-input-wrapper">
    <input 
      type="password" 
      id="security-new-password" 
      placeholder="M√≠nimo 8 caracteres" 
      autocomplete="new-password"
      required 
    />
    <button type="button" class="btn-toggle-password" onclick="togglePassword('security-new-password')">
      <img src="../imgs/eye-open.png" alt="Mostrar senha" class="icon-eye" />
      <img src="../imgs/eye-closed.png" alt="Ocultar senha" class="icon-eye-off" style="display: none;" />
    </button>
  </div>
  <small class="form-hint">Use letras, n√∫meros e s√≠mbolos</small>
</div>

<!-- CONFIRMAR NOVA SENHA -->
<div class="form-group">
  <label for="security-confirm-password">Confirmar Nova Senha *</label>
  <div class="password-input-wrapper">
    <input 
      type="password" 
      id="security-confirm-password" 
      placeholder="Repita a nova senha" 
      autocomplete="new-password"
      required 
    />
    <button type="button" class="btn-toggle-password" onclick="togglePassword('security-confirm-password')">
      <img src="../imgs/eye-open.png" alt="Mostrar senha" class="icon-eye" />
      <img src="../imgs/eye-closed.png" alt="Ocultar senha" class="icon-eye-off" style="display: none;" />
    </button>
  </div>
</div>
</div>

              <div class="password-requirements">
                <h4>üìã Requisitos de Senha:</h4>
                <ul>
                  <li class="requirement" id="req-length">
                    M√≠nimo de 8 caracteres
                  </li>
                  <li class="requirement" id="req-uppercase">
                    Pelo menos 1 letra mai√∫scula
                  </li>
                  <li class="requirement" id="req-lowercase">
                    Pelo menos 1 letra min√∫scula
                  </li>
                  <li class="requirement" id="req-number">
                    Pelo menos 1 n√∫mero
                  </li>
                  <li class="requirement" id="req-special">
                    Pelo menos 1 caractere especial (!@#$%)
                  </li>
                </ul>
              </div>

              <div class="alert alert-warning">
                <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Ap√≥s alterar sua senha, voc√™ ser√°
                desconectado e precisar√° fazer login novamente.
              </div>

              <div class="form-actions">
                <button type="button" class="btn-secondary">Cancelar</button>
                <button type="submit" class="btn-primary">
                  üîí Alterar Senha
                </button>
              </div>
            </form>
          </div>

          </div>
        </div>

        <!-- TAB 3: PREFER√äNCIAS -->
        <div class="tab-content" id="tab-preferences">
          <div class="card">
            <div class="card-header">
              <div>
                <h2>‚öôÔ∏è Prefer√™ncias</h2>
                <p>Personalize sua experi√™ncia na plataforma</p>
              </div>
            </div>

            <form class="config-form">
              <h3 class="section-title">üîî Notifica√ß√µes</h3>

              <div class="toggle-item slack-config-item">
                <div class="toggle-info">
                  <strong>Notifica√ß√µes via Slack</strong>
                  <p>Configure alertas autom√°ticos para seu workspace Slack</p>
                </div>
                <button type="button" class="btn-config-slack" onclick="abrirModalSlack()">
                  ‚öôÔ∏è Configurar Slack
                </button>
              </div>

              <div class="form-actions">
                <button type="button" class="btn-secondary">
                  Restaurar Padr√µes
                </button>
                <button type="submit" class="btn-primary">
                  üíæ Salvar Prefer√™ncias
                </button>
              </div>
            </form>
          </div>
        </div>

        <div class="tab-content" id="tab-activity">
          <div class="card">
            <div class="card-header">
              <div>
                <h2>üìã Hist√≥rico de Atividades</h2>
                <p>Suas √∫ltimas a√ß√µes na plataforma</p>
              </div>
              <select class="filter-select">
                <option value="all">Todas as atividades</option>
                <option value="login">Logins</option>
                <option value="query">Consultas</option>
                <option value="config">Configura√ß√µes</option>
              </select>
            </div>

            <div class="activity-timeline">
              <div class="activity-item">
                <div class="activity-icon success">‚úì</div>
                <div class="activity-content">
                  <strong>Login realizado</strong>
                  <p>Acesso via Windows 11 - Chrome</p>
                  <span class="activity-time"
                    >H√° 5 minutos ‚Ä¢ S√£o Paulo, SP</span
                  >
                </div>
              </div>

              <div class="activity-item">
                <div class="activity-icon info">üìä</div>
                <div class="activity-content">
                  <strong>Consulta realizada</strong>
                  <p>An√°lise de PIB Regional - Grande SP</p>
                  <span class="activity-time">H√° 32 minutos</span>
                </div>
              </div>

              <div class="activity-item">
                <div class="activity-icon info">üìä</div>
                <div class="activity-content">
                  <strong>Relat√≥rio exportado</strong>
                  <p>Valor Adicionado - Constru√ß√£o Civil Q3 2024</p>
                  <span class="activity-time">H√° 1 hora</span>
                </div>
              </div>

              <div class="activity-item">
                <div class="activity-icon warning">‚öôÔ∏è</div>
                <div class="activity-content">
                  <strong>Configura√ß√µes alteradas</strong>
                  <p>Notifica√ß√µes por email ativadas</p>
                  <span class="activity-time">H√° 2 horas</span>
                </div>
              </div>

              <div class="activity-item">
                <div class="activity-icon success">‚úì</div>
                <div class="activity-content">
                  <strong>Login realizado</strong>
                  <p>Acesso via iPhone 13 - Safari</p>
                  <span class="activity-time">H√° 3 horas ‚Ä¢ S√£o Paulo, SP</span>
                </div>
              </div>

              <div class="activity-item">
                <div class="activity-icon info">üìä</div>
                <div class="activity-content">
                  <strong>Dashboard visualizado</strong>
                  <p>Cen√°rio Macroecon√¥mico - S√£o Paulo</p>
                  <span class="activity-time">Ontem √†s 16:45</span>
                </div>
              </div>

              <div class="activity-item">
                <div class="activity-icon info">üìä</div>
                <div class="activity-content">
                  <strong>Consulta realizada</strong>
                  <p>Taxa Selic e Impactos no Cr√©dito</p>
                  <span class="activity-time">Ontem √†s 15:22</span>
                </div>
              </div>
            </div>

            <div class="pagination">
              <button class="btn-pagination">‚Üê Anterior</button>
              <span class="pagination-info">Mostrando 7 de 42 atividades</span>
              <button class="btn-pagination">Pr√≥ximo ‚Üí</button>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <h2>üìà Estat√≠sticas de Uso</h2>
                <p>Seu engajamento na plataforma</p>
              </div>
            </div>

            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-icon">üîç</div>
                <div class="stat-value">342</div>
                <div class="stat-label">Consultas Realizadas</div>
                <div class="stat-trend positive">‚Üë 24% vs m√™s anterior</div>
              </div>

              <div class="stat-card">
                <div class="stat-icon">üì•</div>
                <div class="stat-value">18</div>
                <div class="stat-label">Relat√≥rios Exportados</div>
                <div class="stat-trend positive">‚Üë 12% vs m√™s anterior</div>
              </div>

              <div class="stat-card">
                <div class="stat-icon">‚è±Ô∏è</div>
                <div class="stat-value">12h</div>
                <div class="stat-label">Tempo na Plataforma</div>
                <div class="stat-trend neutral">‚Üí M√©dia mensal</div>
              </div>

              <div class="stat-card">
                <div class="stat-icon">üéØ</div>
                <div class="stat-value">8</div>
                <div class="stat-label">Regi√µes Analisadas</div>
                <div class="stat-trend positive">‚Üë 2 novas regi√µes</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- SUPORTE E AJUDA -->
      <section class="help-section">
        <div class="help-card">
          <div class="help-icon">‚ùì</div>
          <div class="help-content">
            <h3>Precisa de Ajuda?</h3>
            <p>Nossa equipe de suporte est√° pronta para te auxiliar</p>
            <a href="mailto:suporte@evolvereinvest.net" class="btn-help"
              >üìß Contatar Suporte</a
            >
          </div>
        </div>

        <div class="help-card">
          <div class="help-icon">üìö</div>
          <div class="help-content">
            <h3>Central de Ajuda</h3>
            <p>Tutoriais, guias e perguntas frequentes</p>
            <a href="#" class="btn-help">üìñ Acessar Documenta√ß√£o</a>
          </div>
        </div>
      </section>
    </main>

          <div class="modal-overlay" id="modalSlack">
        <div class="modal-container modal-slack">
          <div class="modal-header">
            <div>
              <h2>‚ö° Configurar Notifica√ß√µes Slack</h2>
              <p>Receba alertas importantes diretamente no seu workspace</p>
            </div>
            <button class="btn-close-modal" onclick="fecharModalSlack()">‚úï</button>
          </div>

          <div class="modal-body">
            <!-- SE√á√ÉO 1: ATIVAR/DESATIVAR SLACK -->
            <section class="modal-section">
              <div class="slack-master-toggle">
                <div class="slack-toggle-content">
                  <div class="slack-icon-big">üí¨</div>
                  <div>
                    <h3>Integra√ß√£o Slack</h3>
                    <p class="slack-status-text" id="slackStatusText">
                      Ative para receber notifica√ß√µes automatizadas sobre mudan√ßas nos indicadores econ√¥micos
                    </p>
                  </div>
                </div>
                <label class="toggle-switch toggle-switch-large">
                  <input type="checkbox" id="slackMasterToggle" onchange="toggleSlackMaster()" />
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </section>

            <section class="modal-section" id="slackCanaisSection">
              <h3 class="section-title">üì¢ Escolha os Canais de Notifica√ß√£o</h3>
              <p class="section-description">Selecione em quais canais voc√™ deseja receber alertas espec√≠ficos</p>

              <div class="slack-canais-grid">
                <div class="slack-canal-card">
                  <div class="canal-header">
                    <div class="canal-icon">üë•</div>
                    <label class="canal-checkbox">
                      <input 
                        type="checkbox" 
                        id="canalPopulacao" 
                        class="canal-toggle"
                        onchange="validarCanais()"
                      />
                      <span class="checkbox-custom-large"></span>
                    </label>
                  </div>
                  <div class="canal-content">
                    <h4>Crescimento Populacional</h4>
                    <p>Alertas sobre crescimento populacional, das regi√µes de S√£o Paulo</p>
                    <span class="canal-badge">Canal: #demografia</span>
                  </div>
                </div>

                <div class="slack-canal-card">
                  <div class="canal-header">
                    <div class="canal-icon">üí∞</div>
                    <label class="canal-checkbox">
                      <input 
                        type="checkbox" 
                        id="canalSelic" 
                        class="canal-toggle"
                        onchange="validarCanais()"
                      />
                      <span class="checkbox-custom-large"></span>
                    </label>
                  </div>
                  <div class="canal-content">
                    <h4>Taxa Selic</h4>
                    <p>Notifica√ß√µes sobre altera√ß√µes na taxa b√°sica de juros, impactando cr√©dito e investimentos imobili√°rios</p>
                    <span class="canal-badge">Canal: #economia</span>
                  </div>
                </div>

                <div class="slack-canal-card">
                  <div class="canal-header">
                    <div class="canal-icon">üìä</div>
                    <label class="canal-checkbox">
                      <input 
                        type="checkbox" 
                        id="canalPib" 
                        class="canal-toggle"
                        onchange="validarCanais()"
                      />
                      <span class="checkbox-custom-large"></span>
                    </label>
                  </div>
                  <div class="canal-content">
                    <h4>Crescimento do PIB</h4>
                    <p>Acompanhe varia√ß√µes trimestrais do PIB regional e setorial (constru√ß√£o civil, servi√ßos, imobili√°rio)</p>
                    <span class="canal-badge">Canal: #indicadores</span>
                  </div>
                </div>
              </div>

              <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Dica:</strong> Selecione pelo menos um canal para ativar as notifica√ß√µes do Slack.
              </div>
            </section>

            <section class="modal-section" id="slackGatilhosSection">
              <h3 class="section-title">üîî Defina os Gatilhos de Alerta</h3>
              <p class="section-description">Escolha a criticidade dos alertas que deseja receber</p>

              <div class="gatilhos-group">
                <div class="gatilho-item">
                  <label class="gatilho-label">
                    <input 
                      type="checkbox" 
                      id="gatilhoError" 
                      class="gatilho-toggle"
                      checked
                    />
                    <span class="checkbox-custom"></span>
                    <div class="gatilho-info">
                      <div class="gatilho-badge error">üö® CR√çTICO</div>
                      <strong>Alertas Cr√≠ticos</strong>
                      <p>Quedas bruscas (>5%) em PIB, Selic acima de 15%, ou popula√ß√£o reduzindo</p>
                    </div>
                  </label>
                </div>

                <div class="gatilho-item">
                  <label class="gatilho-label">
                    <input 
                      type="checkbox" 
                      id="gatilhoWarning" 
                      class="gatilho-toggle"
                      checked
                    />
                    <span class="checkbox-custom"></span>
                    <div class="gatilho-info">
                      <div class="gatilho-badge warning">‚ö†Ô∏è MODERADO</div>
                      <strong>Alertas Moderados</strong>
                      <p>Varia√ß√µes entre 2-5% no PIB, mudan√ßas na Selic entre 0.5-1%, flutua√ß√µes demogr√°ficas</p>
                    </div>
                  </label>
                </div>

                <div class="gatilho-item">
                  <label class="gatilho-label">
                    <input 
                      type="checkbox" 
                      id="gatilhoInfo" 
                      class="gatilho-toggle"
                    />
                    <span class="checkbox-custom"></span>
                    <div class="gatilho-info">
                      <div class="gatilho-badge info">‚ÑπÔ∏è INFORMATIVO</div>
                      <strong>Alertas Informativos</strong>
                      <p>Atualiza√ß√µes de dados, novos relat√≥rios publicados, tend√™ncias positivas</p>
                    </div>
                  </label>
                </div>
              </div>

              <div class="alert alert-warning">
                <strong>‚ö†Ô∏è Recomendado:</strong> Mantenha pelo menos os alertas CR√çTICOS ativados para n√£o perder informa√ß√µes importantes.
              </div>
            </section>

            <section class="modal-section">
              <h3 class="section-title">üëÄ Preview da Notifica√ß√£o</h3>
              <div class="slack-preview">
                <div class="slack-message">
                  <div class="slack-message-header">
                    <img src="https://via.placeholder.com/24" alt="Bot" class="slack-bot-avatar" />
                    <strong>Evolvere Bot</strong>
                    <span class="slack-time">Agora</span>
                  </div>
                  <div class="slack-message-body">
                    <div class="slack-alert-badge error">üö® ALERTA CR√çTICO</div>
                    <p><strong>Taxa Selic aumentou 1.5%</strong></p>
                    <p>De 10.75% para 12.25% ‚Ä¢ Impacto: Alto custo de cr√©dito</p>
                    <div class="slack-message-footer">
                      Canal: <strong>#economia</strong> ‚Ä¢ 22 Nov 2025 √†s 14:35
                    </div>
                  </div>
                </div>
              </div>
            </section>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="fecharModalSlack()">
              Cancelar
            </button>
            <button type="button" class="btn-primary" onclick="salvarConfiguracaoSlack()">
              üíæ Salvar Configura√ß√£o
            </button>
          </div>
        </div>
      </div>

    <footer class="site-footer">
      <div class="container footer-inner">
        <p>&copy; 2025 Evolvere Invest ‚Äî Prot√≥tipo educativo</p>
        <p>Contato: equipe@evolvereinvest.net</p>
      </div>
    </footer>
  </body>
</html>

<script>
let usuarioLogado = JSON.parse(sessionStorage.getItem('USUARIO_LOGADO')); 

if (!usuarioLogado || !usuarioLogado.idUsuario) {
  alert('‚ö†Ô∏è Sess√£o expirada! Fa√ßa login novamente.');
  window.location.href = 'login.html';
}

document.addEventListener('DOMContentLoaded', function() {
  carregarDadosUsuario();

  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');

  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      const targetTab = button.getAttribute('data-tab');
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));
      button.classList.add('active');
      document.getElementById(`tab-${targetTab}`).classList.add('active');
    });
  })

  const profileForm = document.querySelector('#tab-profile form');
  if (profileForm) {
    profileForm.addEventListener('submit', function(e) {
      e.preventDefault();
      atualizarPerfil();
    });
  }

  const securityForm = document.querySelector('#tab-security form');
  const newPasswordInput = document.getElementById('security-new-password');

  if (newPasswordInput) {
    newPasswordInput.addEventListener('input', function() {
      validatePassword(this.value);
    });
  }

  if (securityForm) {
    securityForm.addEventListener('submit', function(e) {
      e.preventDefault();
      alterarSenha();
    });
  }

  const preferencesForm = document.querySelector('#tab-preferences form');
  if (preferencesForm) {
    preferencesForm.addEventListener('submit', function(e) {
      e.preventDefault();
      salvarPreferencias();
    });
  }
})

function logout() {
        if (confirm("‚ö†Ô∏è Tem certeza que deseja sair?")) {
          sessionStorage.removeItem("USUARIO_LOGADO");
          window.location.href = "../index.html";
        }
      }

async function carregarDadosUsuario() {
  try {
    const response = await fetch(`http://localhost:3333/usuarios/obterDados/${usuarioLogado.idUsuario}`);
    
    if (!response.ok) {
      console.error('Erro ao carregar dados do usu√°rio');
      return;
    }

    const dados = await response.json();
    console.log('‚úÖ Dados carregados:', dados);

    document.getElementById('profile-name').value = dados.nome || '';
    document.getElementById('profile-email').value = dados.email || '';
    document.getElementById('profile-company').value = dados.nomeFantasia || '';
    document.getElementById('profile-cnpj').value = formatarCNPJ(dados.cnpj) || '';
    document.getElementById('profile-phone').value = dados.telefone || '';
    

    const iniciais = dados.nome ? dados.nome.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : 'SC';
    document.querySelector('.profile-avatar-hero').textContent = iniciais;
    document.querySelector('.profile-hero-info h1').textContent = dados.nomeFantasia || 'Empresa';
    document.querySelector('.profile-email').textContent = dados.email || '';

  } catch (erro) {
    console.error('‚ùå Erro ao carregar dados:', erro);
  }
}

async function atualizarPerfil() {
  const nome = document.getElementById('profile-name').value.trim();
  const telefone = document.getElementById('profile-phone').value.replace(/\D/g, '');

  if (!nome) {
    alert('‚ö†Ô∏è Preencha o nome!');
    return;
  }

  try {
    const response = await fetch('http://localhost:3333/usuarios/atualizarPerfil', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        idUsuarioServer: usuarioLogado.idUsuario,
        nomeServer: nome,
        telefoneServer: telefone
      })
    });

    if (!response.ok) {
      throw new Error('Erro ao atualizar perfil');
    }

    const data = await response.json();
    alert('‚úÖ ' + data.mensagem);
    carregarDadosUsuario();

  } catch (erro) {
    console.error('‚ùå Erro:', erro);
    alert('‚ùå Erro ao atualizar perfil');
  }
}

async function salvarPreferencias() {
  const receberNotificacao = document.querySelector('#tab-preferences .toggle-item:nth-child(1) input[type="checkbox"]').checked;

  try {
    const response = await fetch('http://localhost:3333/usuarios/atualizarPreferencias', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        idUsuarioServer: usuarioLogado.idUsuario,
        receberNotificacaoServer: receberNotificacao
      })
    });

    if (!response.ok) {
      throw new Error('Erro ao salvar prefer√™ncias');
    }

    const data = await response.json();
    alert('‚úÖ ' + data.mensagem);

  } catch (erro) {
    console.error('‚ùå Erro:', erro);
    alert('‚ùå Erro ao salvar prefer√™ncias');
  }
}

async function alterarSenha() {
  const senhaAtual = document.getElementById('security-current-password').value;
  const novaSenha = document.getElementById('security-new-password').value;
  const confirmarSenha = document.getElementById('security-confirm-password').value;

  if (!senhaAtual || !novaSenha || !confirmarSenha) {
    alert('‚ö†Ô∏è Preencha todos os campos!');
    return;
  }

  if (novaSenha.length < 8) {
    alert('‚ö†Ô∏è A nova senha deve ter no m√≠nimo 8 caracteres!');
    return;
  }

  if (novaSenha !== confirmarSenha) {
    alert('‚ö†Ô∏è As senhas n√£o coincidem!');
    return;
  }

  if (!isPasswordValid(novaSenha)) {
    alert('‚ö†Ô∏è A senha n√£o atende todos os requisitos de seguran√ßa!');
    return;
  }

  try {
    const response = await fetch('http://localhost:3333/usuarios/alterarSenha', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        idUsuarioServer: usuarioLogado.idUsuario,
        senhaAtualServer: senhaAtual,
        novaSenhaServer: novaSenha
      })
    });

    const data = await response.json();

    if (!response.ok) {
      alert('‚ùå ' + (data.erro || 'Erro ao alterar senha'));
      return;
    }

    if (confirm('‚úÖ Senha alterada com sucesso!\n\nVoc√™ ser√° desconectado. Fa√ßa login novamente.')) {
      sessionStorage.clear();
      window.location.href = 'login.html';
    }

  } catch (erro) {
    console.error('‚ùå Erro:', erro);
    alert('‚ùå Erro ao alterar senha');
  }
}

async function salvarPreferencias() {
  const notificacoes = document.querySelector('#tab-preferences input[type="checkbox"]').checked;

  try {
    const response = await fetch('http://localhost:3333/usuarios/atualizarPreferencias', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        idUsuarioServer: usuarioLogado.idUsuario,
        notificacoesServer: notificacoes
      })
    });

    if (!response.ok) {
      throw new Error('Erro ao salvar prefer√™ncias');
    }

    const data = await response.json();
    alert('‚úÖ ' + data.mensagem);

  } catch (erro) {
    console.error('‚ùå Erro:', erro);
    alert('‚ùå Erro ao salvar prefer√™ncias');
  }
}


function validatePassword(password) {
  const requirements = {
    length: password.length >= 8,
    uppercase: /[A-Z]/.test(password),
    lowercase: /[a-z]/.test(password),
    number: /[0-9]/.test(password),
    special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
  };

  updateRequirement('req-length', requirements.length);
  updateRequirement('req-uppercase', requirements.uppercase);
  updateRequirement('req-lowercase', requirements.lowercase);
  updateRequirement('req-number', requirements.number);
  updateRequirement('req-special', requirements.special);
}

function updateRequirement(id, isValid) {
  const element = document.getElementById(id);
  if (element) {
    if (isValid) {
      element.classList.add('valid');
    } else {
      element.classList.remove('valid');
    }
  }
}

function isPasswordValid(password) {
  return password.length >= 8 &&
         /[A-Z]/.test(password) &&
         /[a-z]/.test(password) &&
         /[0-9]/.test(password) &&
         /[!@#$%^&*(),.?":{}|<>]/.test(password);
}

function togglePassword(inputId) {
  const input = document.getElementById(inputId);
  const button = input.nextElementSibling;
  const iconEye = button.querySelector('.icon-eye');
  const iconEyeOff = button.querySelector('.icon-eye-off');

  if (input.type === 'password') {
    input.type = 'text';
    iconEye.style.display = 'none';
    iconEyeOff.style.display = 'block';
  } else {
    input.type = 'password';
    iconEye.style.display = 'block';
    iconEyeOff.style.display = 'none';
  }
}

function formatarCNPJ(cnpj) {
  if (!cnpj) return '';
  cnpj = cnpj.replace(/\D/g, '');
  return cnpj.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
}

let configSlackAtual = null;

async function abrirModalSlack() {
  await carregarConfiguracaoSlack();
  document.getElementById('modalSlack').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function fecharModalSlack() {
  document.getElementById('modalSlack').classList.remove('active');
  document.body.style.overflow = '';
}

async function carregarConfiguracaoSlack() {
  try {
    const response = await fetch(`http://localhost:3333/usuarios/slack/${usuarioLogado.idUsuario}`);
    
    if (response.status === 204 || !response.ok) {
      configSlackAtual = null;
      resetarFormSlack();
      return;
    }

    const config = await response.json();
    configSlackAtual = config;
    
    console.log('‚úÖ Configura√ß√£o Slack carregada:', config);


    const slackAtivo = config.fkSlack !== null;
    document.getElementById('slackMasterToggle').checked = slackAtivo;
    
    if (slackAtivo && config.slack) {
      document.getElementById('canalPopulacao').checked = config.slack.maiorPopulacao === 1;
      document.getElementById('canalSelic').checked = config.slack.aumentoSelic === 1;
      document.getElementById('canalPib').checked = config.slack.crescimentoPib === 1;
      
      document.getElementById('gatilhoError').checked = config.slack.alertaError === 1;
      document.getElementById('gatilhoWarning').checked = config.slack.alertaWarning === 1;
      document.getElementById('gatilhoInfo').checked = config.slack.alertaInfo === 1;
    }

    toggleSlackMaster();
    
  } catch (erro) {
    console.error('‚ùå Erro ao carregar configura√ß√£o Slack:', erro);
    resetarFormSlack();
  }
}

function resetarFormSlack() {
  document.getElementById('slackMasterToggle').checked = false;
  document.getElementById('canalPopulacao').checked = false;
  document.getElementById('canalSelic').checked = false;
  document.getElementById('canalPib').checked = false;
  document.getElementById('gatilhoError').checked = true;
  document.getElementById('gatilhoWarning').checked = true;
  document.getElementById('gatilhoInfo').checked = false;
  toggleSlackMaster();
}

function toggleSlackMaster() {
  const isActive = document.getElementById('slackMasterToggle').checked;
  const statusText = document.getElementById('slackStatusText');
  const canaisSection = document.getElementById('slackCanaisSection');
  const gatilhosSection = document.getElementById('slackGatilhosSection');

  if (isActive) {
    statusText.textContent = '‚úÖ Notifica√ß√µes Slack ATIVADAS - Configure os canais e gatilhos abaixo';
    statusText.style.color = 'var(--accent)';
    statusText.style.fontWeight = '600';
    canaisSection.classList.remove('disabled');
    gatilhosSection.classList.remove('disabled');
    

    document.querySelectorAll('.canal-toggle').forEach(cb => cb.disabled = false);
    document.querySelectorAll('.gatilho-toggle').forEach(cb => cb.disabled = false);
    
  } else {
    statusText.textContent = 'Ative para receber notifica√ß√µes automatizadas sobre mudan√ßas nos indicadores econ√¥micos';
    statusText.style.color = 'var(--text-secondary)';
    statusText.style.fontWeight = 'normal';
    canaisSection.classList.add('disabled');
    gatilhosSection.classList.add('disabled');
    

    document.querySelectorAll('.canal-toggle').forEach(cb => cb.disabled = true);
    document.querySelectorAll('.gatilho-toggle').forEach(cb => cb.disabled = true);
  }
}

function validarCanais() {
  const populacao = document.getElementById('canalPopulacao').checked;
  const selic = document.getElementById('canalSelic').checked;
  const pib = document.getElementById('canalPib').checked;
  
  const algumCanalAtivo = populacao || selic || pib;
  const slackToggle = document.getElementById('slackMasterToggle');

  if (!algumCanalAtivo && slackToggle.checked) {
    slackToggle.checked = false;
    toggleSlackMaster();
    alert('‚ö†Ô∏è Nenhum canal selecionado. O Slack foi desativado automaticamente.');
  }

  if (algumCanalAtivo && !slackToggle.checked) {
    slackToggle.checked = true;
    toggleSlackMaster();
  }
}

async function salvarConfiguracaoSlack() {
  const slackAtivo = document.getElementById('slackMasterToggle').checked;

  console.log('üîç Slack Ativo?', slackAtivo);

  if (!slackAtivo) {
    if (confirm('‚ö†Ô∏è Tem certeza que deseja DESATIVAR as notifica√ß√µes do Slack?')) {
      await desativarSlack();
    }
    return;
  }

  const populacao = document.getElementById('canalPopulacao').checked;
  const selic = document.getElementById('canalSelic').checked;
  const pib = document.getElementById('canalPib').checked;

  console.log('üì¢ Canais selecionados:', { populacao, selic, pib });

  if (!populacao && !selic && !pib) {
    alert('‚ö†Ô∏è Selecione pelo menos um canal para receber notifica√ß√µes!');
    return;
  }

  const error = document.getElementById('gatilhoError').checked;
  const warning = document.getElementById('gatilhoWarning').checked;
  const info = document.getElementById('gatilhoInfo').checked;

  console.log('üîî Gatilhos selecionados:', { error, warning, info });

  if (!error && !warning && !info) {
    alert('‚ö†Ô∏è Selecione pelo menos um tipo de gatilho!');
    return;
  }

  const configuracao = {
    idUsuarioServer: usuarioLogado.idUsuario,
    maiorPopulacaoServer: populacao ? 1 : 0,
    aumentoSelicServer: selic ? 1 : 0,
    crescimentoPibServer: pib ? 1 : 0,
    alertaErrorServer: error ? 1 : 0,
    alertaWarningServer: warning ? 1 : 0,
    alertaInfoServer: info ? 1 : 0
  };

  console.log('üì§ Configura√ß√£o a ser enviada:', configuracao);
  console.log('üì§ JSON.stringify:', JSON.stringify(configuracao));

  try {
    const url = configSlackAtual && configSlackAtual.fkSlack
      ? `http://localhost:3333/usuarios/slack/atualizar/${configSlackAtual.fkSlack}`
      : 'http://localhost:3333/usuarios/slack/criar';

    console.log('üåê URL da requisi√ß√£o:', url);
    console.log('üîß M√©todo:', configSlackAtual && configSlackAtual.fkSlack ? 'PUT' : 'POST');

    const response = await fetch(url, {
      method: configSlackAtual && configSlackAtual.fkSlack ? 'PUT' : 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(configuracao)
    });

    console.log('üì• Response status:', response.status);
    console.log('üì• Response ok?', response.ok);

    if (!response.ok) {
      const errorText = await response.text();
      console.error('‚ùå Erro na resposta:', errorText);
      throw new Error('Erro ao salvar configura√ß√£o');
    }

    const data = await response.json();
    console.log('‚úÖ Resposta do servidor:', data);

    alert('‚úÖ Configura√ß√µes do Slack salvas com sucesso!');
    fecharModalSlack();
    
  } catch (erro) {
    console.error('‚ùå Erro ao salvar:', erro);
    alert('‚ùå Erro ao salvar configura√ß√µes. Verifique o console.');
  }
}
async function desativarSlack() {
  try {
    const response = await fetch(`http://localhost:3333/usuarios/slack/desativar/${usuarioLogado.idUsuario}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' }
    });

    if (!response.ok) {
      throw new Error('Erro ao desativar Slack');
    }

    console.log('‚úÖ Slack desativado');
    alert('‚úÖ Notifica√ß√µes do Slack desativadas!');
    fecharModalSlack();
    
  } catch (erro) {
    console.error('‚ùå Erro ao desativar:', erro);
    alert('‚ùå Erro ao desativar. Tente novamente.');
  }
}


document.getElementById('modalSlack')?.addEventListener('click', function(e) {
  if (e.target === this) fecharModalSlack();
});


document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && document.getElementById('modalSlack')?.classList.contains('active')) {
    fecharModalSlack();
  }
});
</script>
